"use strict";(globalThis.webpackChunk_newfold_labs_wp_module_help_center=globalThis.webpackChunk_newfold_labs_wp_module_help_center||[]).push([[770],{1770:(e,t,n)=>{n.d(t,{default:()=>we});var s=n(8394),a=n(2975);const o=(e,t="")=>{if(e.includes("rest_route="))return e;const n=e.match(/\/wp-json\/(.+)$/);if(!n)return e;const s=n[1];t||"undefined"==typeof window||(t=window.location.origin);const a=t.replace(/\/wp-json\/?$/,""),o=a.includes("?")?"&":"?";return`${a}${o}rest_route=/${s}`};class r extends Error{constructor(e,t=null,n=null){super(e),this.name="MCPError",this.code=t,this.details=n}}new class{constructor(e={}){this.configKey=e.configKey||"nfdAIChat",this.client=null,this.transport=null,this.connected=!1,this.tools=[],this.resources=[],this.eventListeners=new Map}getConfig(){const e="undefined"!=typeof window&&window[this.configKey]||{},t=e.homeUrl||("undefined"!=typeof window?window.location.origin:"");let n=e.restUrl||"/wp-json/";n.includes("/wp-json/")?n=o(n,t):n.includes("rest_route=")||(n=o("/wp-json/",t));let s=e.mcpUrl;return s?s.includes("/wp-json/")&&(s=o(s,t)):s=((e,t,n="")=>{const s=((e="")=>{if(e&&e.includes("rest_route="))return e;e||"undefined"==typeof window||(e=window.location.origin);const t=e.includes("?")?"&":"?";return`${e}${t}rest_route=/`})(n),a=`${e}/${t}`;if(s.includes("rest_route="))return s.replace("rest_route=/",`rest_route=/${a}`);const o=s.includes("?")?"&":"?";return`${s}${o}rest_route=/${a}`})("mcp","mcp-adapter-default-server",t),{nonce:e.nonce||"",restUrl:n,mcpUrl:s,homeUrl:t}}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(t)}off(e,t){const n=this.eventListeners.get(e);n&&n.delete(t)}emit(e){const t=this.eventListeners.get(e.type);t&&t.forEach(t=>{try{t(e)}catch(e){console.error("Error in MCP event listener:",e)}})}async connect(e=null){try{const t=this.getConfig(),n=e||t.mcpUrl;if(!n)throw new r("MCP endpoint URL not configured");this.client=new s.K({name:"nfd-ai-chat-client",version:"1.0.0"},{capabilities:{}}),this.transport=new a.j(new URL(n),{requestInit:{headers:{"Content-Type":"application/json"}}}),await this.client.connect(this.transport),this.connected=!0,this.emit({type:"connected"})}catch(e){const t=e instanceof r?e:new r(`Connection failed: ${e.message}`);throw this.emit({type:"error",data:t}),t}}async initialize(){if(!this.connected)throw new r("Not connected to MCP server");try{await Promise.all([this.loadTools(),this.loadResources()]);const e={protocolVersion:"2025-06-18",capabilities:{tools:{},resources:{},prompts:{}},serverInfo:{name:"WordPress MCP Server",version:"1.0.0"}};return this.emit({type:"initialized",data:e}),e}catch(e){const t=e instanceof r?e:new r(`Initialization failed: ${e.message}`);throw this.emit({type:"error",data:t}),t}}normalizeInputSchema(e){return!e||Array.isArray(e)||"object"!=typeof e||0===Object.keys(e).length?{type:"object",properties:{},required:[]}:{type:e.type||"object",properties:e.properties||{},required:Array.isArray(e.required)?e.required:[]}}async loadTools(){try{const e=await this.client.listTools();this.tools=e.tools.map(e=>({name:e.name,description:e.description||"",inputSchema:this.normalizeInputSchema(e.inputSchema),annotations:e.annotations||{}})),this.emit({type:"tools_updated",data:this.tools})}catch(e){console.error("Failed to load tools via SDK:",e),this.tools=[]}}async loadResources(){try{const e=await this.client.listResources();this.resources=e.resources.map(e=>({uri:e.uri,name:e.name||"",description:e.description,mimeType:e.mimeType})),this.emit({type:"resources_updated",data:this.resources})}catch(e){console.error("Failed to load resources via SDK:",e),this.resources=[]}}async listTools(){if(!this.connected)throw new r("Not connected to MCP server");return this.tools}async callTool(e,t={}){if(!this.connected)throw new r("Not connected to MCP server");try{const n=await this.client.callTool({name:e,arguments:t});return{content:Array.isArray(n.content)?n.content:[],isError:Boolean(n.isError),meta:n.meta||{}}}catch(t){console.error(`Tool "${e}" call failed:`,t);const n=t instanceof r?t:new r(`Tool call failed: ${t.message}`);throw this.emit({type:"error",data:n}),n}}async listResources(){if(!this.connected)throw new r("Not connected to MCP server");return this.resources}async readResource(e){if(!this.connected)throw new r("Not connected to MCP server");try{return await this.client.readResource({uri:e})}catch(t){console.error(`Resource "${e}" read failed:`,t);const n=t instanceof r?t:new r(`Resource read failed: ${t.message}`);throw this.emit({type:"error",data:n}),n}}async disconnect(){try{this.transport&&(await this.client.close(),this.transport=null),this.connected=!1,this.tools=[],this.resources=[],this.emit({type:"disconnected"})}catch(e){console.error("Error during SDK disconnect:",e)}}isConnected(){return this.connected}getTools(){return[...this.tools]}getResources(){return[...this.resources]}isToolReadOnly(e){const t=this.tools.find(t=>t.name===e);return!t||!0===t.annotations?.readonly||!0===t.annotations?.readOnlyHint}getToolsForOpenAI(){return this.tools.map(e=>{const t=this.normalizeInputSchema(e.inputSchema);return{type:"function",function:{name:e.name,description:e.description||"",parameters:t}}})}};var i=n(3556);const c="gpt-4o-mini";class l extends Error{constructor(e,t=null,n=null){super(e),this.name="OpenAIError",this.status=t,this.code=n}}new class{constructor(e={}){this.configKey=e.configKey||"nfdAIChat",this.apiPath=e.apiPath||"ai",this.mode=e.mode||"help",this.openai=null,this.config=null}getConfig(){if(this.config)return this.config;if("undefined"!=typeof window&&window[this.configKey]){const e=window[this.configKey].homeUrl||window.location.origin;let t=window[this.configKey].restUrl||"/wp-json/";t.includes("/wp-json/")?t=o(t,e):t.includes("rest_route=")||(t=o("/wp-json/",e)),this.config={nonce:window[this.configKey].nonce,restUrl:t,homeUrl:e}}else this.config={nonce:"",restUrl:"",homeUrl:""};return this.config}getOpenAIClient(){if(this.openai)return this.openai;const e=this.getConfig();return this.openai=new i.Ay({apiKey:"proxy",baseURL:`${e.restUrl}${this.apiPath}`,dangerouslyAllowBrowser:!0,defaultHeaders:{"X-WP-Nonce":e.nonce}}),this.openai}async createChatCompletion(e){try{const t=this.getOpenAIClient();return await t.chat.completions.create({model:e.model||c,messages:e.messages,tools:e.tools,tool_choice:e.tool_choice,stream:!1,max_tokens:e.max_tokens,temperature:e.temperature,mode:e.mode||this.mode})}catch(e){throw new l(e.message||"OpenAI API request failed",e.status,e.code)}}async createStreamingCompletion(e,t,n,s){try{const s=this.getOpenAIClient(),a=await s.chat.completions.create({...e,messages:e.messages,stream:!0,mode:e.mode||this.mode});let o="";const r={};for await(const e of a){const s=e.choices[0]?.delta;if(s?.content&&(o+=s.content,t({type:"content",content:s.content})),s?.tool_calls){for(const e of s.tool_calls){const t=e.index;r[t]||(r[t]={id:e.id||"",type:"function",function:{name:e.function?.name||"",arguments:""}}),e.id&&(r[t].id=e.id),e.function?.name&&(r[t].function.name=e.function.name),e.function?.arguments&&(r[t].function.arguments+=e.function.arguments)}t({type:"tool_calls",tool_calls:Object.values(r)})}if(e.choices[0]?.finish_reason){const e=Object.values(r).map(e=>({id:e.id,name:e.function.name,arguments:e.function.arguments?JSON.parse(e.function.arguments):{}}));await n(o,e.length>0?e:null);break}}}catch(e){s(new l(e.message||"Streaming request failed",e.status,e.code))}}convertMessagesToOpenAI(e){const t=[];for(const o of e){var n;if("system"===o.role||"user"===o.role)t.push({role:o.role,content:null!==(n=o.content)&&void 0!==n?n:""});else if("assistant"===o.role){var s,a;const e=o.toolCalls&&o.toolCalls.length>0;if((null===o.content||void 0===o.content||""===o.content)&&!e){console.warn("Skipping invalid assistant message with no content and no tool calls");continue}const n={role:"assistant",content:e?null!==(s=o.content)&&void 0!==s?s:null:null!==(a=o.content)&&void 0!==a?a:""};if(e&&(n.tool_calls=o.toolCalls.map(e=>({id:e.id,type:"function",function:{name:e.name,arguments:"string"==typeof e.arguments?e.arguments:JSON.stringify(e.arguments)}}))),t.push(n),e&&o.toolResults&&o.toolResults.length>0)for(const e of o.toolResults)o.toolCalls.some(t=>t.id===e.id)&&t.push({role:"tool",content:e.error||JSON.stringify(e.result),tool_call_id:e.id})}}return t}convertMCPToolsToOpenAI(e){return e.map(e=>({type:"function",function:{name:e.name,description:e.description,parameters:e.inputSchema}}))}processToolCalls(e){return e.map(e=>({id:e.id,name:e.function.name,arguments:JSON.parse(e.function.arguments||"{}")}))}async sendMessage(e,t=[],n=[]){const s=this.convertMessagesToOpenAI([...t,{id:`user-${Date.now()}`,role:"user",content:e,timestamp:new Date}]),a={model:c,messages:s,tools:n.length>0?this.convertMCPToolsToOpenAI(n):void 0,tool_choice:n.length>0?"auto":void 0,temperature:.7,max_tokens:2e3};try{const e=(await this.createChatCompletion(a)).choices[0];if(!e)throw new l("No response from OpenAI");const t={message:e.message.content||""};return e.message.tool_calls&&(t.toolCalls=this.processToolCalls(e.message.tool_calls)),t}catch(e){if(e instanceof l)throw e;throw new l(`Failed to send message: ${e}`)}}};var u=n(6087),d=n(7723),h=n(1455),p=n.n(h);const m=e=>({history:`nfd-ai-chat-${e}-history`,conversationId:`nfd-ai-chat-${e}-conversation-id`,sessionId:`nfd-ai-chat-${e}-session-id`,archive:`nfd-ai-chat-${e}-archive`}),g="processing",f="connecting",_="ws_connecting",y="tool_call",w="working",v="received",x="generating",b="summarizing",S="completed",C="failed";function I(e){var t;return null!==(t={typing_start:g,handoff_request:f,handoff_accept:f,tool_call:y,tool_result:w,typing_stop:null}[e])&&void 0!==t?t:null}const j=e=>{if(!e||"string"!=typeof e)return!1;const t=e.toLowerCase().trim(),n=[/^hello!?\s+how\s+can\s+i\s+assist\s+you/i,/^hi!?\s+how\s+can\s+i\s+help/i,/^hello!?\s+how\s+can\s+i\s+help/i,/^hi\s+there!?\s+how\s+can/i,/^greetings!?\s+how\s+can/i,/^how\s+can\s+i\s+assist\s+you\s+today/i,/^how\s+can\s+i\s+help\s+you\s+today/i,/^hello!?\s+how\s+can\s+i\s+assist\s+you\s+today/i,/^hello!?\s+how\s+can\s+i\s+assist\s+you.*feel\s+free/i].some(e=>e.test(t)),s=t.includes("hello")&&(t.includes("assist")||t.includes("help"))&&(t.includes("today")||t.includes("feel free")||t.includes("ask")),a=t.length<150&&(t.includes("hello")&&(t.includes("assist")||t.includes("help"))||t.includes("hi")&&t.includes("help"));return n||s||a};function N(e){return e&&"string"==typeof e?e.replace(/(https?:\/\/[^\s<>"]*(?:\n[^\s<>"]*)*)/g,e=>{let t=e.replace(/\s+/g,"").trim().replace(/[.,;:!?)\]]+$/,"");const n=t.match(/\/(If|It|To|We|So|Or|In|On|At|By|Do|Be|As|An|The|You)$/i),s=n?n[1]:"";return s&&(t=t.replace(/\/(If|It|To|We|So|Or|In|On|At|By|Do|Be|As|An|The|You)$/i,"")),t?`<a href="${t.replace(/"/g,"&quot;")}" target="_blank" rel="noopener noreferrer">${t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}</a>${s?" "+s:""}`:e}):""}var A=n(325);const T=e=>A.A.sanitize(e,{ALLOWED_TAGS:["section","div","h1","h2","h3","h4","h5","h6","p","span","strong","em","b","i","u","s","mark","small","sub","sup","a","br","ul","ol","li","dl","dt","dd","blockquote","code","pre","table","thead","tbody","tr","th","td","hr","address","time"],ALLOWED_ATTR:["style","class","id","href","datetime","target","rel"],ALLOW_DATA_ATTR:!1,FORBID_TAGS:["script","object","embed","iframe","form","fieldset","legend","label","input","textarea","select","option","button","details","summary","progress","meter"],FORBID_ATTR:["onerror","onload","onclick","onmouseover","onfocus","onblur"]});var $=n(5243),k=n(7640),R=n(3152),E=n(4648),D=n(435),O=n.n(D),M=n(790);const L=e=>({"blu/get-global-styles":{title:(0,d.__)("Reading Site Colors","wp-module-ai-chat")},"blu-get-global-styles":{title:(0,d.__)("Reading Site Colors","wp-module-ai-chat")},"blu/get-active-global-styles":{title:(0,d.__)("Reading Active Styles","wp-module-ai-chat")},"blu-get-active-global-styles":{title:(0,d.__)("Reading Active Styles","wp-module-ai-chat")},"blu/get-active-global-styles-id":{title:(0,d.__)("Getting Styles ID","wp-module-ai-chat")},"blu-get-active-global-styles-id":{title:(0,d.__)("Getting Styles ID","wp-module-ai-chat")},"blu/update-global-styles":{title:(0,d.__)("Updating Site Styles","wp-module-ai-chat")},"blu-update-global-styles":{title:(0,d.__)("Updating Site Styles","wp-module-ai-chat")},"blu/update-global-palette":{title:(0,d.__)("Updating Site Colors","wp-module-ai-chat")},"blu-update-global-palette":{title:(0,d.__)("Updating Site Colors","wp-module-ai-chat")}}[e]||{title:e?.replace(/[-_\/]/g," ").replace(/\b\w/g,e=>e.toUpperCase())||(0,d.__)("Action","wp-module-ai-chat")}),F=({tool:e,isError:t,result:n})=>{const s=((e,t={})=>{if("mcp-adapter-execute-ability"===e){const e=t?.ability_name||"unknown",n=L(e);let s=null;if(("blu/update-global-palette"===e||"blu/update-global-styles"===e)&&t?.parameters?.colors){const e=t.parameters.colors.length;s=`${e} color${1!==e?"s":""}`}return{...n,params:s}}return L(e)})(e.name,e.arguments),a=((e,t)=>{if(!e||e.isError)return n=e?.error,null==n?null:"string"==typeof n?n:"number"==typeof n||"boolean"==typeof n?String(n):null;var n;try{let n=e.result;if(Array.isArray(n)&&n.length>0&&n[0].text?n=JSON.parse(n[0].text):"string"==typeof n&&(n=JSON.parse(n)),!n||"object"!=typeof n)return null;if(t?.includes("update")){if(n.updatedColors&&Array.isArray(n.updatedColors)){const e=n.updatedColors;return e.length<=3?e.map(e=>`${e.name||e.slug}: ${e.color}`).join(", "):`${e.length} colors updated`}if(n.message&&"string"==typeof n.message)return n.message}if(t?.includes("get")||t?.includes("read")){if(n.color?.palette){const e=n.color.palette,t=e.custom?.length||0,s=e.theme?.length||0;if(t||s)return`Found ${t+s} colors`}if(n.typography){const e=n.typography.fontFamilies?.length||0,t=n.typography.fontSizes?.length||0,s=[];if(e&&s.push(`${e} font families`),t&&s.push(`${t} sizes`),s.length)return s.join(", ")}if(n.message&&"string"==typeof n.message)return n.message}return n.id&&t?.includes("id")?`ID: ${n.id}`:null}catch{return null}})(n,e.name);return(0,M.jsxs)("div",{className:O()("nfd-ai-chat-tool-execution__item",{"nfd-ai-chat-tool-execution__item--complete":!t,"nfd-ai-chat-tool-execution__item--error":t}),children:[(0,M.jsxs)("div",{className:"nfd-ai-chat-tool-execution__item-header",children:[t?(0,M.jsx)($.A,{className:"nfd-ai-chat-tool-execution__icon nfd-ai-chat-tool-execution__icon--error",size:12}):(0,M.jsx)(k.A,{className:"nfd-ai-chat-tool-execution__icon nfd-ai-chat-tool-execution__icon--success",size:12}),(0,M.jsx)("span",{className:"nfd-ai-chat-tool-execution__item-title",children:s.title}),s.params&&(0,M.jsx)("span",{className:"nfd-ai-chat-tool-execution__item-params",children:s.params})]}),a&&(0,M.jsx)("div",{className:"nfd-ai-chat-tool-execution__item-summary",children:a})]})},q=({executedTools:e=[],toolResults:t=[]})=>{const[n,s]=(0,u.useState)(!1);if(!e||0===e.length)return null;const a=new Map;t&&Array.isArray(t)&&t.forEach(e=>{e.id&&a.set(e.id,e)});const o=e.some(e=>e.isError),r=e.length;return(0,M.jsxs)("div",{className:O()("nfd-ai-chat-tool-execution",{"nfd-ai-chat-tool-execution--collapsed":!n}),children:[(0,M.jsxs)("button",{type:"button",className:"nfd-ai-chat-tool-execution__header",onClick:()=>s(!n),"aria-expanded":n?"true":"false",children:[n?(0,M.jsx)(R.A,{className:"nfd-ai-chat-tool-execution__chevron",size:12}):(0,M.jsx)(E.A,{className:"nfd-ai-chat-tool-execution__chevron",size:12}),(0,M.jsx)("span",{children:o?(0,d.__)("Some actions failed","wp-module-ai-chat"):(0,d.__)("Actions completed","wp-module-ai-chat")}),(0,M.jsxs)("span",{className:"nfd-ai-chat-tool-execution__header-count",children:["(",r,")"]})]}),n&&(0,M.jsx)("div",{className:"nfd-ai-chat-tool-execution__list",children:e.map((e,t)=>(0,M.jsx)(F,{tool:e,isError:e.isError,result:a.get(e.id)},e.id||`tool-${t}`))})]})},U=({message:e,type:t="assistant",animateTyping:n=!1,onContentGrow:s,executedTools:a=[],onExecuteTool:o,onSendMessage:r,onSendSystemMessage:i,conversationId:c,onClearTyping:l,brandId:d,toolResults:h=[]})=>{const p="approval_request"===t?"assistant":t,m="user"===p,g=(e||"").length,[f,_]=(0,u.useState)(()=>n?0:g);(0,u.useEffect)(()=>{if(!n)return void _(g);const e=setInterval(()=>{_(e=>e>=g?e:Math.min(e+2,g))},35);return()=>clearInterval(e)},[n,g]);const y=(0,u.useRef)(0);(0,u.useEffect)(()=>{if(!s||!n||0===f)return;const e=Date.now();e-y.current<80||(y.current=e,s())},[f,n,s]);const w=n?(e||"").slice(0,f):e||"",{content:v,isRichContent:x}=(0,u.useMemo)(()=>{if(!w)return{content:"",isRichContent:!1};const e=(t=w)&&"string"==typeof t?t.replace(/\\"/g,'"').replace(/\\'/g,"'"):t;var t;if(m)return{content:e,isRichContent:!1};if((e=>/<[a-z][\s\S]*>/i.test(e))(e))return{content:T(e),isRichContent:!0};if(function(e){return!(!e||"string"!=typeof e)&&[/^#{1,6}\s/m,/\*\*[^*]+\*\*/,/\*[^*]+\*/,/__[^_]+__/,/_[^_]+_/,/`[^`]+`/,/```[\s\S]*?```/,/^\s*[-*+]\s/m,/^\s*\d+\.\s/m,/\[([^\]]+)\]\(([^)]+)\)/].some(t=>t.test(e))}(e)){const t=function(e){if(!e||"string"!=typeof e)return"";let t=e;t=t.replace(/&(?![\w#]+;)/g,"&amp;").replace(/<(?![a-zA-Z/])/g,"&lt;").replace(/(?<![a-zA-Z"])>/g,"&gt;"),t=t.replace(/```(\w*)\n?([\s\S]*?)```/g,(e,t,n)=>`<pre><code class="language-${t||"plaintext"}">${n.trim().replace(/</g,"&lt;").replace(/>/g,"&gt;")}</code></pre>`),t=t.replace(/`([^`]+)`/g,'<code class="inline-code">$1</code>'),t=t.replace(/^######\s+(.+)$/gm,'<h6 class="chat-h6">$1</h6>'),t=t.replace(/^#####\s+(.+)$/gm,'<h5 class="chat-h5">$1</h5>'),t=t.replace(/^####\s+(.+)$/gm,'<h4 class="chat-h4">$1</h4>'),t=t.replace(/^###\s+(.+)$/gm,'<h3 class="chat-h3">$1</h3>'),t=t.replace(/^##\s+(.+)$/gm,'<h2 class="chat-h2">$1</h2>'),t=t.replace(/^#\s+(.+)$/gm,'<h1 class="chat-h1">$1</h1>'),t=t.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),t=t.replace(/__([^_]+)__/g,"<strong>$1</strong>"),t=t.replace(/(?<![*_])\*(?!\*)([^*\n]+)(?<!\*)\*(?!\*)/g,"<em>$1</em>"),t=t.replace(/(?<![_*])_(?!_)([^_\n]+)(?<!_)_(?!_)/g,"<em>$1</em>"),t=t.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'),t=t.replace(/^(\s*)[-*+]\s+(.+)$/gm,(e,t,n)=>`<li class="chat-li" data-level="${Math.floor(t.length/2)}">${n}</li>`),t=t.replace(/((?:<li[^>]*>.*?<\/li>\s*)+)/g,e=>`<ul class="chat-ul">${e.replace(/(<\/li>)\s+(<li)/g,"$1$2")}</ul>`),t=t.replace(/^(\s*)\d+\.\s+(.+)$/gm,(e,t,n)=>`<oli class="chat-oli" data-level="${Math.floor(t.length/2)}">${n}</oli>`),t=t.replace(/((?:<oli[^>]*>.*?<\/oli>\s*)+)/g,e=>`<ol class="chat-ol">${e.replace(/(<\/oli>)\s+(<oli)/g,"$1$2").replace(/<\/?oli/g,e=>e.replace("oli","li"))}</ol>`),t=t.replace(/^---+$/gm,'<hr class="chat-hr" />'),t=t.replace(/^>\s+(.+)$/gm,'<blockquote class="chat-blockquote">$1</blockquote>');const n=t.split(/\n\n+/);return t=n.map(e=>{const t=e.trim();return t.startsWith("<h")||t.startsWith("<ul")||t.startsWith("<ol")||t.startsWith("<pre")||t.startsWith("<blockquote")||t.startsWith("<hr")||t.startsWith("<p")?t:t?`<p class="chat-p">${t}</p>`:""}).filter(Boolean).join(""),t=t.replace(/<p([^>]*)>([\s\S]*?)<\/p>/g,(e,t,n)=>`<p${t}>${n.trim().replace(/\n/g,"<br>")}</p>`),t=t.replace(/<br\s*\/?>\s*(<\/?(ul|ol|li|p|h[1-6]|pre|blockquote|hr))/gi,"$1"),t=t.replace(/(<\/(ul|ol|li|p|h[1-6]|pre|blockquote)>)\s*<br\s*\/?>/gi,"$1"),t=t.replace(/<p[^>]*>\s*<\/p>/g,""),t=t.replace(/(<br\s*\/?>){2,}/g,"<br>"),t=function(e){return e&&"string"==typeof e?e.replace(/>([^<]*)</g,(e,t)=>">"+N(t)+"<"):""}(t),t}(e);return{content:T(t),isRichContent:!0}}const n=N(e);if(n!==e){const e=n.replace(/\n/g,"<br>");return{content:T(e),isRichContent:!0}}return{content:e,isRichContent:!1}},[w,m]);return v||a&&0!==a.length?(0,M.jsxs)("div",{className:`nfd-ai-chat-message nfd-ai-chat-message--${p}`,children:[v&&(x?(0,M.jsx)("div",{className:"nfd-ai-chat-message__content nfd-ai-chat-message__content--rich",dangerouslySetInnerHTML:{__html:v}}):(0,M.jsx)("div",{className:"nfd-ai-chat-message__content nfd-ai-chat-message__content--pre-wrap",style:{whiteSpace:"pre-wrap"},children:v})),a&&a.length>0&&(0,M.jsx)(q,{executedTools:a,toolResults:h})]}):null},W=({message:e,className:t=""})=>(0,M.jsxs)("div",{className:`nfd-ai-chat-error-alert ${t}`,children:[(0,M.jsx)("div",{className:"nfd-ai-chat-error-alert__icon",children:(0,M.jsx)($.A,{width:16,height:16})}),(0,M.jsx)("div",{className:"nfd-ai-chat-error-alert__content",children:(0,M.jsx)("div",{className:"nfd-ai-chat-error-alert__message",children:e})})]});var P=n(2074),H=n(1045);const z=e=>({"nfd-agents/get-global-styles":{title:(0,d.__)("Reading Site Colors","wp-module-ai-chat"),description:(0,d.__)("Fetching current color palette and typography settings","wp-module-ai-chat")},"nfd-agents/update-global-palette":{title:(0,d.__)("Updating Site Colors","wp-module-ai-chat"),description:(0,d.__)("Applying new colors to global styles","wp-module-ai-chat")},"newfold-agents/get-global-styles":{title:(0,d.__)("Reading Site Colors","wp-module-ai-chat"),description:(0,d.__)("Fetching current color palette and typography settings","wp-module-ai-chat")},"newfold-agents/update-global-palette":{title:(0,d.__)("Updating Site Colors","wp-module-ai-chat"),description:(0,d.__)("Applying new colors to global styles","wp-module-ai-chat")},"blu/get-global-styles":{title:(0,d.__)("Reading Site Colors","wp-module-ai-chat"),description:(0,d.__)("Fetching current color palette and typography settings","wp-module-ai-chat")},"blu/update-global-palette":{title:(0,d.__)("Updating Site Colors","wp-module-ai-chat"),description:(0,d.__)("Applying new colors to global styles","wp-module-ai-chat")},"mcp-adapter-discover-abilities":{title:(0,d.__)("Discovering Actions","wp-module-ai-chat"),description:(0,d.__)("Finding available WordPress abilities","wp-module-ai-chat")},"mcp-adapter-get-ability-info":{title:(0,d.__)("Getting Ability Info","wp-module-ai-chat"),description:(0,d.__)("Fetching ability details","wp-module-ai-chat")},"mcp-adapter-execute-ability":{title:(0,d.__)("Executing Action","wp-module-ai-chat"),description:(0,d.__)("Running WordPress ability","wp-module-ai-chat")}}[e]||{title:e?.replace(/[-_\/]/g," ").replace(/\b\w/g,e=>e.toUpperCase())||(0,d.__)("Executing","wp-module-ai-chat"),description:(0,d.__)("Running action","wp-module-ai-chat")}),J=({tool:e,isActive:t,progress:n,isComplete:s,isError:a})=>{const o=((e,t={})=>{if("mcp-adapter-execute-ability"===e){const e=t?.ability_name||"unknown",n=z(e);let s=null;if(("nfd-agents/update-global-palette"===e||"newfold-agents/update-global-palette"===e||"blu/update-global-palette"===e)&&t?.parameters?.colors){const e=t.parameters.colors.length;s=`${e} color${1!==e?"s":""}`}return{...n,params:s}}return z(e)})(e.name,e.arguments);return(0,M.jsxs)("div",{className:O()("nfd-ai-chat-tool-execution__item",{"nfd-ai-chat-tool-execution__item--active":t,"nfd-ai-chat-tool-execution__item--complete":s,"nfd-ai-chat-tool-execution__item--error":a}),children:[(0,M.jsxs)("div",{className:"nfd-ai-chat-tool-execution__item-header",children:[a?(0,M.jsx)($.A,{className:"nfd-ai-chat-tool-execution__icon nfd-ai-chat-tool-execution__icon--error",size:12}):s?(0,M.jsx)(k.A,{className:"nfd-ai-chat-tool-execution__icon nfd-ai-chat-tool-execution__icon--success",size:12}):t?(0,M.jsx)(P.A,{className:"nfd-ai-chat-tool-execution__icon nfd-ai-chat-tool-execution__icon--active",size:12}):(0,M.jsx)(H.A,{className:"nfd-ai-chat-tool-execution__icon nfd-ai-chat-tool-execution__icon--pending",size:12}),(0,M.jsx)("span",{className:"nfd-ai-chat-tool-execution__item-title",children:o.title}),o.params&&(0,M.jsx)("span",{className:"nfd-ai-chat-tool-execution__item-params",children:o.params})]}),t&&n&&(0,M.jsx)("div",{className:"nfd-ai-chat-tool-execution__item-progress",children:n})]})},B=({status:e=null,activeToolCall:t=null,toolProgress:n=null,executedTools:s=[],pendingTools:a=[]})=>{const[o,r]=(0,u.useState)(!0),i=!!t;(0,u.useEffect)(()=>{r(i)},[i]);const c={[g]:(0,d.__)("Processing…","wp-module-ai-chat"),[f]:(0,d.__)("Getting your site ready…","wp-module-ai-chat"),[_]:(0,d.__)("Connecting…","wp-module-ai-chat"),[y]:(0,d.__)("Looking this up…","wp-module-ai-chat"),[w]:(0,d.__)("Almost there…","wp-module-ai-chat"),[v]:(0,d.__)("Message received","wp-module-ai-chat"),[x]:(0,d.__)("Thinking…","wp-module-ai-chat"),[b]:(0,d.__)("Summarizing results","wp-module-ai-chat"),[S]:(0,d.__)("Processing","wp-module-ai-chat"),[C]:(0,d.__)("Error occurred","wp-module-ai-chat")},l=t||s.length>0||a.length>0,h=s.length+(t?1:0)+a.length;return l?(0,M.jsx)("div",{className:"nfd-ai-chat-message nfd-ai-chat-message--assistant",children:(0,M.jsx)("div",{className:"nfd-ai-chat-message__content",children:(0,M.jsxs)("div",{className:O()("nfd-ai-chat-tool-execution",{"nfd-ai-chat-tool-execution--collapsed":!o}),children:[(0,M.jsxs)("button",{type:"button",className:"nfd-ai-chat-tool-execution__header",onClick:()=>r(!o),"aria-expanded":o?"true":"false",children:[o?(0,M.jsx)(R.A,{className:"nfd-ai-chat-tool-execution__chevron",size:12}):(0,M.jsx)(E.A,{className:"nfd-ai-chat-tool-execution__chevron",size:12}),i?(0,M.jsxs)(M.Fragment,{children:[(0,M.jsx)("span",{children:(0,d.__)("Executing actions","wp-module-ai-chat")}),t.total>1&&(0,M.jsxs)("span",{className:"nfd-ai-chat-tool-execution__header-count",children:["(",t.index,"/",t.total,")"]})]}):(0,M.jsxs)(M.Fragment,{children:[(0,M.jsx)("span",{children:(0,d.__)("Actions completed","wp-module-ai-chat")}),(0,M.jsxs)("span",{className:"nfd-ai-chat-tool-execution__header-count",children:["(",h,")"]})]})]}),o&&(0,M.jsxs)("div",{className:"nfd-ai-chat-tool-execution__list",children:[s.map((e,t)=>(0,M.jsx)(J,{tool:e,isActive:!1,isComplete:!e.isError,isError:e.isError,progress:null},e.id||`executed-${t}`)),t&&(0,M.jsx)(J,{tool:t,isActive:!0,isComplete:!1,isError:!1,progress:n},t.id||"active"),a.map((e,t)=>(0,M.jsx)(J,{tool:e,isActive:!1,isComplete:!1,isError:!1,progress:null},e.id||`pending-${t}`))]})]})})}):(0,M.jsx)("div",{className:"nfd-ai-chat-message nfd-ai-chat-message--assistant",children:(0,M.jsx)("div",{className:"nfd-ai-chat-message__content",children:(0,M.jsxs)("div",{className:"nfd-ai-chat-typing-indicator",children:[(0,M.jsxs)("span",{className:"nfd-ai-chat-typing-indicator__dots","aria-hidden":"true",children:[(0,M.jsx)("span",{}),(0,M.jsx)("span",{}),(0,M.jsx)("span",{})]}),(0,M.jsx)("span",{className:"nfd-ai-chat-typing-indicator__text",children:null!==(p=c[e])&&void 0!==p?p:(0,d.__)("Thinking…","wp-module-ai-chat")})]})})});var p},K=({messages:e=[],isLoading:t=!1,error:n=null,status:s=null,activeToolCall:a=null,toolProgress:o=null,executedTools:r=[],pendingTools:i=[],onApprove:c,onReject:l,onExecuteTool:h,onSendMessage:p,onSendSystemMessage:m,conversationId:g,onClearTyping:f,onRetry:_,connectionFailed:y=!1,brandId:w})=>{const v=(0,u.useRef)(null),[x,b]=(0,u.useState)(0),S=(0,u.useCallback)(()=>{const e=v.current;e&&e.scrollTo({top:e.scrollHeight-e.clientHeight,behavior:"smooth"})},[]);(0,u.useEffect)(()=>{S()},[e,t,o,x,S]);const C=(0,u.useCallback)(()=>{b(e=>e+1)},[]),I=a||r.length>0||i.length>0;return(0,M.jsxs)("div",{ref:v,className:"nfd-ai-chat-messages",children:[e.length>0&&e.map((t,n)=>{const s=n===e.length-1&&("assistant"===t.type||"assistant"===t.role);return(0,M.jsx)(U,{message:t.content,type:t.type,animateTyping:s&&!0===t.animateTyping,onContentGrow:s?C:void 0,executedTools:t.executedTools,approvalRequest:t.approvalRequest,onApprove:c,onReject:l,onExecuteTool:h,onSendMessage:p,onSendSystemMessage:m,conversationId:g,onClearTyping:f,brandId:w,toolResults:t.toolResults},t.id||n)}),n&&(0,M.jsx)(W,{message:n}),_&&(n||y)&&(0,M.jsx)("p",{className:"nfd-ai-chat-messages__retry",children:(0,M.jsx)("button",{type:"button",className:"nfd-ai-chat-messages__retry-button",onClick:_,children:(0,d.__)("Retry","wp-module-ai-chat")})}),t&&(0,M.jsx)(B,{status:s,activeToolCall:a,toolProgress:o,executedTools:I?r:[],pendingTools:i})]})};var G=n(6427),Y=n(5963),V=n(9947);const X=({onSendMessage:e,onStopRequest:t,disabled:n=!1,showStopButton:s,placeholder:a,contextComponent:o=null,showTopBorder:r=!0})=>{const i=null!=s?s:n,[c,l]=(0,u.useState)(""),[h,p]=(0,u.useState)(!1),m=(0,u.useRef)(null),g=(0,u.useRef)(null),f=(0,d.__)("How can I help you today?","wp-module-ai-chat");(0,u.useEffect)(()=>{if(m.current){m.current.style.height="auto";const e=m.current.scrollHeight,t=Math.min(e,200);m.current.style.height=`${t}px`,m.current.style.overflowY=e>200?"auto":"hidden"}},[c]),(0,u.useEffect)(()=>{!n&&m.current&&setTimeout(()=>{m.current.focus()},100)},[n]);const _=()=>{c.trim()&&!n&&(e(c),l(""),m.current&&(m.current.style.height="auto",m.current.style.overflowY="hidden",m.current.focus()))},y=["nfd-ai-chat-input",!r&&"nfd-ai-chat-input--no-top-border"].filter(Boolean).join(" ");return(0,M.jsxs)("div",{className:y,children:[(0,M.jsxs)("div",{className:"nfd-ai-chat-input__container",children:[(0,M.jsx)("textarea",{name:"nfd-ai-chat-input",ref:m,value:c,onChange:e=>l(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),_())},placeholder:a||f,className:"nfd-ai-chat-input__textarea",rows:1,disabled:n}),(0,M.jsxs)("div",{className:"nfd-ai-chat-input__actions",children:[o,i?(0,M.jsx)(G.Button,{ref:g,icon:(0,M.jsx)(Y.A,{width:16,height:16}),label:(0,d.__)("Stop generating","wp-module-ai-chat"),onClick:()=>{h||(p(!0),t&&t(),setTimeout(()=>{p(!1)},500))},className:"nfd-ai-chat-input__stop",disabled:h,"aria-busy":h}):(0,M.jsx)(G.Button,{icon:(0,M.jsx)(V.A,{width:16,height:16}),label:(0,d.__)("Send message","wp-module-ai-chat"),onClick:_,className:"nfd-ai-chat-input__submit",disabled:!c.trim()})]})]}),(0,M.jsx)("div",{className:"nfd-ai-chat-input__disclaimer",children:(0,d.__)("AI-generated content is not guaranteed for accuracy.","wp-module-ai-chat")})]})},Z=({width:e=24,height:t=24})=>(0,M.jsx)("div",{className:"nfd-ai-chat-avatar",style:{width:e,height:t},children:(0,M.jsx)(H.A,{width:.625*e,height:.625*t})}),Q=()=>(0,M.jsx)("span",{className:"nfd-ai-chat-blu-beta-badge",children:(0,d.__)("BETA","wp-module-ai-chat")}),ee=({title:e,badge:t,logo:n,leftActions:s,rightActions:a,className:o=""})=>(0,M.jsxs)("div",{className:`nfd-ai-chat-header ${o}`.trim(),role:"banner",children:[(0,M.jsxs)("div",{className:"nfd-ai-chat-header__brand",children:[n,null!=e&&(0,M.jsx)("span",{className:"nfd-ai-chat-header__title",children:e}),t]}),(s||a)&&(0,M.jsxs)("div",{className:"nfd-ai-chat-header__actions",children:[s,a]})]}),te=e=>(0,M.jsx)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",focusable:"false",...e,children:(0,M.jsx)("path",{d:"M18 6L6 18M6 6l12 12",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})}),ne=({title:e,onNewChat:t,onClose:n,extraActions:s,newChatDisabled:a=!1})=>(0,M.jsx)(ee,{logo:(0,M.jsx)(Z,{width:24,height:24}),title:e||(0,d.__)("Blu Chat","wp-module-ai-chat"),badge:(0,M.jsx)(Q,{}),rightActions:(0,M.jsxs)(M.Fragment,{children:["function"==typeof t&&(0,M.jsx)("button",{type:"button",className:"nfd-ai-chat-header__btn nfd-ai-chat-header__btn--new",onClick:a?void 0:t,disabled:a,"aria-label":(0,d.__)("New chat","wp-module-ai-chat"),title:(0,d.__)("New chat","wp-module-ai-chat"),children:"+"}),s,"function"==typeof n&&(0,M.jsx)("button",{type:"button",className:"nfd-ai-chat-header__btn nfd-ai-chat-header__btn--close",onClick:n,"aria-label":(0,d.__)("Close","wp-module-ai-chat"),title:(0,d.__)("Close","wp-module-ai-chat"),children:(0,M.jsx)(te,{})})]})}),se=({icon:e,text:t,onClick:n,className:s=""})=>(0,M.jsxs)(G.Button,{className:`nfd-ai-chat-suggestion ${s}`,onClick:n,children:[(0,M.jsx)("div",{className:"nfd-ai-chat-suggestion__icon",children:e}),(0,M.jsx)("div",{className:"nfd-ai-chat-suggestion__text",children:t})]}),ae=({onSendMessage:e,title:t,subtitle:n,suggestions:s=[],showSuggestions:a=!1,animateWelcome:o=!1})=>{const r=(0,d.__)("Hi, I'm your AI assistant.","wp-module-ai-chat"),i=(0,d.__)("How can I help you today?","wp-module-ai-chat"),c=t||r,l=n||i,h=`${c} ${l}`,[p,m]=(0,u.useState)(0),g=(0,u.useRef)(null);(0,u.useEffect)(()=>{if(!o)return void m(h.length);m(0);const e=()=>{m(t=>t>=h.length?t:(g.current=setTimeout(e,40),t+1))};return g.current=setTimeout(e,40),()=>{g.current&&clearTimeout(g.current)}},[o,h]);const f=o&&p<h.length,_=f&&p<=c.length?c.slice(0,p):c,y=f?p>c.length?l.slice(0,p-c.length-1):"":l;return(0,M.jsxs)("div",{className:"nfd-ai-chat-welcome",children:[(0,M.jsxs)("div",{className:"nfd-ai-chat-welcome__content",children:[(0,M.jsx)("div",{className:"nfd-ai-chat-welcome__avatar",children:(0,M.jsx)(Z,{width:64,height:64})}),(0,M.jsxs)("div",{className:"nfd-ai-chat-welcome__message",children:[(0,M.jsx)("div",{className:"nfd-ai-chat-welcome__title",children:_}),(0,M.jsxs)("div",{className:"nfd-ai-chat-welcome__subtitle",children:[y,f&&p<h.length&&(0,M.jsx)("span",{className:"nfd-ai-chat-welcome__cursor","aria-hidden":"true"})]})]})]}),a&&s.length>0&&(0,M.jsx)("div",{className:"nfd-ai-chat-suggestions",children:s.map((t,n)=>(0,M.jsx)(se,{icon:t.icon,text:t.text,onClick:()=>e(t.action||t.text)},n))})]})};function oe(e,t,n,s,a={}){var o;if(!e||0===e.length)return;if(!e.some(e=>("user"===e.role||"user"===e.type)&&e.content&&String(e.content).trim()))return;if(null==t&&null==n)return;const r=null!==(o=a.maxHistoryItems)&&void 0!==o?o:3,i=m(s);try{const s=JSON.parse(localStorage.getItem(i.archive)||"[]"),a={sessionId:t,conversationId:n,messages:e.map(e=>({...e,timestamp:e.timestamp instanceof Date?e.timestamp.toISOString():e.timestamp})),archivedAt:(new Date).toISOString()},o=null!=n?s.filter(e=>e.conversationId!==n):s.filter(e=>e.sessionId!==t);o.unshift(a),localStorage.setItem(i.archive,JSON.stringify(o.slice(0,r)))}catch(e){console.warn("[Chat History] Failed to archive conversation:",e)}}var re=n(2836),ie=n(6849);const ce=e=>{const t=e.messages||e;return Array.isArray(t)&&t.some(e=>("user"===e.role||"user"===e.type)&&e.content&&String(e.content).trim())},le=({storageNamespace:e,onSelectConversation:t,refreshTrigger:n=0,disabled:s=!1,emptyMessage:a=null,maxHistoryItems:o=3})=>{const[r,i]=(0,u.useState)([]),c=m(e);(0,u.useEffect)(()=>{try{const e=localStorage.getItem(c.archive);if(e){const t=JSON.parse(e);if(Array.isArray(t)&&t.length>0){const e=t.slice(0,o);e.length<t.length&&localStorage.setItem(c.archive,JSON.stringify(e));const n=e.map(e=>{var t,n;const s=(e.messages||[]).map(e=>({...e,timestamp:e.timestamp?new Date(e.timestamp):new Date})),a=e.archivedAt?new Date(e.archivedAt):null;return{sessionId:null!==(t=e.sessionId)&&void 0!==t?t:null,conversationId:null!==(n=e.conversationId)&&void 0!==n?n:null,messages:s,archivedAt:a}}).filter(ce);return void i(n)}}const t=localStorage.getItem(c.history);if(t){const e=JSON.parse(t);if(Array.isArray(e)&&e.length>0){const t=((e,t)=>{if(!Array.isArray(e)||0===e.length)return[];const n={},s=[];e.forEach(e=>{if(e.sessionId){n[e.sessionId]||(n[e.sessionId]={sessionId:e.sessionId,messages:[],timestamp:e.timestamp?new Date(e.timestamp).getTime():0}),n[e.sessionId].messages.push(e);const t=e.timestamp?new Date(e.timestamp).getTime():0;t>n[e.sessionId].timestamp&&(n[e.sessionId].timestamp=t)}else s.push(e)});let a=Object.values(n).sort((e,t)=>t.timestamp-e.timestamp).map(e=>({sessionId:e.sessionId,messages:e.messages}));if(s.length>0&&a.length<t){const e=(e=>{const t=[];let n=[],s=null;return e.forEach(e=>{const a=e.timestamp?new Date(e.timestamp).getTime():Date.now();s&&a-s>3e5&&n.length>0&&(t.push({sessionId:null,messages:[...n]}),n=[]),n.push(e),s=a}),n.length>0&&t.push({sessionId:null,messages:n}),t.reverse()})(s);a=[...a,...e]}return a=a.filter(ce),a.slice(0,t)})(e.map(e=>({...e,timestamp:e.timestamp?new Date(e.timestamp):new Date})),o);i(t)}}}catch(e){console.warn("[Chat History] Failed to load chat history:",e)}},[e,n,o]);const l=(0,u.useCallback)(e=>{if(!s)try{const n=(e.messages||e).map(e=>({...e,timestamp:e.timestamp instanceof Date?e.timestamp.toISOString():e.timestamp}));localStorage.setItem(c.history,JSON.stringify(n)),e.sessionId&&localStorage.setItem(c.sessionId,e.sessionId),e.conversationId&&localStorage.setItem(c.conversationId,e.conversationId),t&&t(e)}catch(e){console.warn("[Chat History] Failed to restore conversation:",e)}},[s,c,t]),h=(0,u.useCallback)((e,t)=>{if(e.stopPropagation(),e.preventDefault(),!s)try{const e=localStorage.getItem(c.archive);if(e){const n=JSON.parse(e).filter((e,n)=>n!==t);localStorage.setItem(c.archive,JSON.stringify(n))}i(e=>e.filter((e,n)=>n!==t))}catch(e){console.warn("[Chat History] Failed to delete conversation:",e)}},[s,c]);return 0===r.length?a?(0,M.jsx)("div",{className:"nfd-ai-chat-history-list nfd-ai-chat-history-list--empty",children:a}):null:(0,M.jsx)("div",{className:"nfd-ai-chat-history-list",children:r.map((e,t)=>{const n=(e=>{const t=(e.messages||e).find(e=>"user"===e.role||"user"===e.type);if(t&&t.content){const e=t.content;return e.length>50?e.substring(0,50)+"...":e}return(0,d.__)("Previous conversation","wp-module-ai-chat")})(e),a=e.sessionId||`legacy-${t}`,o=e.archivedAt||(e=>{const t=e.messages||e;if(!Array.isArray(t)||0===t.length)return null;let n=0;return t.forEach(e=>{const t=e.timestamp?new Date(e.timestamp).getTime():0;t>n&&(n=t)}),n?new Date(n):null})(e)||null,r=o?(e=>{const t=e instanceof Date?e:new Date(e),n=Date.now()-t.getTime(),s=Math.floor(n/6e4),a=Math.floor(n/36e5),o=Math.floor(n/864e5);return s<1?(0,d.__)("Just now","wp-module-ai-chat"):s<60?`${s}m`:a<24?`${a}h`:o<7?`${o}d`:t.toLocaleDateString(void 0,{month:"short",day:"numeric"})})(o):null;return(0,M.jsxs)("div",{className:"nfd-ai-chat-history-item"+(s?" nfd-ai-chat-history-item--disabled":""),role:"button",tabIndex:s?-1:0,"aria-disabled":s,onClick:()=>l(e),onKeyDown:t=>{s||"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),l(e))},children:[(0,M.jsx)(re.A,{width:14,height:14,"aria-hidden":!0}),(0,M.jsxs)("div",{className:"nfd-ai-chat-history-item__content",children:[(0,M.jsx)("span",{className:"nfd-ai-chat-history-item__title",children:n}),(0,M.jsxs)("div",{className:"nfd-ai-chat-history-item__meta",children:[r&&(0,M.jsx)("span",{className:"nfd-ai-chat-history-item__time",children:r}),(0,M.jsx)("button",{type:"button",className:"nfd-ai-chat-history-item__delete",onClick:e=>h(e,t),"aria-label":(0,d.__)("Delete conversation","wp-module-ai-chat"),title:(0,d.__)("Delete","wp-module-ai-chat"),children:(0,M.jsx)(ie.A,{width:14,height:14,className:"nfd-ai-chat-history-item__delete-icon","aria-hidden":!0})})]})]})]},a)})})},ue=e=>(0,M.jsxs)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",focusable:"false",...e,children:[(0,M.jsx)("circle",{cx:"12",cy:"12",r:"9",stroke:"currentColor",strokeWidth:"2"}),(0,M.jsx)("path",{d:"M12 7v5l3 3",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})]}),de=({storageNamespace:e,open:t,onOpenChange:n,onSelectConversation:s,refreshTrigger:a=0,disabled:o=!1,maxHistoryItems:r})=>{const i=(0,u.useRef)(null),c=(0,u.useRef)(null),[l,h]=(0,u.useState)({top:0,left:0,openUp:!1}),p=(0,u.useCallback)(()=>{if(!i.current)return;const e=i.current.getBoundingClientRect(),t=window.innerHeight-e.bottom,n=t<240&&e.top>t;h({top:n?e.top:e.bottom,left:e.right,openUp:n})},[]);(0,u.useLayoutEffect)(()=>{t&&p()},[t,p]),(0,u.useEffect)(()=>{if(!t)return;const e=()=>p();return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[t,p]),(0,u.useEffect)(()=>{if(!t)return;const e=e=>{i.current?.contains(e.target)||c.current?.contains(e.target)||n(!1)},s=e=>{"Escape"===e.key&&n(!1)};return document.addEventListener("mousedown",e),document.addEventListener("keydown",s),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("keydown",s)}},[t,n]);const m=(0,u.useCallback)(e=>{s(e),n(!1)},[s,n]),g=(0,M.jsx)("div",{ref:c,className:"nfd-ai-chat-history-dropdown",role:"dialog","aria-label":(0,d.__)("Chat history","wp-module-ai-chat"),style:{position:"fixed",top:l.openUp?"auto":l.top,bottom:l.openUp?window.innerHeight-l.top:"auto",left:"auto",right:window.innerWidth-l.left,zIndex:1e5},children:(0,M.jsx)("div",{className:"nfd-ai-chat-history-dropdown-inner",children:(0,M.jsx)(le,{storageNamespace:e,onSelectConversation:m,disabled:o,refreshTrigger:t?a:0,emptyMessage:(0,d.__)("No conversations yet.","wp-module-ai-chat"),maxHistoryItems:r})})});return(0,M.jsxs)("div",{className:"nfd-ai-chat-history-dropdown-wrapper",children:[(0,M.jsx)("button",{ref:i,type:"button",className:"nfd-ai-chat-history-dropdown-trigger "+(t?"is-open":""),onClick:()=>{o||n(!t)},disabled:o,"aria-expanded":t,"aria-haspopup":"true","aria-label":(0,d.__)("Chat history","wp-module-ai-chat"),title:(0,d.__)("Chat history","wp-module-ai-chat"),children:(0,M.jsx)(ue,{})}),t&&(0,u.createPortal)(g,document.body)]})};var he=n(3875),pe=n(3733);function me(e){const t=e&&String(e).trim()?`"${String(e).trim()}"`:"this",n=window?.nfdHelpCenter?.resourceLink||"#",s=(0,d.__)("Resource center","wp-module-help-center"),a=(0,d.__)("You can try searching our ","wp-module-help-center"),o=(0,d.__)(" though to see if there's a helpful article or video on that subject.","wp-module-help-center"),r=(0,d.sprintf)((0,d.__)("Sorry, I don't have any information on %s yet.","wp-module-help-center"),t),i=(0,d.__)("Try to:","wp-module-help-center"),c=(0,d.__)("Use different keywords in the search field.","wp-module-help-center"),l=(0,d.__)("A clear, short prompt can make the difference.","wp-module-help-center"),u=(0,d.__)("Reach out to our customer support.","wp-module-help-center"),h=(0,d.__)("Call at","wp-module-help-center"),p=(0,d.__)("or","wp-module-help-center"),m=(0,d.__)("Chat Live","wp-module-help-center"),g=(0,d.__)("with one of our support agents — we will assist you as soon as possible.","wp-module-help-center");return["<p>"+r+"</p>","<p><strong>"+i+"</strong></p>","<ul>","<li>"+ge(a)+'<a href="'+(f=n,ge(f)+'" target="_blank" rel="noopener noreferrer">')+ge(s)+"</a>"+ge(o)+"</li>","<li>"+ge(c+" "+l)+"</li>","<li>"+ge(u+" "+h)+' <a href="tel:8884014678">888-401-4678</a> '+ge(p)+" "+ge(m)+" "+ge(g)+"</li>","</ul>"].join("");var f}function ge(e){return"string"!=typeof e?"":e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}var fe=n(1069),_e=n(4989),ye=n(7738);const we=()=>{const[e]=(()=>{const[e,t]=(0,u.useState)(()=>fe.Sp.getHelpVisible());return(0,u.useEffect)(()=>{const e=()=>{t(fe.Sp.getHelpVisible())};return window.addEventListener("storage",e),()=>{window.removeEventListener("storage",e)}},[]),[e,t]})(),{hasLaunchedFromTooltip:t}=(0,_e.X)(),{onClose:n}=(0,pe.b_)(),s=(0,u.useRef)(!1),[a,o]=(0,u.useState)(!1),[r,i]=(0,u.useState)(0),c=(()=>{const e=m("help_center");try{if("true"===localStorage.getItem("nfd-ai-chat-help_center-load-history"))return localStorage.removeItem("nfd-ai-chat-help_center-load-history"),!0;const t=localStorage.getItem(e.archive);if(t){const n=JSON.parse(t),s=Array.isArray(n)&&n[0];if(s?.archivedAt){const t=new Date(s.archivedAt).getTime();if(Date.now()-t<=6e5){const t=(s.messages||[]).map(e=>({...e,timestamp:e.timestamp instanceof Date?e.timestamp.toISOString():e.timestamp}));return localStorage.setItem(e.history,JSON.stringify(t)),null!=s.conversationId&&localStorage.setItem(e.conversationId,String(s.conversationId)),null!=s.sessionId&&localStorage.setItem(e.sessionId,String(s.sessionId)),!0}}}}catch(e){}return!1})(),{messages:l,sendMessage:h,sendSystemMessage:g,isTyping:f,status:y,currentResponse:w,conversationId:v,clearApprovalRequest:x,clearTyping:b,updateMessage:S,stopRequest:C,clearChatHistory:N,loadConversation:A,getSessionId:T,error:$,connectionState:k,isConnecting:R,manualRetry:E}=(({configEndpoint:e,storageNamespace:t="default",autoConnect:n=!1,consumerType:s="editor_chat",autoLoadHistory:a=!0,getConnectionFailedFallbackMessage:o}={})=>{const r=`nfd-ai-chat-${t}-history`,i=`nfd-ai-chat-${t}-conversation-id`,c=`nfd-ai-chat-${t}-session-id`,l=()=>{try{const e=localStorage.getItem(r),t=localStorage.getItem(i),n=localStorage.getItem(c);if(e){const s=JSON.parse(e);if(Array.isArray(s)&&s.length>0)return{messages:s.map(e=>({...e,timestamp:e.timestamp?new Date(e.timestamp):new Date,animateTyping:!1})),conversationId:t||null,sessionId:n||null}}}catch(e){console.warn("[AI Chat] Failed to restore chat history from localStorage:",e)}return{messages:[],conversationId:null,sessionId:null}},[h,m]=(0,u.useState)(()=>a?l().messages:[]),[g,f]=(0,u.useState)(()=>a?l().conversationId:null),[_,y]=(0,u.useState)(!1),[w,v]=(0,u.useState)(!1),[x,b]=(0,u.useState)(null),[S,C]=(0,u.useState)(!1),[N,A]=(0,u.useState)(null),[T,$]=(0,u.useState)(""),[k,R]=(0,u.useState)(null),[E,D]=(0,u.useState)(()=>{try{if("1"===sessionStorage.getItem(`nfd-ai-chat-${t}-connection-failed`))return"failed"}catch(e){}return"disconnected"}),[O,M]=(0,u.useState)(0),L=(0,u.useRef)(null),F=(0,u.useRef)(null),q=(0,u.useRef)(0),U=(0,u.useRef)(null),W=(0,u.useRef)(null),P=(0,u.useRef)(!1),H=(0,u.useRef)(a?l().sessionId:null),z=(0,u.useRef)(!1),J=(0,u.useRef)(!1),B=(0,u.useRef)(null),K=(0,u.useRef)(!0),G=(0,u.useRef)([]),Y=(0,u.useRef)(E),V=(0,u.useRef)(E),X=6e4,Z=(0,u.useCallback)(()=>"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),[]),Q=(0,u.useCallback)(async()=>{try{let n=e;if(e.startsWith("http://")||e.startsWith("https://")){const t=new URL(e);n=t.searchParams.has("rest_route")?t.searchParams.get("rest_route"):t.pathname.includes("/wp-json/")?t.pathname.replace("/wp-json/",""):t.pathname.replace(/^\//,"")}const s=`${n.startsWith("/")?n.slice(1):n}?storage_namespace=${encodeURIComponent(t)}`,a=await p()({path:s,parse:!0});return U.current=a,a}catch(e){console.error("[AI Chat] Failed to fetch config:",e),console.error("[AI Chat] Error details:",{message:e.message,code:e.code,data:e.data,status:e.data?.status,statusText:e.data?.statusText});let t=e.message||(0,d.__)("Failed to connect","wp-module-ai-chat");throw e.data?.message?t=e.data.message:e.message&&"Could not get a valid response from the server."!==e.message&&(t=e.message),"rest_forbidden"===e.code||403===e.data?.status?t=(0,d.__)("Access denied. Please check your capabilities.","wp-module-ai-chat"):"rest_no_route"===e.code||404===e.data?.status?t=(0,d.__)("Config endpoint not found. Please ensure the backend is deployed.","wp-module-ai-chat"):"gateway_url_not_configured"===e.code?t=(0,d.__)("Gateway URL not configured. Set NFD_AGENTS_CHAT_GATEWAY_URL in wp-config.php.","wp-module-ai-chat"):"huapi_token_fetch_failed"===e.code?t=(0,d.__)("Failed to fetch authentication token from Hiive. Check your connection or set NFD_AGENTS_CHAT_DEBUG_TOKEN for local development.","wp-module-ai-chat"):e.data?.status&&(t=(0,d.sprintf)(/* translators: %1$s: HTTP status, %2$s: status text */ /* translators: %1$s: HTTP status, %2$s: status text */
(0,d.__)("Failed to fetch config: %1$s %2$s","wp-module-ai-chat"),e.data.status,e.data.statusText||t)),new Error(t)}},[e,t]),ee=(0,u.useCallback)(async()=>{if(L.current?.readyState!==WebSocket.OPEN&&L.current?.readyState!==WebSocket.CONNECTING&&!P.current){try{sessionStorage.removeItem(`nfd-ai-chat-${t}-connection-failed`)}catch(e){}P.current=!0,v(!0),D("connecting"),b(null);try{U.current||await Q();const n=U.current;if(!n)throw new Error((0,d.__)("No configuration available","wp-module-ai-chat"));H.current||(H.current=Z());const a=(e=n.gateway_url)&&"string"==typeof e?e.startsWith("http://")?e.replace("http://","ws://"):e.startsWith("https://")?e.replace("https://","wss://"):e.startsWith("ws://")||e.startsWith("wss://")?e:(e=>{if(!e||"string"!=typeof e)return!1;const t=e.toLowerCase();return t.includes("localhost")||t.includes("127.0.0.1")})(e)?`ws://${e}`:`wss://${e}`:e,o=("nfd-agents"===n.agent_type?"blu":n.agent_type)||"blu";let r=`${a}/${n.brand_id}/agents/${o}/v1/ws?session_id=${H.current}&token=${encodeURIComponent(n.huapi_token)}`;const l=`wordpress_${s}`;r+=`&consumer=${encodeURIComponent(l)}`,n.site_url&&console.warn("[AI Chat] site_url parameter is deprecated. Use consumerType instead.");const u=new WebSocket(r);L.current=u,u.onopen=()=>{P.current=!1,y(!0),v(!1),D("connected"),M(0),b(null),q.current=0,z.current=G.current&&G.current.length>0,J.current=!1,$("")},u.onmessage=e=>{try{const t=JSON.parse(e.data);if(J.current&&"session_established"!==t.type)return;if("session_established"===t.type){if(t.session_id){H.current=t.session_id;try{localStorage.setItem(c,t.session_id)}catch(e){console.warn("[AI Chat] Failed to save session ID to localStorage:",e)}}}else if("typing_start"===t.type)C(!0),A(I("typing_start")),B.current&&(clearTimeout(B.current),B.current=null);else if("typing_stop"===t.type)C(!1),A(null),$(""),B.current&&(clearTimeout(B.current),B.current=null);else if("streaming_chunk"===t.type||"chunk"===t.type){if(J.current)return;const e=t.content||t.chunk||t.text||"";e&&$(t=>{const n=t+e;return!z.current&&n.length<100&&j(n)?(console.debug("[AI Chat] Filtering initial greeting:",n.substring(0,50)),""):(C(!0),B.current&&clearTimeout(B.current),B.current=setTimeout(()=>{C(!1),A(null),B.current=null},X),n)})}else if("structured_output"===t.type){const e=t.response_content?.content?.human_input_request;if(e&&"APPROVAL_REQUEST"===(e.input_type||e.inputType||"").toUpperCase()){if(t.conversation_id||t.conversationId){const e=t.conversation_id||t.conversationId;f(e);try{localStorage.setItem(i,e)}catch(e){console.warn("[AI Chat] Failed to save conversation ID to localStorage:",e)}}return}const n=t.message||t.response_content?.message,s=n?.trim();if(s&&"No content provided"!==s&&"sales_requested"!==s&&"sales_requested"!==s.toLowerCase()){if(!z.current&&s.length<150&&j(s))return console.debug("[AI Chat] Filtering greeting message:",s.substring(0,50)),void $("");$(e=>(e&&m(t=>[...t,{id:`msg-${Date.now()}-streaming`,role:"assistant",type:"assistant",content:e,timestamp:new Date,animateTyping:!0}]),"")),m(e=>[...e,{id:`msg-${Date.now()}`,role:"assistant",type:"assistant",content:s,timestamp:new Date,animateTyping:!0}]),C(!1),A(null),$(""),B.current&&(clearTimeout(B.current),B.current=null)}}else if("tool_call"===t.type)A(I("tool_call"));else if("tool_result"===t.type){if(A(I("tool_result")),t.conversation_id||t.conversationId){const e=t.conversation_id||t.conversationId;f(e);try{localStorage.setItem(i,e)}catch(e){console.warn("[AI Chat] Failed to save conversation ID to localStorage:",e)}}}else if("message"===t.type||"complete"===t.type){let e=!1;if($(t=>{if(t){const n=t.trim();if("No content provided"===n||"sales_requested"===n||"sales_requested"===n.toLowerCase())return"";if(!z.current&&t.length<150&&j(t))return console.debug("[AI Chat] Filtering greeting in complete message:",t.substring(0,50)),"";m(e=>[...e,{id:`msg-${Date.now()}`,role:"assistant",type:"assistant",content:t,timestamp:new Date,animateTyping:!0}]),e=!0}return""}),!e){const n=t.message||t.response_content?.message,s=n?.trim();s&&"No content provided"!==s&&"sales_requested"!==s&&"sales_requested"!==s.toLowerCase()&&(!z.current&&s.length<150&&j(s)?console.debug("[AI Chat] Filtering greeting in message payload:",s.substring(0,50)):(m(e=>[...e,{id:`msg-${Date.now()}`,role:"assistant",type:"assistant",content:s,timestamp:new Date,animateTyping:!0}]),e=!0))}e&&(C(!1),A(null),$(""),B.current&&(clearTimeout(B.current),B.current=null))}else if("handoff_accept"===t.type)A(I("handoff_accept"));else if("handoff_request"===t.type){A(I("handoff_request"));const e=t.message||t.response_content?.message,n=e?.trim();if(!n||"No content provided"===n||"sales_requested"===n||"sales_requested"===n.toLowerCase())return void $("");m(e=>[...e,{id:`msg-${Date.now()}`,role:"assistant",type:"assistant",content:n,timestamp:new Date,animateTyping:!0}]),C(!1),A(null),$(""),B.current&&(clearTimeout(B.current),B.current=null)}else if("error"===t.type)b(t.message||t.error||(0,d.__)("An error occurred","wp-module-ai-chat")),C(!1),A(null),$("");else if(t.message||t.response_content?.message){const e=t.message||t.response_content?.message,n=e?.trim();if(!n||"No content provided"===n||"sales_requested"===n||"sales_requested"===n.toLowerCase())return void $("");if(!z.current&&n.length<150&&j(n))return console.debug("[AI Chat] Filtering greeting in generic message:",n.substring(0,50)),void $("");m(e=>[...e,{id:`msg-${Date.now()}`,role:"assistant",type:"assistant",content:n,timestamp:new Date,animateTyping:!0}]),C(!1),A(null),$(""),B.current&&(clearTimeout(B.current),B.current=null)}}catch(e){console.error("[AI Chat] Error parsing WebSocket message:",e)}},u.onerror=e=>{console.error("[AI Chat] WebSocket error:",e),P.current=!1,v(!1),D("failed");try{sessionStorage.setItem(`nfd-ai-chat-${t}-connection-failed`,"1")}catch(e){}},u.onclose=e=>{if(P.current=!1,y(!1),v(!1),C(!1),A(null),L.current===u&&(L.current=null),1e3!==e.code&&q.current<5){q.current++,M(q.current),D("reconnecting");const e=1e3*Math.pow(2,q.current-1);F.current=setTimeout(()=>{ee()},e)}else if(q.current>=5){D("failed");try{sessionStorage.setItem(`nfd-ai-chat-${t}-connection-failed`,"1")}catch(e){}}else D("disconnected")}}catch(e){P.current=!1,console.error("[AI Chat] Error creating WebSocket:",e),v(!1),D("failed");try{sessionStorage.setItem(`nfd-ai-chat-${t}-connection-failed`,"1")}catch(e){}}var e}},[Q,Z,t]);(0,u.useEffect)(()=>{G.current=h},[h]),(0,u.useEffect)(()=>{Y.current=E},[E]),(0,u.useEffect)(()=>{if("failed"!==E||"failed"===V.current)return void(V.current=E);V.current=E;const e=(0,d.__)("Sorry, we couldn't connect. Please try again later or contact support.","wp-module-ai-chat");m(t=>{const n=t.length>0?t[t.length-1]:null,s=n&&("user"===n.role||"user"===n.type),a="function"==typeof o?o(s?n.content:""):e;return[...t,{id:`msg-${Date.now()}-fallback`,role:"assistant",type:"assistant",content:a,timestamp:new Date}]}),b(null),$(""),C(!1),A(null),B.current&&(clearTimeout(B.current),B.current=null)},[E,o]);const te=(0,u.useCallback)((e,t=null)=>{if(J.current=!1,z.current=!0,("failed"===Y.current||q.current>=5&&(!L.current||L.current.readyState!==WebSocket.OPEN))&&!t){const t={id:`msg-${Date.now()}`,role:"user",type:"user",content:e,timestamp:new Date,sessionId:H.current},n="function"==typeof o?o(e):(0,d.__)("Sorry, we couldn't connect. Please try again later or contact support.","wp-module-ai-chat");return m(e=>[...e,t,{id:`msg-${Date.now()}-fallback`,role:"assistant",type:"assistant",content:n,timestamp:new Date}]),b(null),$(""),C(!1),void A(null)}if(!L.current||L.current.readyState!==WebSocket.OPEN){if(!t){const t={id:`msg-${Date.now()}`,role:"user",type:"user",content:e,timestamp:new Date,sessionId:H.current};m(e=>[...e,t])}return void("disconnected"===Y.current&&ee())}if(!t){const t={id:`msg-${Date.now()}`,role:"user",type:"user",content:e,timestamp:new Date,sessionId:H.current};m(e=>[...e,t]),$(""),C(!0),B.current&&clearTimeout(B.current),B.current=setTimeout(()=>{C(!1),A(null),B.current=null},X)}const n={type:"chat",message:e};t?n.conversationId=t:g&&(n.conversationId=g),L.current.send(JSON.stringify(n))},[g,o]),ne=(0,u.useCallback)(e=>{if(!L.current||L.current.readyState!==WebSocket.OPEN)return void console.warn("[AI Chat] Cannot send system message - not connected");const t={type:"chat",message:e};g&&(t.conversationId=g),C(!0),$(""),B.current&&clearTimeout(B.current),B.current=setTimeout(()=>{C(!1),A(null),B.current=null},X),L.current.send(JSON.stringify(t))},[g,ee]),se=(0,u.useCallback)(()=>{F.current&&clearTimeout(F.current),B.current&&(clearTimeout(B.current),B.current=null),L.current&&(L.current.close(1e3,"User disconnected"),L.current=null),y(!1),v(!1),D("disconnected")},[]),ae=(0,u.useCallback)(e=>{H.current=null!=e?e:null},[]),oe=(0,u.useCallback)((e,t,n)=>{if(Array.isArray(e)){const t=e.map(e=>({...e,timestamp:e.timestamp?new Date(e.timestamp):new Date,animateTyping:!1}));m(t)}if(f(null!=t?t:null),H.current=null!=n?n:null,b(null),C(!1),A(null),$(""),null!=n&&L.current?.readyState===WebSocket.OPEN){try{localStorage.setItem(c,n),null!=t&&localStorage.setItem(i,t)}catch(e){console.warn("[AI Chat] Failed to persist session for history load:",e)}se(),ee()}},[ee,se]),re=(0,u.useCallback)(()=>{var e;return null!==(e=H.current)&&void 0!==e?e:null},[]),ie=(0,u.useCallback)(()=>{J.current=!0,C(!1),A(null),$(""),B.current&&(clearTimeout(B.current),B.current=null)},[]),ce=(0,u.useCallback)(()=>{R(null)},[]),le=(0,u.useCallback)(()=>{C(!1),A(null),B.current&&(clearTimeout(B.current),B.current=null)},[]),ue=(0,u.useCallback)(e=>{let t;if(null==e)t=(0,d.__)("No content provided.","wp-module-ai-chat");else if("object"==typeof e)try{t=JSON.stringify(e,null,2)}catch(n){console.warn("[useNfdAgentsWebSocket] Failed to stringify content object:",n),t=String(e)}else t=String(e);m(e=>[...e,{id:`msg-${Date.now()}`,role:"assistant",type:"assistant",content:t,timestamp:new Date}]),C(!1),A(null),B.current&&(clearTimeout(B.current),B.current=null)},[]),de=(0,u.useCallback)((e,t)=>{m(n=>n.map(n=>("function"==typeof e?e(n):n.id===e)?t(n):n))},[]);(0,u.useEffect)(()=>{const e=W.current;if(null===e)return W.current=n,void(n&&"failed"!==E&&!P.current&&(!L.current||L.current.readyState!==WebSocket.OPEN&&L.current.readyState!==WebSocket.CONNECTING)&&ee());e!==n&&(W.current=n,n?P.current||L.current&&(L.current.readyState===WebSocket.OPEN||L.current.readyState===WebSocket.CONNECTING)||ee():se())},[n,E]);const he=e=>Array.isArray(e)&&e.some(e=>("user"===e.role||"user"===e.type)&&e.content&&String(e.content).trim());(0,u.useEffect)(()=>{if(K.current){if(K.current=!1,h.length>0&&he(h))try{localStorage.setItem(r,JSON.stringify(h))}catch(e){console.warn("[AI Chat] Failed to save messages to localStorage:",e)}}else try{he(h)?localStorage.setItem(r,JSON.stringify(h)):localStorage.removeItem(r)}catch(e){console.warn("[AI Chat] Failed to save messages to localStorage:",e)}},[h]),(0,u.useEffect)(()=>{try{g?localStorage.setItem(i,g):localStorage.removeItem(i)}catch(e){console.warn("[AI Chat] Failed to save conversation ID to localStorage:",e)}},[g]);const pe=(0,u.useCallback)(()=>{try{localStorage.removeItem(r),localStorage.removeItem(i),localStorage.removeItem(c),m([]),f(null),R(null),C(!1),A(null),$(""),b(null),H.current=null,L.current&&(L.current.close(),L.current=null,y(!1)),z.current=!1,J.current=!1,B.current&&(clearTimeout(B.current),B.current=null),F.current&&(clearTimeout(F.current),F.current=null),q.current=0}catch(e){console.warn("[AI Chat] Failed to clear chat history:",e)}},[]),me=(0,u.useCallback)(()=>{q.current=0,M(0),b(null),ee()},[ee]);return{messages:h,setMessages:m,setConversationId:f,setSessionId:ae,loadConversation:oe,getSessionId:re,sendMessage:te,sendSystemMessage:ne,isConnected:_,isConnecting:w,error:x,isTyping:S,status:N,currentResponse:T,approvalRequest:k,conversationId:g,clearApprovalRequest:ce,clearTyping:le,addAssistantMessage:ue,updateMessage:de,connect:ee,disconnect:se,stopRequest:ie,clearChatHistory:pe,brandId:U.current?.brand_id||null,connectionState:E,retryAttempt:O,maxRetries:5,manualRetry:me}})({configEndpoint:"/nfd-agents/chat/v1/config",storageNamespace:"help_center",autoConnect:e,consumerType:"help_center",autoLoadHistory:c,getConnectionFailedFallbackMessage:me});(0,u.useEffect)(()=>{l.length>0&&oe(l,T(),v,"help_center")},[l,T,v]);const D=(0,u.useCallback)(e=>{var t,n;const s=e.messages||e;A(s,null!==(t=e.conversationId)&&void 0!==t?t:null,null!==(n=e.sessionId)&&void 0!==n?n:null)},[A]),O=(0,u.useCallback)(()=>{S&&S(e=>"approval_request"===e.type&&e.approvalRequest,e=>({...e,type:"assistant",content:(0,d.__)("Action approved and executed.","wp-module-help-center"),approvalRequest:null})),x()},[x,S]),L=(0,u.useCallback)(()=>{S&&S(e=>"approval_request"===e.type&&e.approvalRequest,e=>{const t=e.approvalRequest?.tool_name||"action";return{...e,type:"assistant",content:(0,d.sprintf)(/* translators: %s: the name of the action or tool that was cancelled */ /* translators: %s: the name of the action or tool that was cancelled */
(0,d.__)('Action "%s" was cancelled.',"wp-module-help-center"),t),approvalRequest:null}}),x()},[x,S]),F=(0,u.useCallback)(()=>{s.current=!1,l.length>0&&oe(l,T(),v,"help_center"),N(),i(e=>e+1)},[l,T(),v,N]),q=(0,u.useCallback)(()=>{s.current=!1,function(e,t){const n=m("help_center");try{const s=JSON.parse(localStorage.getItem(n.archive)||"[]"),a=s.filter(n=>n.conversationId!==e||n.sessionId!==t);a.length!==s.length&&localStorage.setItem(n.archive,JSON.stringify(a))}catch(e){console.warn("[Chat History] Failed to remove conversation from archive:",e)}}(v,T()),N(),i(e=>e+1)},[v,T,N]),U=[...l];w&&f&&U.push({id:"streaming",role:"assistant",type:"assistant",content:w,timestamp:new Date});const W=0===U.length&&!s.current;(0,u.useEffect)(()=>{U.length>0&&(s.current=!0)},[U.length]);const P=l.length>0;let H;return H=W?(0,M.jsx)("div",{className:"nfd-help-center-chat__welcome-wrapper",children:(0,M.jsx)(ae,{onSendMessage:h,title:(0,d.__)("Hi, I'm BLU, your AI assistant.","wp-module-help-center"),subtitle:(0,d.__)("I can help you create and edit posts and pages, update content, and manage your WordPress site.","wp-module-help-center"),showSuggestions:!1})}):(0,M.jsxs)("div",{className:"nfd-help-center-chat__messages-wrapper",children:[l.length>0&&(0,M.jsx)("div",{className:"nfd-help-center-chat__messages-header",children:(0,M.jsx)("button",{onClick:q,className:"nfd-help-center-chat__clear-chat-button","aria-label":(0,d.__)("Clear chat","wp-module-help-center"),children:(0,d.__)("Clear Chat","wp-module-help-center")})}),(0,M.jsx)(K,{messages:U,isLoading:f||R,status:R?_:y,error:$,onRetry:"failed"===k?E:void 0,connectionFailed:"failed"===k,onApprove:O,onReject:L,onSendMessage:h,onSendSystemMessage:g,conversationId:v,onClearTyping:b,brandId:null})]}),(0,M.jsxs)("div",{className:"nfd-help-center-chat nfd-ai-chat-container",children:[(0,M.jsx)("div",{className:"nfd-help-center-chat__header-wrapper",children:(0,M.jsx)(ne,{title:(0,d.__)("Blu Chat","wp-module-help-center"),onNewChat:F,newChatDisabled:W,onClose:n,extraActions:(0,M.jsx)(de,{storageNamespace:"help_center",open:a,onOpenChange:e=>{o(e),e&&i(e=>e+1)},onSelectConversation:e=>{D(e),o(!1)},refreshTrigger:r,disabled:!1})})}),H,(0,M.jsx)("div",{className:"nfd-help-center-chat__input-area",children:(0,M.jsx)("div",{className:"nfd-help-center-chat__input-wrapper",children:(0,M.jsx)(X,{onSendMessage:h,onStopRequest:C,disabled:f,placeholder:(0,d.__)("Ask me anything about WordPress…","wp-module-help-center"),showTopBorder:!1})})}),(0,ye.$)(t)&&(0,M.jsx)("div",{className:"nfd-help-center-chat__footer-wrapper"+(P?" nfd-help-center-chat__footer-wrapper--collapsed":""),"aria-hidden":P,children:(0,M.jsx)(he.A,{})})]})}}}]);