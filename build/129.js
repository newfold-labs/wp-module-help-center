"use strict";(globalThis.webpackChunk_newfold_labs_wp_module_help_center=globalThis.webpackChunk_newfold_labs_wp_module_help_center||[]).push([[129],{8129:(e,t,s)=>{s.d(t,{default:()=>ke});var n=s(8394),a=s(2975);const o=(e,t="")=>{if(e.includes("rest_route="))return e;const s=e.match(/\/wp-json\/(.+)$/);if(!s)return e;const n=s[1];t||"undefined"==typeof window||(t=window.location.origin);const a=t.replace(/\/wp-json\/?$/,""),o=a.includes("?")?"&":"?";return`${a}${o}rest_route=/${n}`};class r extends Error{constructor(e,t=null,s=null){super(e),this.name="MCPError",this.code=t,this.details=s}}new class{constructor(e={}){this.configKey=e.configKey||"nfdAIChat",this.client=null,this.transport=null,this.connected=!1,this.tools=[],this.resources=[],this.eventListeners=new Map}getConfig(){const e="undefined"!=typeof window&&window[this.configKey]||{},t=e.homeUrl||("undefined"!=typeof window?window.location.origin:"");let s=e.restUrl||"/wp-json/";s.includes("/wp-json/")?s=o(s,t):s.includes("rest_route=")||(s=o("/wp-json/",t));let n=e.mcpUrl;return n?n.includes("/wp-json/")&&(n=o(n,t)):n=((e,t,s="")=>{const n=((e="")=>{if(e&&e.includes("rest_route="))return e;e||"undefined"==typeof window||(e=window.location.origin);const t=e.includes("?")?"&":"?";return`${e}${t}rest_route=/`})(s),a=`${e}/${t}`;if(n.includes("rest_route="))return n.replace("rest_route=/",`rest_route=/${a}`);const o=n.includes("?")?"&":"?";return`${n}${o}rest_route=/${a}`})("mcp","mcp-adapter-default-server",t),{nonce:e.nonce||"",restUrl:s,mcpUrl:n,homeUrl:t}}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(t)}off(e,t){const s=this.eventListeners.get(e);s&&s.delete(t)}emit(e){const t=this.eventListeners.get(e.type);t&&t.forEach(t=>{try{t(e)}catch(e){console.error("Error in MCP event listener:",e)}})}async connect(e=null){try{const t=this.getConfig(),s=e||t.mcpUrl;if(!s)throw new r("MCP endpoint URL not configured");this.client=new n.K({name:"nfd-ai-chat-client",version:"1.0.0"},{capabilities:{}}),this.transport=new a.j(new URL(s),{requestInit:{headers:{"Content-Type":"application/json"}}}),await this.client.connect(this.transport),this.connected=!0,this.emit({type:"connected"})}catch(e){const t=e instanceof r?e:new r(`Connection failed: ${e.message}`);throw this.emit({type:"error",data:t}),t}}async initialize(){if(!this.connected)throw new r("Not connected to MCP server");try{await Promise.all([this.loadTools(),this.loadResources()]);const e={protocolVersion:"2025-06-18",capabilities:{tools:{},resources:{},prompts:{}},serverInfo:{name:"WordPress MCP Server",version:"1.0.0"}};return this.emit({type:"initialized",data:e}),e}catch(e){const t=e instanceof r?e:new r(`Initialization failed: ${e.message}`);throw this.emit({type:"error",data:t}),t}}normalizeInputSchema(e){return!e||Array.isArray(e)||"object"!=typeof e||0===Object.keys(e).length?{type:"object",properties:{},required:[]}:{type:e.type||"object",properties:e.properties||{},required:Array.isArray(e.required)?e.required:[]}}async loadTools(){try{const e=await this.client.listTools();this.tools=e.tools.map(e=>({name:e.name,description:e.description||"",inputSchema:this.normalizeInputSchema(e.inputSchema),annotations:e.annotations||{}})),this.emit({type:"tools_updated",data:this.tools})}catch(e){console.error("Failed to load tools via SDK:",e),this.tools=[]}}async loadResources(){try{const e=await this.client.listResources();this.resources=e.resources.map(e=>({uri:e.uri,name:e.name||"",description:e.description,mimeType:e.mimeType})),this.emit({type:"resources_updated",data:this.resources})}catch(e){console.error("Failed to load resources via SDK:",e),this.resources=[]}}async listTools(){if(!this.connected)throw new r("Not connected to MCP server");return this.tools}async callTool(e,t={}){if(!this.connected)throw new r("Not connected to MCP server");try{const s=await this.client.callTool({name:e,arguments:t});return{content:Array.isArray(s.content)?s.content:[],isError:Boolean(s.isError),meta:s.meta||{}}}catch(t){console.error(`Tool "${e}" call failed:`,t);const s=t instanceof r?t:new r(`Tool call failed: ${t.message}`);throw this.emit({type:"error",data:s}),s}}async listResources(){if(!this.connected)throw new r("Not connected to MCP server");return this.resources}async readResource(e){if(!this.connected)throw new r("Not connected to MCP server");try{return await this.client.readResource({uri:e})}catch(t){console.error(`Resource "${e}" read failed:`,t);const s=t instanceof r?t:new r(`Resource read failed: ${t.message}`);throw this.emit({type:"error",data:s}),s}}async disconnect(){try{this.transport&&(await this.client.close(),this.transport=null),this.connected=!1,this.tools=[],this.resources=[],this.emit({type:"disconnected"})}catch(e){console.error("Error during SDK disconnect:",e)}}isConnected(){return this.connected}getTools(){return[...this.tools]}getResources(){return[...this.resources]}isToolReadOnly(e){const t=this.tools.find(t=>t.name===e);return!t||!0===t.annotations?.readonly||!0===t.annotations?.readOnlyHint}getToolsForOpenAI(){return this.tools.map(e=>{const t=this.normalizeInputSchema(e.inputSchema);return{type:"function",function:{name:e.name,description:e.description||"",parameters:t}}})}};var i=s(3556);const c="gpt-4o-mini";class l extends Error{constructor(e,t=null,s=null){super(e),this.name="OpenAIError",this.status=t,this.code=s}}new class{constructor(e={}){this.configKey=e.configKey||"nfdAIChat",this.apiPath=e.apiPath||"ai",this.mode=e.mode||"help",this.openai=null,this.config=null}getConfig(){if(this.config)return this.config;if("undefined"!=typeof window&&window[this.configKey]){const e=window[this.configKey].homeUrl||window.location.origin;let t=window[this.configKey].restUrl||"/wp-json/";t.includes("/wp-json/")?t=o(t,e):t.includes("rest_route=")||(t=o("/wp-json/",e)),this.config={nonce:window[this.configKey].nonce,restUrl:t,homeUrl:e}}else this.config={nonce:"",restUrl:"",homeUrl:""};return this.config}getOpenAIClient(){if(this.openai)return this.openai;const e=this.getConfig();return this.openai=new i.Ay({apiKey:"proxy",baseURL:`${e.restUrl}${this.apiPath}`,dangerouslyAllowBrowser:!0,defaultHeaders:{"X-WP-Nonce":e.nonce}}),this.openai}async createChatCompletion(e){try{const t=this.getOpenAIClient();return await t.chat.completions.create({model:e.model||c,messages:e.messages,tools:e.tools,tool_choice:e.tool_choice,stream:!1,max_tokens:e.max_tokens,temperature:e.temperature,mode:e.mode||this.mode})}catch(e){throw new l(e.message||"OpenAI API request failed",e.status,e.code)}}async createStreamingCompletion(e,t,s,n){try{const n=this.getOpenAIClient(),a=await n.chat.completions.create({...e,messages:e.messages,stream:!0,stream_options:{include_usage:!0},mode:e.mode||this.mode});let o="",r=null;const i={};let c=null;for await(const e of a){const s=e.choices[0]?.delta;if(s?.reasoning&&t({type:"reasoning",content:s.reasoning}),s?.content&&(o+=s.content,t({type:"content",content:s.content})),s?.tool_calls){for(const e of s.tool_calls){const t=e.index;i[t]||(i[t]={id:e.id||"",type:"function",function:{name:e.function?.name||"",arguments:""}}),e.id&&(i[t].id=e.id),e.function?.name&&(i[t].function.name=e.function.name),e.function?.arguments&&(i[t].function.arguments+=e.function.arguments)}t({type:"tool_calls",tool_calls:Object.values(i)})}e.choices[0]?.finish_reason&&(c=e.choices[0].finish_reason),e.usage&&(r=e.usage,console.log(`[Token Usage] prompt: ${r.prompt_tokens} | completion: ${r.completion_tokens} | total: ${r.total_tokens}`))}if(!r&&a.usage&&(r=a.usage),r&&console.log(`[Token Usage] prompt: ${r.prompt_tokens} | completion: ${r.completion_tokens} | total: ${r.total_tokens}`),c){const e=Object.values(i).map(e=>({id:e.id,name:e.function.name,arguments:e.function.arguments?JSON.parse(e.function.arguments):{}}));await s(o,e.length>0?e:null,r)}}catch(e){n(new l(e.message||"Streaming request failed",e.status,e.code))}}convertMessagesToOpenAI(e){const t=[];for(const a of e){var s;if("system"===a.role||"user"===a.role)t.push({role:a.role,content:null!==(s=a.content)&&void 0!==s?s:""});else if("assistant"===a.role){var n;const e=a.toolCalls&&a.toolCalls.length>0;if((null===a.content||void 0===a.content||""===a.content)&&!e){console.warn("Skipping invalid assistant message with no content and no tool calls");continue}let s=null!==(n=a.content)&&void 0!==n?n:"";e&&s.length>200&&(s=s.substring(0,200)+"...");const o={role:"assistant",content:e?s||null:s};if(e&&(o.tool_calls=a.toolCalls.map(e=>({id:e.id,type:"function",function:{name:e.name,arguments:"string"==typeof e.arguments?e.arguments:JSON.stringify(e.arguments)}}))),t.push(o),e&&a.toolResults&&a.toolResults.length>0)for(const e of a.toolResults)if(a.toolCalls.some(t=>t.id===e.id)){const s=e.error?`Error: ${e.error.substring(0,100)}`:"Success";t.push({role:"tool",content:s,tool_call_id:e.id})}}}return t}convertMCPToolsToOpenAI(e){return e.map(e=>({type:"function",function:{name:e.name,description:e.description,parameters:e.inputSchema}}))}processToolCalls(e){return e.map(e=>({id:e.id,name:e.function.name,arguments:JSON.parse(e.function.arguments||"{}")}))}async sendMessage(e,t=[],s=[]){const n=this.convertMessagesToOpenAI([...t,{id:`user-${Date.now()}`,role:"user",content:e,timestamp:new Date}]),a={model:c,messages:n,tools:s.length>0?this.convertMCPToolsToOpenAI(s):void 0,tool_choice:s.length>0?"auto":void 0,temperature:.1,max_tokens:4e3};try{const e=(await this.createChatCompletion(a)).choices[0];if(!e)throw new l("No response from OpenAI");const t={message:e.message.content||""};return e.message.tool_calls&&(t.toolCalls=this.processToolCalls(e.message.tool_calls)),t}catch(e){if(e instanceof l)throw e;throw new l(`Failed to send message: ${e}`)}}};var u=s(6087);var d=s(7723);const h=()=>{try{return localStorage.getItem("nfd-ai-chat-site-id")||""}catch(e){return""}},p=e=>{const t=h(),s=t?`nfd-ai-chat-${t}-${e}`:`nfd-ai-chat-${e}`;return{history:`${s}-history`,conversationId:`${s}-conversation-id`,sessionId:`${s}-session-id`,archive:`${s}-archive`}},m="processing",g="connecting",f="ws_connecting",_="tool_call",y="working",w="received",v="generating",x="summarizing",b="completed",S="failed";function C(e){var t;return null!==(t={typing_start:m,handoff_request:g,handoff_accept:g,tool_call:_,tool_result:y,typing_stop:null}[e])&&void 0!==t?t:null}const I=e=>{if(!e||"string"!=typeof e)return!1;const t=e.toLowerCase().trim(),s=[/^hello!?\s+how\s+can\s+i\s+assist\s+you/i,/^hi!?\s+how\s+can\s+i\s+help/i,/^hello!?\s+how\s+can\s+i\s+help/i,/^hi\s+there!?\s+how\s+can/i,/^greetings!?\s+how\s+can/i,/^how\s+can\s+i\s+assist\s+you\s+today/i,/^how\s+can\s+i\s+help\s+you\s+today/i,/^hello!?\s+how\s+can\s+i\s+assist\s+you\s+today/i,/^hello!?\s+how\s+can\s+i\s+assist\s+you.*feel\s+free/i].some(e=>e.test(t)),n=t.includes("hello")&&(t.includes("assist")||t.includes("help"))&&(t.includes("today")||t.includes("feel free")||t.includes("ask")),a=t.length<150&&(t.includes("hello")&&(t.includes("assist")||t.includes("help"))||t.includes("hi")&&t.includes("help"));return s||n||a},j=(e,t)=>{const s=e?.trim();return s&&"No content provided"!==s&&"sales_requested"!==s&&"sales_requested"!==s.toLowerCase()?!t&&s.length<150&&I(s)?null:s:null},N=e=>{e.current&&(clearTimeout(e.current),e.current=null)},$=({setIsTyping:e,setStatus:t,setCurrentResponse:s,typingTimeoutRef:n})=>{e(!1),t(null),s(""),N(n)},A=(e,t,s="")=>{e(e=>[...e,{id:`msg-${Date.now()}${s}`,role:"assistant",type:"assistant",content:t,timestamp:new Date,animateTyping:!0}])};var k=s(1455),T=s.n(k);const R=e=>Array.isArray(e)&&e.some(e=>("user"===e.role||"user"===e.type)&&e.content&&String(e.content).trim()),E=(e,t,s)=>{try{const n=localStorage.getItem(e),a=localStorage.getItem(t),o=localStorage.getItem(s);if(n){const e=JSON.parse(n);if(Array.isArray(e)&&e.length>0)return{messages:e.map(e=>({...e,timestamp:e.timestamp?new Date(e.timestamp):new Date,animateTyping:!1})),conversationId:a||null,sessionId:o||null}}}catch(e){console.warn("[AI Chat] Failed to restore chat history from localStorage:",e)}return{messages:[],conversationId:null,sessionId:null}},D=(e,t)=>{try{R(t)?localStorage.setItem(e,JSON.stringify(t)):localStorage.removeItem(e)}catch(e){console.warn("[AI Chat] Failed to save messages to localStorage:",e)}},M=({configEndpoint:e,storageNamespace:t="default",autoConnect:s=!1,consumerType:n="editor_chat",autoLoadHistory:a=!0,getConnectionFailedFallbackMessage:o}={})=>{const r=h(),i=r?`nfd-ai-chat-${r}-${t}`:`nfd-ai-chat-${t}`,c=`${i}-history`,l=`${i}-conversation-id`,p=`${i}-session-id`,[m,g]=(0,u.useState)(()=>a?E(c,l,p).messages:[]),[f,_]=(0,u.useState)(()=>a?E(c,l,p).conversationId:null),[y,w]=(0,u.useState)(!1),[v,x]=(0,u.useState)(!1),[b,S]=(0,u.useState)(null),[k,M]=(0,u.useState)(!1),[O,L]=(0,u.useState)(null),[U,P]=(0,u.useState)(""),[W,F]=(0,u.useState)(null),[q,B]=(0,u.useState)(()=>{try{if("1"===sessionStorage.getItem(`${i}-connection-failed`))return"failed"}catch(e){}return"disconnected"}),[z,H]=(0,u.useState)(0),J=(0,u.useRef)(null),K=(0,u.useRef)(null),G=(0,u.useRef)(0),Y=(0,u.useRef)(null),V=(0,u.useRef)(null),Z=(0,u.useRef)(!1),X=(0,u.useRef)(()=>a?E(c,l,p).sessionId:null);"function"==typeof X.current&&(X.current=X.current());const Q=(0,u.useRef)(!1),ee=(0,u.useRef)(!1),te=(0,u.useRef)(null),se=(0,u.useRef)(!0),ne=(0,u.useRef)([]),ae=(0,u.useRef)(q),oe=(0,u.useRef)(q),re=6e4,ie=(0,u.useCallback)(e=>{X.current=e;try{localStorage.setItem(p,e)}catch(e){console.warn("[AI Chat] Failed to save session ID to localStorage:",e)}},[p]),ce=(0,u.useCallback)(e=>{try{localStorage.setItem(l,e)}catch(e){console.warn("[AI Chat] Failed to save conversation ID to localStorage:",e)}},[l]),le=(0,u.useCallback)(async()=>{if(J.current?.readyState!==WebSocket.OPEN&&J.current?.readyState!==WebSocket.CONNECTING&&!Z.current){try{sessionStorage.removeItem(`${i}-connection-failed`)}catch(e){}Z.current=!0,x(!0),B("connecting"),S(null);try{Y.current||(Y.current=await async function({configEndpoint:e,storageNamespace:t}){try{let s=e;if(e.startsWith("http://")||e.startsWith("https://")){const t=new URL(e);s=t.searchParams.has("rest_route")?t.searchParams.get("rest_route"):t.pathname.includes("/wp-json/")?t.pathname.replace("/wp-json/",""):t.pathname.replace(/^\//,"")}const n=`${s.startsWith("/")?s.slice(1):s}?storage_namespace=${encodeURIComponent(t)}`;return await T()({path:n,parse:!0})}catch(e){console.error("[AI Chat] Failed to fetch config:",e),console.error("[AI Chat] Error details:",{message:e.message,code:e.code,data:e.data,status:e.data?.status,statusText:e.data?.statusText});let t=e.message||(0,d.__)("Failed to connect","wp-module-ai-chat");throw e.data?.message?t=e.data.message:e.message&&"Could not get a valid response from the server."!==e.message&&(t=e.message),"rest_forbidden"===e.code||403===e.data?.status?t=(0,d.__)("Access denied. Please check your capabilities.","wp-module-ai-chat"):"rest_no_route"===e.code||404===e.data?.status?t=(0,d.__)("Config endpoint not found. Please ensure the backend is deployed.","wp-module-ai-chat"):"gateway_url_not_configured"===e.code?t=(0,d.__)("Gateway URL not configured. Set NFD_AGENTS_CHAT_GATEWAY_URL in wp-config.php.","wp-module-ai-chat"):"huapi_token_fetch_failed"===e.code?t=(0,d.__)("Failed to fetch authentication token from Hiive. Check your connection or set NFD_AGENTS_CHAT_DEBUG_TOKEN for local development.","wp-module-ai-chat"):e.data?.status&&(t=(0,d.sprintf)(/* translators: %1$s: HTTP status, %2$s: status text */ /* translators: %1$s: HTTP status, %2$s: status text */
(0,d.__)("Failed to fetch config: %1$s %2$s","wp-module-ai-chat"),e.data.status,e.data.statusText||t)),new Error(t)}}({configEndpoint:e,storageNamespace:t}));const s=Y.current;if(!s)throw new Error((0,d.__)("No configuration available","wp-module-ai-chat"));if(s.site_id){const e=h();e!==s.site_id&&((e=>{try{localStorage.setItem("nfd-ai-chat-site-id",e)}catch(e){}})(s.site_id),((e,t,s)=>{const n=["history","conversation-id","session-id","archive"],a=e?`nfd-ai-chat-${e}-${s}`:`nfd-ai-chat-${s}`,o=`nfd-ai-chat-${t}-${s}`;try{for(const e of n){const t=`${a}-${e}`,s=`${o}-${e}`,n=localStorage.getItem(t);n&&!localStorage.getItem(s)&&localStorage.setItem(s,n),n&&localStorage.removeItem(t)}}catch(e){}})(e,s.site_id,t))}X.current||(X.current=crypto.randomUUID?crypto.randomUUID():`${Date.now()}-${Math.random().toString(36).substring(2,15)}`);const a=((e,t,s)=>{const n=(a=e.gateway_url)&&"string"==typeof a?a.startsWith("http://")?a.replace("http://","ws://"):a.startsWith("https://")?a.replace("https://","wss://"):a.startsWith("ws://")||a.startsWith("wss://")?a:(e=>{if(!e||"string"!=typeof e)return!1;const t=e.toLowerCase();return t.includes("localhost")||t.includes("127.0.0.1")})(a)?`ws://${a}`:`wss://${a}`:a;var a;const o=("nfd-agents"===e.agent_type?"blu":e.agent_type)||"blu",r=`wordpress_${s}`;return`${n}/${e.brand_id}/agents/${o}/v1/ws?session_id=${t}&token=${encodeURIComponent(e.huapi_token)}&consumer=${encodeURIComponent(r)}`})(s,X.current,n),o=new WebSocket(a);J.current=o,o.onopen=()=>{Z.current=!1,w(!0),x(!1),B("connected"),H(0),S(null),G.current=0,Q.current=ne.current&&ne.current.length>0,ee.current=!1,P("")};const r=function(e){const{isStoppedRef:t,hasUserMessageRef:s,typingTimeoutRef:n,typingTimeout:a,setIsTyping:o,setStatus:r,setCurrentResponse:i,setMessages:c,setConversationId:l,setError:u,saveSessionId:d,saveConversationId:h}=e;return function(p){if(!t.current||"session_established"===p.type)if("session_established"!==p.type){if("typing_start"===p.type)return o(!0),r(C("typing_start")),void N(n);if("typing_stop"===p.type)return o(!1),r(null),i(""),void N(n);if("streaming_chunk"===p.type||"chunk"===p.type){if(t.current)return;const e=p.content||p.chunk||p.text||"";return void(e&&i(t=>{const i=t+e;return!s.current&&i.length<100&&I(i)?"":(o(!0),n.current&&clearTimeout(n.current),n.current=setTimeout(()=>{o(!1),r(null),n.current=null},a),i)}))}if("structured_output"===p.type){const t=p.response_content?.content?.human_input_request;if(t&&"APPROVAL_REQUEST"===(t.input_type||t.inputType||"").toUpperCase()){if(p.conversation_id||p.conversationId){const e=p.conversation_id||p.conversationId;l(e),h(e)}return}const n=p.message||p.response_content?.message,a=j(n,s.current);return void(a&&(i(e=>(e&&A(c,e,"-streaming"),"")),A(c,a),$(e)))}if("tool_call"!==p.type){if("tool_result"!==p.type){if("message"===p.type||"complete"===p.type){let t=!1;if(i(e=>{if(e){const n=e.trim();if("No content provided"===n||"sales_requested"===n||"sales_requested"===n.toLowerCase())return"";if(!s.current&&e.length<150&&I(e))return"";c(t=>[...t,{id:`msg-${Date.now()}`,role:"assistant",type:"assistant",content:e,timestamp:new Date,animateTyping:!0}]),t=!0}return""}),!t){const e=p.message||p.response_content?.message,n=j(e,s.current);n&&(A(c,n),t=!0)}return void(t&&$(e))}if("handoff_accept"!==p.type){if("handoff_request"===p.type){r(C("handoff_request"));const t=p.message||p.response_content?.message,n=j(t,s.current);return n?(A(c,n),void $(e)):void i("")}if("error"===p.type)return u(p.message||p.error||"An error occurred"),o(!1),r(null),void i("");if(p.message||p.response_content?.message){const t=p.message||p.response_content?.message,n=j(t,s.current);if(!n)return void i("");A(c,n),$(e)}}else r(C("handoff_accept"))}else if(r(C("tool_result")),p.conversation_id||p.conversationId){const e=p.conversation_id||p.conversationId;l(e),h(e)}}else r(C("tool_call"))}else p.session_id&&d(p.session_id)}}({isStoppedRef:ee,hasUserMessageRef:Q,typingTimeoutRef:te,typingTimeout:re,setIsTyping:M,setStatus:L,setCurrentResponse:P,setMessages:g,setConversationId:_,setError:S,saveSessionId:ie,saveConversationId:ce});o.onmessage=e=>{try{const t=JSON.parse(e.data);r(t)}catch(e){console.error("[AI Chat] Error parsing WebSocket message:",e)}},o.onerror=()=>{Z.current=!1,x(!1),B("failed");try{sessionStorage.setItem(`${i}-connection-failed`,"1")}catch(e){}},o.onclose=e=>{if(Z.current=!1,w(!1),x(!1),M(!1),L(null),J.current===o&&(J.current=null),1e3!==e.code&&G.current<5){G.current++,H(G.current),B("reconnecting");const e=1e3*Math.pow(2,G.current-1);K.current=setTimeout(()=>{le()},e)}else if(G.current>=5){B("failed");try{sessionStorage.setItem(`${i}-connection-failed`,"1")}catch(e){}}else B("disconnected")}}catch(e){Z.current=!1,"undefined"!=typeof console&&console.warn&&console.warn("[AI Chat] Connection failed:",e?.message||e),x(!1),B("failed");try{sessionStorage.setItem(`${i}-connection-failed`,"1")}catch(e){}}}},[e,t,n,ie,ce]);(0,u.useEffect)(()=>{ne.current=m},[m]),(0,u.useEffect)(()=>{ae.current=q},[q]),(0,u.useEffect)(()=>{if("failed"!==q||"failed"===oe.current)return void(oe.current=q);oe.current=q;const e=(0,d.__)("Sorry, we couldn't connect. Please try again later or contact support.","wp-module-ai-chat");g(t=>{const s=t.length>0?t[t.length-1]:null,n=s&&("user"===s.role||"user"===s.type),a="function"==typeof o?o(n?s.content:""):e;return[...t,{id:`msg-${Date.now()}-fallback`,role:"assistant",type:"assistant",content:a,timestamp:new Date}]}),S(null),P(""),M(!1),L(null),te.current&&(clearTimeout(te.current),te.current=null)},[q,o]);const ue=(0,u.useCallback)((e,t=null)=>{if(ee.current=!1,Q.current=!0,("failed"===ae.current||G.current>=5&&(!J.current||J.current.readyState!==WebSocket.OPEN))&&!t){const t={id:`msg-${Date.now()}`,role:"user",type:"user",content:e,timestamp:new Date,sessionId:X.current},s="function"==typeof o?o(e):(0,d.__)("Sorry, we couldn't connect. Please try again later or contact support.","wp-module-ai-chat");return g(e=>[...e,t,{id:`msg-${Date.now()}-fallback`,role:"assistant",type:"assistant",content:s,timestamp:new Date}]),S(null),P(""),M(!1),void L(null)}if(!J.current||J.current.readyState!==WebSocket.OPEN){if(!t){const t={id:`msg-${Date.now()}`,role:"user",type:"user",content:e,timestamp:new Date,sessionId:X.current};g(e=>[...e,t])}return void("disconnected"===ae.current&&le())}if(!t){const t={id:`msg-${Date.now()}`,role:"user",type:"user",content:e,timestamp:new Date,sessionId:X.current};g(e=>[...e,t]),P(""),M(!0),te.current&&clearTimeout(te.current),te.current=setTimeout(()=>{M(!1),L(null),te.current=null},re)}const s={type:"chat",message:e};t?s.conversationId=t:f&&(s.conversationId=f),J.current.send(JSON.stringify(s))},[f,o]),de=(0,u.useCallback)(e=>{if(!J.current||J.current.readyState!==WebSocket.OPEN)return void console.warn("[AI Chat] Cannot send system message - not connected");const t={type:"chat",message:e};f&&(t.conversationId=f),M(!0),P(""),te.current&&clearTimeout(te.current),te.current=setTimeout(()=>{M(!1),L(null),te.current=null},re),J.current.send(JSON.stringify(t))},[f,le]),he=(0,u.useCallback)(()=>{K.current&&clearTimeout(K.current),te.current&&(clearTimeout(te.current),te.current=null),J.current&&(J.current.close(1e3,"User disconnected"),J.current=null),w(!1),x(!1),B("disconnected")},[]),pe=(0,u.useCallback)(e=>{X.current=null!=e?e:null},[]),me=(0,u.useCallback)(()=>{var e;return null!==(e=X.current)&&void 0!==e?e:null},[]),ge=(0,u.useCallback)((e,t,s)=>{if(Array.isArray(e)){const t=e.map(e=>({...e,timestamp:e.timestamp?new Date(e.timestamp):new Date,animateTyping:!1}));g(t)}if(_(null!=t?t:null),X.current=null!=s?s:null,S(null),M(!1),L(null),P(""),null!=s&&J.current?.readyState===WebSocket.OPEN){try{localStorage.setItem(p,s),null!=t&&localStorage.setItem(l,t)}catch(e){console.warn("[AI Chat] Failed to persist session for history load:",e)}he(),le()}},[le,he,p,l]),fe=(0,u.useCallback)(()=>{ee.current=!0,M(!1),L(null),P(""),te.current&&(clearTimeout(te.current),te.current=null)},[]),_e=(0,u.useCallback)(()=>{F(null)},[]),ye=(0,u.useCallback)(()=>{M(!1),L(null),te.current&&(clearTimeout(te.current),te.current=null)},[]),we=(0,u.useCallback)(e=>{let t;if(null==e)t=(0,d.__)("No content provided.","wp-module-ai-chat");else if("object"==typeof e)try{t=JSON.stringify(e,null,2)}catch(s){console.warn("[useNfdAgentsWebSocket] Failed to stringify content object:",s),t=String(e)}else t=String(e);g(e=>[...e,{id:`msg-${Date.now()}`,role:"assistant",type:"assistant",content:t,timestamp:new Date}]),M(!1),L(null),te.current&&(clearTimeout(te.current),te.current=null)},[]),ve=(0,u.useCallback)((e,t)=>{g(s=>s.map(s=>("function"==typeof e?e(s):s.id===e)?t(s):s))},[]),xe=(0,u.useCallback)(()=>{try{((e,t,s)=>{try{localStorage.removeItem(e),localStorage.removeItem(t),localStorage.removeItem(s)}catch(e){console.warn("[AI Chat] Failed to clear chat storage:",e)}})(c,l,p),g([]),_(null),F(null),M(!1),L(null),P(""),S(null),X.current=null,J.current&&(J.current.close(),J.current=null,w(!1)),Q.current=!1,ee.current=!1,te.current&&(clearTimeout(te.current),te.current=null),K.current&&(clearTimeout(K.current),K.current=null),G.current=0}catch(e){console.warn("[AI Chat] Failed to clear chat history:",e)}},[c,l,p]),be=(0,u.useCallback)(()=>{G.current=0,H(0),S(null),le()},[le]);return(0,u.useEffect)(()=>{const e=V.current;if(null===e)return V.current=s,void(s&&"failed"!==q&&!Z.current&&(!J.current||J.current.readyState!==WebSocket.OPEN&&J.current.readyState!==WebSocket.CONNECTING)&&le());e!==s&&(V.current=s,s?Z.current||J.current&&(J.current.readyState===WebSocket.OPEN||J.current.readyState===WebSocket.CONNECTING)||le():he())},[s,q]),(0,u.useEffect)(()=>{if(se.current)return se.current=!1,void(m.length>0&&R(m)&&D(c,m));D(c,m)},[m,c]),(0,u.useEffect)(()=>{((e,t)=>{try{t?localStorage.setItem(e,t):localStorage.removeItem(e)}catch(e){console.warn("[AI Chat] Failed to save conversation ID to localStorage:",e)}})(l,f)},[f,l]),{messages:m,setMessages:g,setConversationId:_,setSessionId:pe,loadConversation:ge,getSessionId:me,sendMessage:ue,sendSystemMessage:de,isConnected:y,isConnecting:v,error:b,isTyping:k,status:O,currentResponse:U,approvalRequest:W,conversationId:f,clearApprovalRequest:_e,clearTyping:ye,addAssistantMessage:we,updateMessage:ve,connect:le,disconnect:he,stopRequest:fe,clearChatHistory:xe,brandId:Y.current?.brand_id||null,connectionState:q,retryAttempt:z,maxRetries:5,manualRetry:be}};function O(e){return e&&"string"==typeof e?e.replace(/(https?:\/\/[^\s<>"]*(?:\n[^\s<>"]*)*)/g,e=>{let t=e.replace(/\s+/g,"").trim().replace(/[.,;:!?)\]]+$/,"");const s=t.match(/\/(If|It|To|We|So|Or|In|On|At|By|Do|Be|As|An|The|You)$/i),n=s?s[1]:"";return n&&(t=t.replace(/\/(If|It|To|We|So|Or|In|On|At|By|Do|Be|As|An|The|You)$/i,"")),t?`<a href="${t.replace(/"/g,"&quot;")}" target="_blank" rel="noopener noreferrer">${t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}</a>${n?" "+n:""}`:e}):""}var L=s(325);const U=e=>L.A.sanitize(e,{ALLOWED_TAGS:["section","div","h1","h2","h3","h4","h5","h6","p","span","strong","em","b","i","u","s","mark","small","sub","sup","a","br","ul","ol","li","dl","dt","dd","blockquote","code","pre","table","thead","tbody","tr","th","td","hr","address","time"],ALLOWED_ATTR:["style","class","id","href","datetime","target","rel"],ALLOW_DATA_ATTR:!1,FORBID_TAGS:["script","object","embed","iframe","form","fieldset","legend","label","input","textarea","select","option","button","details","summary","progress","meter"],FORBID_ATTR:["onerror","onload","onclick","onmouseover","onfocus","onblur"]});var P=s(5243),W=s(7640),F=s(3152),q=s(4648),B=s(435),z=s.n(B),H=s(790);const J=e=>({"blu/get-global-styles":{title:(0,d.__)("Reading Site Colors","wp-module-ai-chat")},"blu-get-global-styles":{title:(0,d.__)("Reading Site Colors","wp-module-ai-chat")},"blu/get-active-global-styles":{title:(0,d.__)("Reading Active Styles","wp-module-ai-chat")},"blu-get-active-global-styles":{title:(0,d.__)("Reading Active Styles","wp-module-ai-chat")},"blu/get-active-global-styles-id":{title:(0,d.__)("Getting Styles ID","wp-module-ai-chat")},"blu-get-active-global-styles-id":{title:(0,d.__)("Getting Styles ID","wp-module-ai-chat")},"blu/update-global-styles":{title:(0,d.__)("Updating Site Styles","wp-module-ai-chat")},"blu-update-global-styles":{title:(0,d.__)("Updating Site Styles","wp-module-ai-chat")},"blu/update-global-palette":{title:(0,d.__)("Updating Site Colors","wp-module-ai-chat")},"blu-update-global-palette":{title:(0,d.__)("Updating Site Colors","wp-module-ai-chat")},"blu/edit-block":{title:(0,d.__)("Editing Block Content","wp-module-ai-chat")},"blu-edit-block":{title:(0,d.__)("Editing Block Content","wp-module-ai-chat")},"blu/add-section":{title:(0,d.__)("Adding New Section","wp-module-ai-chat")},"blu-add-section":{title:(0,d.__)("Adding New Section","wp-module-ai-chat")},"blu/delete-block":{title:(0,d.__)("Removing Block","wp-module-ai-chat")},"blu-delete-block":{title:(0,d.__)("Removing Block","wp-module-ai-chat")},"blu/move-block":{title:(0,d.__)("Moving Block","wp-module-ai-chat")},"blu-move-block":{title:(0,d.__)("Moving Block","wp-module-ai-chat")}}[e]||{title:e?.replace(/[-_\/]/g," ").replace(/\b\w/g,e=>e.toUpperCase())||(0,d.__)("Action","wp-module-ai-chat")}),K=({tool:e,isError:t,result:s})=>{const n=((e,t={})=>{if("mcp-adapter-execute-ability"===e){const e=t?.ability_name||"unknown",s=J(e);let n=null;if(("blu/update-global-palette"===e||"blu/update-global-styles"===e)&&t?.parameters?.colors){const e=t.parameters.colors.length;n=`${e} color${1!==e?"s":""}`}return{...s,params:n}}return J(e)})(e.name,e.arguments),a=((e,t)=>{if(!e||e.isError)return s=e?.error,null==s?null:"string"==typeof s?s:"number"==typeof s||"boolean"==typeof s?String(s):null;var s;try{let s=e.result;if(Array.isArray(s)&&s.length>0&&s[0].text?s=JSON.parse(s[0].text):"string"==typeof s&&(s=JSON.parse(s)),!s||"object"!=typeof s)return null;if(t?.includes("update")){if(s.updatedColors&&Array.isArray(s.updatedColors)){const e=s.updatedColors;return e.length<=3?e.map(e=>`${e.name||e.slug}: ${e.color}`).join(", "):`${e.length} colors updated`}if(s.message&&"string"==typeof s.message)return s.message}if(t?.includes("edit-block")||t?.includes("edit_block"))return s.message&&"string"==typeof s.message?s.message:s.success?"Block updated":"Update failed";if(t?.includes("add-section")||t?.includes("add_section"))return s.message&&"string"==typeof s.message?s.message:s.success?"Section added":"Add failed";if(t?.includes("delete-block")||t?.includes("delete_block"))return s.message&&"string"==typeof s.message?s.message:s.success?"Block removed":"Delete failed";if(t?.includes("move-block")||t?.includes("move_block"))return s.message&&"string"==typeof s.message?s.message:s.success?"Block moved":"Move failed";if(t?.includes("get")||t?.includes("read")){if(s.color?.palette){const e=s.color.palette,t=e.custom?.length||0,n=e.theme?.length||0;if(t||n)return`Found ${t+n} colors`}if(s.typography){const e=s.typography.fontFamilies?.length||0,t=s.typography.fontSizes?.length||0,n=[];if(e&&n.push(`${e} font families`),t&&n.push(`${t} sizes`),n.length)return n.join(", ")}if(s.message&&"string"==typeof s.message)return s.message}return s.id&&t?.includes("id")?`ID: ${s.id}`:null}catch{return null}})(s,e.name);return(0,H.jsxs)("div",{className:z()("nfd-ai-chat-tool-execution__item",{"nfd-ai-chat-tool-execution__item--complete":!t,"nfd-ai-chat-tool-execution__item--error":t}),children:[(0,H.jsxs)("div",{className:"nfd-ai-chat-tool-execution__item-header",children:[t?(0,H.jsx)(P.A,{className:"nfd-ai-chat-tool-execution__icon nfd-ai-chat-tool-execution__icon--error",size:12}):(0,H.jsx)(W.A,{className:"nfd-ai-chat-tool-execution__icon nfd-ai-chat-tool-execution__icon--success",size:12}),(0,H.jsx)("span",{className:"nfd-ai-chat-tool-execution__item-title",children:n.title}),n.params&&(0,H.jsx)("span",{className:"nfd-ai-chat-tool-execution__item-params",children:n.params})]}),a&&(0,H.jsx)("div",{className:"nfd-ai-chat-tool-execution__item-summary",children:a})]})},G=({executedTools:e=[],toolResults:t=[]})=>{const[s,n]=(0,u.useState)(!1);if(!e||0===e.length)return null;const a=new Map;t&&Array.isArray(t)&&t.forEach(e=>{e.id&&a.set(e.id,e)});const o=e.some(e=>e.isError),r=e.length;return(0,H.jsxs)("div",{className:z()("nfd-ai-chat-tool-execution",{"nfd-ai-chat-tool-execution--collapsed":!s}),children:[(0,H.jsxs)("button",{type:"button",className:"nfd-ai-chat-tool-execution__header",onClick:()=>n(!s),"aria-expanded":s?"true":"false",children:[s?(0,H.jsx)(F.A,{className:"nfd-ai-chat-tool-execution__chevron",size:12}):(0,H.jsx)(q.A,{className:"nfd-ai-chat-tool-execution__chevron",size:12}),(0,H.jsx)("span",{children:o?(0,d.__)("Some actions failed","wp-module-ai-chat"):(0,d.__)("Actions completed","wp-module-ai-chat")}),(0,H.jsxs)("span",{className:"nfd-ai-chat-tool-execution__header-count",children:["(",r,")"]})]}),s&&(0,H.jsx)("div",{className:"nfd-ai-chat-tool-execution__list",children:e.map((e,t)=>(0,H.jsx)(K,{tool:e,isError:e.isError,result:a.get(e.id)},e.id||`tool-${t}`))})]})},Y=({message:e,type:t="assistant",animateTyping:s=!1,onContentGrow:n,executedTools:a=[],onExecuteTool:o,onSendMessage:r,onSendSystemMessage:i,conversationId:c,onClearTyping:l,brandId:d,toolResults:h=[]})=>{const p="approval_request"===t?"assistant":t,m="user"===p,g=(e||"").length,[f,_]=(0,u.useState)(()=>s?0:g);(0,u.useEffect)(()=>{if(!s)return void _(g);const e=setInterval(()=>{_(e=>e>=g?e:Math.min(e+2,g))},35);return()=>clearInterval(e)},[s,g]);const y=(0,u.useRef)(0);(0,u.useEffect)(()=>{if(!n||!s||0===f)return;const e=Date.now();e-y.current<80||(y.current=e,n())},[f,s,n]);const w=s?(e||"").slice(0,f):e||"",{content:v,isRichContent:x}=(0,u.useMemo)(()=>{if(!w)return{content:"",isRichContent:!1};const e=(t=w)&&"string"==typeof t?t.replace(/\\"/g,'"').replace(/\\'/g,"'"):t;var t;if(m)return{content:e,isRichContent:!1};if((e=>/<[a-z][\s\S]*>/i.test(e))(e))return{content:U(e),isRichContent:!0};if(function(e){return!(!e||"string"!=typeof e)&&[/^#{1,6}\s/m,/\*\*[^*]+\*\*/,/\*[^*]+\*/,/__[^_]+__/,/_[^_]+_/,/`[^`]+`/,/```[\s\S]*?```/,/^\s*[-*+]\s/m,/^\s*\d+\.\s/m,/\[([^\]]+)\]\(([^)]+)\)/].some(t=>t.test(e))}(e)){const t=function(e){if(!e||"string"!=typeof e)return"";let t=e;t=t.replace(/&(?![\w#]+;)/g,"&amp;").replace(/<(?![a-zA-Z/])/g,"&lt;").replace(/(?<![a-zA-Z"])>/g,"&gt;"),t=t.replace(/```(\w*)\n?([\s\S]*?)```/g,(e,t,s)=>`<pre><code class="language-${t||"plaintext"}">${s.trim().replace(/</g,"&lt;").replace(/>/g,"&gt;")}</code></pre>`),t=t.replace(/`([^`]+)`/g,'<code class="inline-code">$1</code>'),t=t.replace(/^######\s+(.+)$/gm,'<h6 class="chat-h6">$1</h6>'),t=t.replace(/^#####\s+(.+)$/gm,'<h5 class="chat-h5">$1</h5>'),t=t.replace(/^####\s+(.+)$/gm,'<h4 class="chat-h4">$1</h4>'),t=t.replace(/^###\s+(.+)$/gm,'<h3 class="chat-h3">$1</h3>'),t=t.replace(/^##\s+(.+)$/gm,'<h2 class="chat-h2">$1</h2>'),t=t.replace(/^#\s+(.+)$/gm,'<h1 class="chat-h1">$1</h1>'),t=t.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),t=t.replace(/__([^_]+)__/g,"<strong>$1</strong>"),t=t.replace(/(?<![*_])\*(?!\*)([^*\n]+)(?<!\*)\*(?!\*)/g,"<em>$1</em>"),t=t.replace(/(?<![_*])_(?!_)([^_\n]+)(?<!_)_(?!_)/g,"<em>$1</em>"),t=t.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'),t=t.replace(/^(\s*)[-*+]\s+(.+)$/gm,(e,t,s)=>`<li class="chat-li" data-level="${Math.floor(t.length/2)}">${s}</li>`),t=t.replace(/((?:<li[^>]*>.*?<\/li>\s*)+)/g,e=>`<ul class="chat-ul">${e.replace(/(<\/li>)\s+(<li)/g,"$1$2")}</ul>`),t=t.replace(/^(\s*)\d+\.\s+(.+)$/gm,(e,t,s)=>`<oli class="chat-oli" data-level="${Math.floor(t.length/2)}">${s}</oli>`),t=t.replace(/((?:<oli[^>]*>.*?<\/oli>\s*)+)/g,e=>`<ol class="chat-ol">${e.replace(/(<\/oli>)\s+(<oli)/g,"$1$2").replace(/<\/?oli/g,e=>e.replace("oli","li"))}</ol>`),t=t.replace(/^---+$/gm,'<hr class="chat-hr" />'),t=t.replace(/^>\s+(.+)$/gm,'<blockquote class="chat-blockquote">$1</blockquote>');const s=t.split(/\n\n+/);return t=s.map(e=>{const t=e.trim();return t.startsWith("<h")||t.startsWith("<ul")||t.startsWith("<ol")||t.startsWith("<pre")||t.startsWith("<blockquote")||t.startsWith("<hr")||t.startsWith("<p")?t:t?`<p class="chat-p">${t}</p>`:""}).filter(Boolean).join(""),t=t.replace(/<p([^>]*)>([\s\S]*?)<\/p>/g,(e,t,s)=>`<p${t}>${s.trim().replace(/\n/g,"<br>")}</p>`),t=t.replace(/<br\s*\/?>\s*(<\/?(ul|ol|li|p|h[1-6]|pre|blockquote|hr))/gi,"$1"),t=t.replace(/(<\/(ul|ol|li|p|h[1-6]|pre|blockquote)>)\s*<br\s*\/?>/gi,"$1"),t=t.replace(/<p[^>]*>\s*<\/p>/g,""),t=t.replace(/(<br\s*\/?>){2,}/g,"<br>"),t=function(e){return e&&"string"==typeof e?e.replace(/>([^<]*)</g,(e,t)=>">"+O(t)+"<"):""}(t),t}(e);return{content:U(t),isRichContent:!0}}const s=O(e);if(s!==e){const e=s.replace(/\n/g,"<br>");return{content:U(e),isRichContent:!0}}return{content:e,isRichContent:!1}},[w,m]);return v||a&&0!==a.length?(0,H.jsxs)("div",{className:`nfd-ai-chat-message nfd-ai-chat-message--${p}`,children:[v&&(x?(0,H.jsx)("div",{className:"nfd-ai-chat-message__content nfd-ai-chat-message__content--rich",dangerouslySetInnerHTML:{__html:v}}):(0,H.jsx)("div",{className:"nfd-ai-chat-message__content nfd-ai-chat-message__content--pre-wrap",style:{whiteSpace:"pre-wrap"},children:v})),a&&a.length>0&&(0,H.jsx)(G,{executedTools:a,toolResults:h})]}):null},V=({message:e,className:t=""})=>(0,H.jsxs)("div",{className:`nfd-ai-chat-error-alert ${t}`,children:[(0,H.jsx)("div",{className:"nfd-ai-chat-error-alert__icon",children:(0,H.jsx)(P.A,{width:16,height:16})}),(0,H.jsx)("div",{className:"nfd-ai-chat-error-alert__content",children:(0,H.jsx)("div",{className:"nfd-ai-chat-error-alert__message",children:e})})]});var Z=s(2074),X=s(1045);const Q=e=>{const t={"nfd-agents/get-global-styles":{title:(0,d.__)("Reading Site Colors","wp-module-ai-chat"),description:(0,d.__)("Fetching current color palette and typography settings","wp-module-ai-chat")},"nfd-agents/update-global-palette":{title:(0,d.__)("Updating Site Colors","wp-module-ai-chat"),description:(0,d.__)("Applying new colors to global styles","wp-module-ai-chat")},"newfold-agents/get-global-styles":{title:(0,d.__)("Reading Site Colors","wp-module-ai-chat"),description:(0,d.__)("Fetching current color palette and typography settings","wp-module-ai-chat")},"newfold-agents/update-global-palette":{title:(0,d.__)("Updating Site Colors","wp-module-ai-chat"),description:(0,d.__)("Applying new colors to global styles","wp-module-ai-chat")},"blu/get-global-styles":{title:(0,d.__)("Reading Site Colors","wp-module-ai-chat"),description:(0,d.__)("Fetching current color palette and typography settings","wp-module-ai-chat")},"blu/update-global-palette":{title:(0,d.__)("Updating Site Colors","wp-module-ai-chat"),description:(0,d.__)("Applying new colors to global styles","wp-module-ai-chat")},"mcp-adapter-discover-abilities":{title:(0,d.__)("Discovering Actions","wp-module-ai-chat"),description:(0,d.__)("Finding available WordPress abilities","wp-module-ai-chat")},"mcp-adapter-get-ability-info":{title:(0,d.__)("Getting Ability Info","wp-module-ai-chat"),description:(0,d.__)("Fetching ability details","wp-module-ai-chat")},"mcp-adapter-execute-ability":{title:(0,d.__)("Executing Action","wp-module-ai-chat"),description:(0,d.__)("Running WordPress ability","wp-module-ai-chat")}};return t[e]?t[e]:"preparing-changes"===e?{title:(0,d.__)("Preparing changes","wp-module-ai-chat"),description:(0,d.__)("Building block markup","wp-module-ai-chat")}:{title:e?.replace(/[-_\/]/g," ").replace(/\b\w/g,e=>e.toUpperCase())||(0,d.__)("Executing","wp-module-ai-chat"),description:(0,d.__)("Running action","wp-module-ai-chat")}},ee=({tool:e,isActive:t,progress:s,isComplete:n,isError:a})=>{const o=((e,t={})=>{if("mcp-adapter-execute-ability"===e){const e=t?.ability_name||"unknown",s=Q(e);let n=null;if(("nfd-agents/update-global-palette"===e||"newfold-agents/update-global-palette"===e||"blu/update-global-palette"===e)&&t?.parameters?.colors){const e=t.parameters.colors.length;n=`${e} color${1!==e?"s":""}`}return{...s,params:n}}return Q(e)})(e.name,e.arguments);return(0,H.jsxs)("div",{className:z()("nfd-ai-chat-tool-execution__item",{"nfd-ai-chat-tool-execution__item--active":t,"nfd-ai-chat-tool-execution__item--complete":n,"nfd-ai-chat-tool-execution__item--error":a}),children:[(0,H.jsxs)("div",{className:"nfd-ai-chat-tool-execution__item-header",children:[a?(0,H.jsx)(P.A,{className:"nfd-ai-chat-tool-execution__icon nfd-ai-chat-tool-execution__icon--error",size:12}):n?(0,H.jsx)(W.A,{className:"nfd-ai-chat-tool-execution__icon nfd-ai-chat-tool-execution__icon--success",size:12}):t?(0,H.jsx)(Z.A,{className:"nfd-ai-chat-tool-execution__icon nfd-ai-chat-tool-execution__icon--active",size:12}):(0,H.jsx)(X.A,{className:"nfd-ai-chat-tool-execution__icon nfd-ai-chat-tool-execution__icon--pending",size:12}),(0,H.jsx)("span",{className:"nfd-ai-chat-tool-execution__item-title",children:o.title}),o.params&&(0,H.jsx)("span",{className:"nfd-ai-chat-tool-execution__item-params",children:o.params})]}),t&&s&&(0,H.jsx)("div",{className:"nfd-ai-chat-tool-execution__item-progress",children:s})]})},te=({status:e=null,activeToolCall:t=null,toolProgress:s=null,executedTools:n=[],pendingTools:a=[]})=>{const[o,r]=(0,u.useState)(!0),i=!!t,c=!i&&"summarizing"===e&&n.length>0;(0,u.useEffect)(()=>{(i||c)&&r(!0)},[i,c]);const l={[m]:(0,d.__)("Processing…","wp-module-ai-chat"),[g]:(0,d.__)("Getting your site ready…","wp-module-ai-chat"),[f]:(0,d.__)("Connecting…","wp-module-ai-chat"),[_]:(0,d.__)("Looking this up…","wp-module-ai-chat"),[y]:(0,d.__)("Almost there…","wp-module-ai-chat"),[w]:(0,d.__)("Message received","wp-module-ai-chat"),[v]:(0,d.__)("Thinking…","wp-module-ai-chat"),[x]:(0,d.__)("Summarizing results","wp-module-ai-chat"),[b]:(0,d.__)("Processing","wp-module-ai-chat"),[S]:(0,d.__)("Error occurred","wp-module-ai-chat")},h=t||n.length>0||a.length>0,p=n.length+(t?1:0)+a.length;return h?(0,H.jsx)("div",{className:"nfd-ai-chat-message nfd-ai-chat-message--assistant",children:(0,H.jsx)("div",{className:"nfd-ai-chat-message__content",children:(0,H.jsxs)("div",{className:z()("nfd-ai-chat-tool-execution",{"nfd-ai-chat-tool-execution--collapsed":!o}),children:[(0,H.jsxs)("button",{type:"button",className:"nfd-ai-chat-tool-execution__header",onClick:()=>r(!o),"aria-expanded":o?"true":"false",children:[o?(0,H.jsx)(F.A,{className:"nfd-ai-chat-tool-execution__chevron",size:12}):(0,H.jsx)(q.A,{className:"nfd-ai-chat-tool-execution__chevron",size:12}),i?(0,H.jsxs)(H.Fragment,{children:[(0,H.jsx)("span",{children:(0,d.__)("Executing actions","wp-module-ai-chat")}),t.total>1&&(0,H.jsxs)("span",{className:"nfd-ai-chat-tool-execution__header-count",children:["(",t.index,"/",t.total,")"]})]}):c?(0,H.jsxs)(H.Fragment,{children:[(0,H.jsx)(Z.A,{className:"nfd-ai-chat-tool-execution__icon nfd-ai-chat-tool-execution__icon--active",size:12}),(0,H.jsx)("span",{children:(0,d.__)("Processing","wp-module-ai-chat")}),(0,H.jsxs)("span",{className:"nfd-ai-chat-tool-execution__header-count",children:["(",n.length,")"]})]}):(0,H.jsxs)(H.Fragment,{children:[(0,H.jsx)("span",{children:(0,d.__)("Actions completed","wp-module-ai-chat")}),(0,H.jsxs)("span",{className:"nfd-ai-chat-tool-execution__header-count",children:["(",p,")"]})]})]}),o&&(0,H.jsxs)("div",{className:"nfd-ai-chat-tool-execution__list",children:[n.map((e,t)=>(0,H.jsx)(ee,{tool:e,isActive:!1,isComplete:!e.isError,isError:e.isError,progress:null},e.id||`executed-${t}`)),t&&(0,H.jsx)(ee,{tool:t,isActive:!0,isComplete:!1,isError:!1,progress:s},t.id||"active"),c&&(0,H.jsx)(ee,{tool:{name:"preparing-changes"},isActive:!0,isComplete:!1,isError:!1,progress:null},"preparing"),a.map((e,t)=>(0,H.jsx)(ee,{tool:e,isActive:!1,isComplete:!1,isError:!1,progress:null},e.id||`pending-${t}`))]})]})})}):(0,H.jsx)("div",{className:"nfd-ai-chat-message nfd-ai-chat-message--assistant",children:(0,H.jsx)("div",{className:"nfd-ai-chat-message__content",children:(0,H.jsxs)("div",{className:"nfd-ai-chat-typing-indicator",children:[(0,H.jsxs)("span",{className:"nfd-ai-chat-typing-indicator__dots","aria-hidden":"true",children:[(0,H.jsx)("span",{}),(0,H.jsx)("span",{}),(0,H.jsx)("span",{})]}),(0,H.jsx)("span",{className:"nfd-ai-chat-typing-indicator__text",children:null!==(C=l[e])&&void 0!==C?C:(0,d.__)("Thinking…","wp-module-ai-chat")})]})})});var C},se=({messages:e=[],isLoading:t=!1,error:s=null,status:n=null,activeToolCall:a=null,toolProgress:o=null,executedTools:r=[],pendingTools:i=[],onApprove:c,onReject:l,onExecuteTool:h,onSendMessage:p,onSendSystemMessage:m,conversationId:g,onClearTyping:f,onRetry:_,connectionFailed:y=!1,brandId:w})=>{const v=(0,u.useRef)(null),[x,b]=(0,u.useState)(0),S=(0,u.useCallback)(()=>{const e=v.current;e&&e.scrollTo({top:e.scrollHeight-e.clientHeight,behavior:"smooth"})},[]);(0,u.useEffect)(()=>{S()},[e,t,o,x,S]);const C=(0,u.useCallback)(()=>{b(e=>e+1)},[]),I=a||r.length>0||i.length>0;return(0,H.jsxs)("div",{ref:v,className:"nfd-ai-chat-messages",children:[e.length>0&&e.map((t,s)=>{const n=s===e.length-1&&("assistant"===t.type||"assistant"===t.role);return(0,H.jsx)(Y,{message:t.content,type:t.type,animateTyping:n&&!0===t.animateTyping,onContentGrow:n?C:void 0,executedTools:t.executedTools,approvalRequest:t.approvalRequest,onApprove:c,onReject:l,onExecuteTool:h,onSendMessage:p,onSendSystemMessage:m,conversationId:g,onClearTyping:f,brandId:w,toolResults:t.toolResults},t.id||s)}),s&&(0,H.jsx)(V,{message:s}),_&&(s||y)&&(0,H.jsx)("p",{className:"nfd-ai-chat-messages__retry",children:(0,H.jsx)("button",{type:"button",className:"nfd-ai-chat-messages__retry-button",onClick:_,children:(0,d.__)("Retry","wp-module-ai-chat")})}),t&&(0,H.jsx)(te,{status:n,activeToolCall:a,toolProgress:o,executedTools:I?r:[],pendingTools:i})]})};var ne=s(6427),ae=s(5963),oe=s(9947);const re=({onSendMessage:e,onStopRequest:t,disabled:s=!1,showStopButton:n,placeholder:a,contextComponent:o=null,showTopBorder:r=!0})=>{const i=null!=n?n:s,[c,l]=(0,u.useState)(""),[h,p]=(0,u.useState)(!1),m=(0,u.useRef)(null),g=(0,u.useRef)(null),f=(0,d.__)("How can I help you today?","wp-module-ai-chat");(0,u.useEffect)(()=>{if(m.current){m.current.style.height="auto";const e=m.current.scrollHeight,t=Math.min(e,200);m.current.style.height=`${t}px`,m.current.style.overflowY=e>200?"auto":"hidden"}},[c]),(0,u.useEffect)(()=>{!s&&m.current&&setTimeout(()=>{m.current.focus()},100)},[s]);const _=()=>{c.trim()&&!s&&(e(c),l(""),m.current&&(m.current.style.height="auto",m.current.style.overflowY="hidden",m.current.focus()))},y=["nfd-ai-chat-input",!r&&"nfd-ai-chat-input--no-top-border"].filter(Boolean).join(" ");return(0,H.jsxs)("div",{className:y,children:[(0,H.jsxs)("div",{className:"nfd-ai-chat-input__container",children:[(0,H.jsx)("textarea",{name:"nfd-ai-chat-input",ref:m,value:c,onChange:e=>l(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),_())},placeholder:a||f,className:"nfd-ai-chat-input__textarea",rows:1,disabled:s}),(0,H.jsxs)("div",{className:"nfd-ai-chat-input__actions",children:[o,i?(0,H.jsx)(ne.Button,{ref:g,icon:(0,H.jsx)(ae.A,{width:16,height:16}),label:(0,d.__)("Stop generating","wp-module-ai-chat"),onClick:()=>{h||(p(!0),t&&t(),setTimeout(()=>{p(!1)},500))},className:"nfd-ai-chat-input__stop",disabled:h,"aria-busy":h}):(0,H.jsx)(ne.Button,{icon:(0,H.jsx)(oe.A,{width:16,height:16}),label:(0,d.__)("Send message","wp-module-ai-chat"),onClick:_,className:"nfd-ai-chat-input__submit",disabled:!c.trim()})]})]}),(0,H.jsx)("div",{className:"nfd-ai-chat-input__disclaimer",children:(0,d.__)("AI-generated content is not guaranteed for accuracy.","wp-module-ai-chat")})]})},ie=()=>(0,H.jsx)("span",{className:"nfd-ai-chat-blu-beta-badge",children:(0,d.__)("BETA","wp-module-ai-chat")}),ce=({title:e,badge:t,logo:s,leftActions:n,rightActions:a,className:o=""})=>(0,H.jsxs)("div",{className:`nfd-ai-chat-header ${o}`.trim(),role:"banner",children:[(0,H.jsxs)("div",{className:"nfd-ai-chat-header__brand",children:[s,null!=e&&(0,H.jsx)("span",{className:"nfd-ai-chat-header__title",children:e}),t]}),(n||a)&&(0,H.jsxs)("div",{className:"nfd-ai-chat-header__actions",children:[n,a]})]}),le=e=>(0,H.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true",focusable:"false",...e,children:[(0,H.jsx)("path",{d:"m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"}),(0,H.jsx)("path",{d:"M5 3v4"}),(0,H.jsx)("path",{d:"M19 17v4"}),(0,H.jsx)("path",{d:"M3 5h4"}),(0,H.jsx)("path",{d:"M17 19h4"})]}),ue=e=>(0,H.jsx)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",focusable:"false",...e,children:(0,H.jsx)("path",{d:"M18 6L6 18M6 6l12 12",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})}),de=({title:e,onNewChat:t,onClose:s,extraActions:n,newChatDisabled:a=!1})=>(0,H.jsx)(ce,{logo:(0,H.jsx)(le,{width:20,height:20}),title:e||(0,d.__)("Blu Chat","wp-module-ai-chat"),badge:(0,H.jsx)(ie,{}),rightActions:(0,H.jsxs)(H.Fragment,{children:["function"==typeof t&&(0,H.jsx)("button",{type:"button",className:"nfd-ai-chat-header__btn nfd-ai-chat-header__btn--new",onClick:a?void 0:t,disabled:a,"aria-label":(0,d.__)("New chat","wp-module-ai-chat"),title:(0,d.__)("New chat","wp-module-ai-chat"),children:"+"}),n,"function"==typeof s&&(0,H.jsx)("button",{type:"button",className:"nfd-ai-chat-header__btn nfd-ai-chat-header__btn--close",onClick:s,"aria-label":(0,d.__)("Close","wp-module-ai-chat"),title:(0,d.__)("Close","wp-module-ai-chat"),children:(0,H.jsx)(ue,{})})]})}),he=({width:e=24,height:t=24,...s})=>(0,H.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 30 30",width:e,height:t,...s,children:[(0,H.jsx)("path",{d:"M14.217,19.707l-1.112,2.547c-0.427,0.979-1.782,0.979-2.21,0l-1.112-2.547c-0.99-2.267-2.771-4.071-4.993-5.057L1.73,13.292c-0.973-0.432-0.973-1.848,0-2.28l2.965-1.316C6.974,8.684,8.787,6.813,9.76,4.47l1.126-2.714c0.418-1.007,1.81-1.007,2.228,0L14.24,4.47c0.973,2.344,2.786,4.215,5.065,5.226l2.965,1.316c0.973,0.432,0.973,1.848,0,2.28l-3.061,1.359C16.988,15.637,15.206,17.441,14.217,19.707z"}),(0,H.jsx)("path",{d:"M24.481,27.796l-0.339,0.777c-0.248,0.569-1.036,0.569-1.284,0l-0.339-0.777c-0.604-1.385-1.693-2.488-3.051-3.092l-1.044-0.464c-0.565-0.251-0.565-1.072,0-1.323l0.986-0.438c1.393-0.619,2.501-1.763,3.095-3.195l0.348-0.84c0.243-0.585,1.052-0.585,1.294,0l0.348,0.84c0.594,1.432,1.702,2.576,3.095,3.195l0.986,0.438c0.565,0.251,0.565,1.072,0,1.323l-1.044,0.464C26.174,25.308,25.085,26.411,24.481,27.796z"})]}),pe=({width:e=24,height:t=24})=>(0,H.jsx)("div",{className:"nfd-ai-chat-avatar",style:{width:e,height:t},children:(0,H.jsx)(he,{width:.625*e,height:.625*t})}),me=({icon:e,text:t,onClick:s,className:n=""})=>(0,H.jsxs)(ne.Button,{className:`nfd-ai-chat-suggestion ${n}`,onClick:s,children:[(0,H.jsx)("div",{className:"nfd-ai-chat-suggestion__icon",children:e}),(0,H.jsx)("div",{className:"nfd-ai-chat-suggestion__text",children:t})]}),ge=({onSendMessage:e,title:t,subtitle:s,suggestions:n=[],showSuggestions:a=!1,animateWelcome:o=!1})=>{const r=(0,d.__)("Hi, I'm your AI assistant.","wp-module-ai-chat"),i=(0,d.__)("How can I help you today?","wp-module-ai-chat"),c=t||r,l=s||i,h=`${c} ${l}`,[p,m]=(0,u.useState)(0),g=(0,u.useRef)(null);(0,u.useEffect)(()=>{if(!o)return void m(h.length);m(0);const e=()=>{m(t=>t>=h.length?t:(g.current=setTimeout(e,40),t+1))};return g.current=setTimeout(e,40),()=>{g.current&&clearTimeout(g.current)}},[o,h]);const f=o&&p<h.length,_=f&&p<=c.length?c.slice(0,p):c,y=f?p>c.length?l.slice(0,p-c.length-1):"":l;return(0,H.jsxs)("div",{className:"nfd-ai-chat-welcome",children:[(0,H.jsxs)("div",{className:"nfd-ai-chat-welcome__content",children:[(0,H.jsx)("div",{className:"nfd-ai-chat-welcome__avatar",children:(0,H.jsx)(pe,{width:64,height:64})}),(0,H.jsxs)("div",{className:"nfd-ai-chat-welcome__message",children:[(0,H.jsx)("div",{className:"nfd-ai-chat-welcome__title",children:_}),(0,H.jsxs)("div",{className:"nfd-ai-chat-welcome__subtitle",children:[y,f&&p<h.length&&(0,H.jsx)("span",{className:"nfd-ai-chat-welcome__cursor","aria-hidden":"true"})]})]})]}),a&&n.length>0&&(0,H.jsx)("div",{className:"nfd-ai-chat-suggestions",children:n.map((t,s)=>(0,H.jsx)(me,{icon:t.icon,text:t.text,onClick:()=>e(t.action||t.text)},s))})]})};function fe(e,t,s,n,a={}){var o;if(!e||0===e.length)return;if(!e.some(e=>("user"===e.role||"user"===e.type)&&e.content&&String(e.content).trim()))return;if(null==t&&null==s)return;const r=null!==(o=a.maxHistoryItems)&&void 0!==o?o:3,i=p(n);try{const n=JSON.parse(localStorage.getItem(i.archive)||"[]"),a={sessionId:t,conversationId:s,messages:e.map(e=>({...e,timestamp:e.timestamp instanceof Date?e.timestamp.toISOString():e.timestamp})),archivedAt:(new Date).toISOString()},o=null!=s?n.filter(e=>e.conversationId!==s):n.filter(e=>e.sessionId!==t);o.unshift(a),localStorage.setItem(i.archive,JSON.stringify(o.slice(0,r)))}catch(e){console.warn("[Chat History] Failed to archive conversation:",e)}}var _e=s(2836),ye=s(6849);const we=e=>{const t=e.messages||e;return Array.isArray(t)&&t.some(e=>("user"===e.role||"user"===e.type)&&e.content&&String(e.content).trim())},ve=({storageNamespace:e,onSelectConversation:t,refreshTrigger:s=0,disabled:n=!1,emptyMessage:a=null,maxHistoryItems:o=3})=>{const[r,i]=(0,u.useState)([]),c=p(e);(0,u.useEffect)(()=>{try{const e=localStorage.getItem(c.archive);if(e){const t=JSON.parse(e);if(Array.isArray(t)&&t.length>0){const e=t.slice(0,o);e.length<t.length&&localStorage.setItem(c.archive,JSON.stringify(e));const s=e.map(e=>{var t,s;const n=(e.messages||[]).map(e=>({...e,timestamp:e.timestamp?new Date(e.timestamp):new Date})),a=e.archivedAt?new Date(e.archivedAt):null;return{sessionId:null!==(t=e.sessionId)&&void 0!==t?t:null,conversationId:null!==(s=e.conversationId)&&void 0!==s?s:null,messages:n,archivedAt:a}}).filter(we);return void i(s)}}const t=localStorage.getItem(c.history);if(t){const e=JSON.parse(t);if(Array.isArray(e)&&e.length>0){const t=((e,t)=>{if(!Array.isArray(e)||0===e.length)return[];const s={},n=[];e.forEach(e=>{if(e.sessionId){s[e.sessionId]||(s[e.sessionId]={sessionId:e.sessionId,messages:[],timestamp:e.timestamp?new Date(e.timestamp).getTime():0}),s[e.sessionId].messages.push(e);const t=e.timestamp?new Date(e.timestamp).getTime():0;t>s[e.sessionId].timestamp&&(s[e.sessionId].timestamp=t)}else n.push(e)});let a=Object.values(s).sort((e,t)=>t.timestamp-e.timestamp).map(e=>({sessionId:e.sessionId,messages:e.messages}));if(n.length>0&&a.length<t){const e=(e=>{const t=[];let s=[],n=null;return e.forEach(e=>{const a=e.timestamp?new Date(e.timestamp).getTime():Date.now();n&&a-n>3e5&&s.length>0&&(t.push({sessionId:null,messages:[...s]}),s=[]),s.push(e),n=a}),s.length>0&&t.push({sessionId:null,messages:s}),t.reverse()})(n);a=[...a,...e]}return a=a.filter(we),a.slice(0,t)})(e.map(e=>({...e,timestamp:e.timestamp?new Date(e.timestamp):new Date})),o);i(t)}}}catch(e){console.warn("[Chat History] Failed to load chat history:",e)}},[e,s,o]);const l=(0,u.useCallback)(e=>{if(!n)try{const s=(e.messages||e).map(e=>({...e,timestamp:e.timestamp instanceof Date?e.timestamp.toISOString():e.timestamp}));localStorage.setItem(c.history,JSON.stringify(s)),e.sessionId&&localStorage.setItem(c.sessionId,e.sessionId),e.conversationId&&localStorage.setItem(c.conversationId,e.conversationId),t&&t(e)}catch(e){console.warn("[Chat History] Failed to restore conversation:",e)}},[n,c,t]),h=(0,u.useCallback)((e,t)=>{if(e.stopPropagation(),e.preventDefault(),!n)try{const e=localStorage.getItem(c.archive);if(e){const s=JSON.parse(e).filter((e,s)=>s!==t);localStorage.setItem(c.archive,JSON.stringify(s))}i(e=>e.filter((e,s)=>s!==t))}catch(e){console.warn("[Chat History] Failed to delete conversation:",e)}},[n,c]);return 0===r.length?a?(0,H.jsx)("div",{className:"nfd-ai-chat-history-list nfd-ai-chat-history-list--empty",children:a}):null:(0,H.jsx)("div",{className:"nfd-ai-chat-history-list",children:r.map((e,t)=>{const s=(e=>{const t=(e.messages||e).find(e=>"user"===e.role||"user"===e.type);if(t&&t.content){const e=t.content;return e.length>50?e.substring(0,50)+"...":e}return(0,d.__)("Previous conversation","wp-module-ai-chat")})(e),a=e.sessionId||`legacy-${t}`,o=e.archivedAt||(e=>{const t=e.messages||e;if(!Array.isArray(t)||0===t.length)return null;let s=0;return t.forEach(e=>{const t=e.timestamp?new Date(e.timestamp).getTime():0;t>s&&(s=t)}),s?new Date(s):null})(e)||null,r=o?(e=>{const t=e instanceof Date?e:new Date(e),s=Date.now()-t.getTime(),n=Math.floor(s/6e4),a=Math.floor(s/36e5),o=Math.floor(s/864e5);return n<1?(0,d.__)("Just now","wp-module-ai-chat"):n<60?`${n}m`:a<24?`${a}h`:o<7?`${o}d`:t.toLocaleDateString(void 0,{month:"short",day:"numeric"})})(o):null;return(0,H.jsxs)("div",{className:"nfd-ai-chat-history-item"+(n?" nfd-ai-chat-history-item--disabled":""),role:"button",tabIndex:n?-1:0,"aria-disabled":n,onClick:()=>l(e),onKeyDown:t=>{n||"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),l(e))},children:[(0,H.jsx)(_e.A,{width:14,height:14,"aria-hidden":!0}),(0,H.jsxs)("div",{className:"nfd-ai-chat-history-item__content",children:[(0,H.jsx)("span",{className:"nfd-ai-chat-history-item__title",children:s}),(0,H.jsxs)("div",{className:"nfd-ai-chat-history-item__meta",children:[r&&(0,H.jsx)("span",{className:"nfd-ai-chat-history-item__time",children:r}),(0,H.jsx)("button",{type:"button",className:"nfd-ai-chat-history-item__delete",onClick:e=>h(e,t),"aria-label":(0,d.__)("Delete conversation","wp-module-ai-chat"),title:(0,d.__)("Delete","wp-module-ai-chat"),children:(0,H.jsx)(ye.A,{width:14,height:14,className:"nfd-ai-chat-history-item__delete-icon","aria-hidden":!0})})]})]})]},a)})})},xe=e=>(0,H.jsxs)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",focusable:"false",...e,children:[(0,H.jsx)("circle",{cx:"12",cy:"12",r:"9",stroke:"currentColor",strokeWidth:"2"}),(0,H.jsx)("path",{d:"M12 7v5l3 3",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})]}),be=({storageNamespace:e,open:t,onOpenChange:s,onSelectConversation:n,refreshTrigger:a=0,disabled:o=!1,maxHistoryItems:r})=>{const i=(0,u.useRef)(null),c=(0,u.useRef)(null),[l,h]=(0,u.useState)({top:0,left:0,openUp:!1}),p=(0,u.useCallback)(()=>{if(!i.current)return;const e=i.current.getBoundingClientRect(),t=window.innerHeight-e.bottom,s=t<240&&e.top>t;h({top:s?e.top:e.bottom,left:e.right,openUp:s})},[]);(0,u.useLayoutEffect)(()=>{t&&p()},[t,p]),(0,u.useEffect)(()=>{if(!t)return;const e=()=>p();return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[t,p]),(0,u.useEffect)(()=>{if(!t)return;const e=e=>{i.current?.contains(e.target)||c.current?.contains(e.target)||s(!1)},n=e=>{"Escape"===e.key&&s(!1)};return document.addEventListener("mousedown",e),document.addEventListener("keydown",n),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("keydown",n)}},[t,s]);const m=(0,u.useCallback)(e=>{n(e),s(!1)},[n,s]),g=(0,H.jsx)("div",{ref:c,className:"nfd-ai-chat-history-dropdown",role:"dialog","aria-label":(0,d.__)("Chat history","wp-module-ai-chat"),style:{position:"fixed",top:l.openUp?"auto":l.top,bottom:l.openUp?window.innerHeight-l.top:"auto",left:"auto",right:window.innerWidth-l.left,zIndex:1e5},children:(0,H.jsx)("div",{className:"nfd-ai-chat-history-dropdown-inner",children:(0,H.jsx)(ve,{storageNamespace:e,onSelectConversation:m,disabled:o,refreshTrigger:t?a:0,emptyMessage:(0,d.__)("No conversations yet.","wp-module-ai-chat"),maxHistoryItems:r})})});return(0,H.jsxs)("div",{className:"nfd-ai-chat-history-dropdown-wrapper",children:[(0,H.jsx)("button",{ref:i,type:"button",className:"nfd-ai-chat-history-dropdown-trigger "+(t?"is-open":""),onClick:()=>{o||s(!t)},disabled:o,"aria-expanded":t,"aria-haspopup":"true","aria-label":(0,d.__)("Chat history","wp-module-ai-chat"),title:(0,d.__)("Chat history","wp-module-ai-chat"),children:(0,H.jsx)(xe,{})}),t&&(0,u.createPortal)(g,document.body)]})};var Se=s(3875),Ce=s(3733);function Ie(e){const t=e&&String(e).trim()?`"${String(e).trim()}"`:"this",s=window?.nfdHelpCenter?.resourceLink||"#",n=(0,d.__)("Resource center","wp-module-help-center"),a=(0,d.__)("You can try searching our ","wp-module-help-center"),o=(0,d.__)(" though to see if there's a helpful article or video on that subject.","wp-module-help-center"),r=(0,d.sprintf)((0,d.__)("Sorry, I don't have any information on %s yet.","wp-module-help-center"),t),i=(0,d.__)("Try to:","wp-module-help-center"),c=(0,d.__)("Use different keywords in the search field.","wp-module-help-center"),l=(0,d.__)("A clear, short prompt can make the difference.","wp-module-help-center"),u=(0,d.__)("Reach out to our customer support.","wp-module-help-center"),h=(0,d.__)("Call at","wp-module-help-center"),p=(0,d.__)("or","wp-module-help-center"),m=(0,d.__)("Chat Live","wp-module-help-center"),g=(0,d.__)("with one of our support agents — we will assist you as soon as possible.","wp-module-help-center");return["<p>"+r+"</p>","<p><strong>"+i+"</strong></p>","<ul>","<li>"+je(a)+'<a href="'+(f=s,je(f)+'" target="_blank" rel="noopener noreferrer">')+je(n)+"</a>"+je(o)+"</li>","<li>"+je(c+" "+l)+"</li>","<li>"+je(u+" "+h)+' <a href="tel:8884014678">888-401-4678</a> '+je(p)+" "+je(m)+" "+je(g)+"</li>","</ul>"].join("");var f}function je(e){return"string"!=typeof e?"":e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}var Ne=s(1069),$e=s(4989),Ae=s(7738);const ke=()=>{const[e]=(()=>{const[e,t]=(0,u.useState)(()=>Ne.Sp.getHelpVisible());return(0,u.useEffect)(()=>{const e=()=>{t(Ne.Sp.getHelpVisible())};return window.addEventListener("storage",e),()=>{window.removeEventListener("storage",e)}},[]),[e,t]})(),{hasLaunchedFromTooltip:t}=(0,$e.X)(),{onClose:s}=(0,Ce.b_)(),n=(0,u.useRef)(!1),[a,o]=(0,u.useState)(!1),[r,i]=(0,u.useState)(0);(()=>{const e=p("help_center");try{if(!localStorage.getItem(e.history)){const t=localStorage.getItem(e.archive);if(t){const s=JSON.parse(t),n=Array.isArray(s)&&s[0];if(n?.messages?.length>0&&n?.archivedAt){const t=18e5,s=new Date(n.archivedAt).getTime();if(Date.now()-s<=t){const t=n.messages.map(e=>({...e,timestamp:e.timestamp instanceof Date?e.timestamp.toISOString():e.timestamp}));localStorage.setItem(e.history,JSON.stringify(t)),null!=n.conversationId&&localStorage.setItem(e.conversationId,String(n.conversationId)),null!=n.sessionId&&localStorage.setItem(e.sessionId,String(n.sessionId))}}}}}catch(e){}})();const{messages:c,sendMessage:l,sendSystemMessage:h,isTyping:m,status:g,currentResponse:_,conversationId:y,clearApprovalRequest:w,clearTyping:v,updateMessage:x,stopRequest:b,clearChatHistory:S,loadConversation:C,getSessionId:I,error:j,connectionState:N,isConnecting:$,manualRetry:A}=M({configEndpoint:"/nfd-agents/chat/v1/config",storageNamespace:"help_center",autoConnect:e,consumerType:"help_center",autoLoadHistory:!0,getConnectionFailedFallbackMessage:Ie});(0,u.useEffect)(()=>{c.length>0&&fe(c,I(),y,"help_center")},[c,I,y]),(0,u.useEffect)(()=>{const e=()=>{c.length>0&&fe(c,I(),y,"help_center")};return window.addEventListener("beforeunload",e),()=>window.removeEventListener("beforeunload",e)},[c,I,y]);const k=(0,u.useCallback)(e=>{var t,s;const n=e.messages||e;C(n,null!==(t=e.conversationId)&&void 0!==t?t:null,null!==(s=e.sessionId)&&void 0!==s?s:null)},[C]),T=(0,u.useCallback)(()=>{x&&x(e=>"approval_request"===e.type&&e.approvalRequest,e=>({...e,type:"assistant",content:(0,d.__)("Action approved and executed.","wp-module-help-center"),approvalRequest:null})),w()},[w,x]),R=(0,u.useCallback)(()=>{x&&x(e=>"approval_request"===e.type&&e.approvalRequest,e=>{const t=e.approvalRequest?.tool_name||"action";return{...e,type:"assistant",content:(0,d.sprintf)(/* translators: %s: the name of the action or tool that was cancelled */ /* translators: %s: the name of the action or tool that was cancelled */
(0,d.__)('Action "%s" was cancelled.',"wp-module-help-center"),t),approvalRequest:null}}),w()},[w,x]),E=(0,u.useCallback)(()=>{n.current=!1,c.length>0&&fe(c,I(),y,"help_center"),S(),i(e=>e+1)},[c,I(),y,S]),D=(0,u.useCallback)(()=>{n.current=!1,function(e,t){const s=p("help_center");try{const n=JSON.parse(localStorage.getItem(s.archive)||"[]"),a=n.filter(s=>s.conversationId!==e||s.sessionId!==t);a.length!==n.length&&localStorage.setItem(s.archive,JSON.stringify(a))}catch(e){console.warn("[Chat History] Failed to remove conversation from archive:",e)}}(y,I()),S(),i(e=>e+1)},[y,I,S]),O=[...c];_&&m&&O.push({id:"streaming",role:"assistant",type:"assistant",content:_,timestamp:new Date});const L=0===O.length&&!n.current;(0,u.useEffect)(()=>{O.length>0&&(n.current=!0)},[O.length]);const U=c.length>0;let P;return P=L?(0,H.jsx)("div",{className:"nfd-help-center-chat__welcome-wrapper",children:(0,H.jsx)(ge,{onSendMessage:l,title:(0,d.__)("Hi, I'm BLU, your AI assistant.","wp-module-help-center"),subtitle:(0,d.__)("I can help you create and edit posts and pages, update content, and manage your WordPress site.","wp-module-help-center"),showSuggestions:!1})}):(0,H.jsxs)("div",{className:"nfd-help-center-chat__messages-wrapper",children:[c.length>0&&(0,H.jsx)("div",{className:"nfd-help-center-chat__messages-header",children:(0,H.jsx)("button",{onClick:D,className:"nfd-help-center-chat__clear-chat-button","aria-label":(0,d.__)("Clear chat","wp-module-help-center"),children:(0,d.__)("Clear Chat","wp-module-help-center")})}),(0,H.jsx)(se,{messages:O,isLoading:m||$,status:$?f:g,error:j,onRetry:"failed"===N?A:void 0,connectionFailed:"failed"===N,onApprove:T,onReject:R,onSendMessage:l,onSendSystemMessage:h,conversationId:y,onClearTyping:v,brandId:null})]}),(0,H.jsxs)("div",{className:"nfd-help-center-chat nfd-ai-chat-container",children:[(0,H.jsx)("div",{className:"nfd-help-center-chat__header-wrapper",children:(0,H.jsx)(de,{title:(0,d.__)("Blu Chat","wp-module-help-center"),onNewChat:E,newChatDisabled:L,onClose:s,extraActions:(0,H.jsx)(be,{storageNamespace:"help_center",open:a,onOpenChange:e=>{o(e),e&&i(e=>e+1)},onSelectConversation:e=>{k(e),o(!1)},refreshTrigger:r,disabled:!1})})}),P,(0,H.jsx)("div",{className:"nfd-help-center-chat__input-area",children:(0,H.jsx)("div",{className:"nfd-help-center-chat__input-wrapper",children:(0,H.jsx)(re,{onSendMessage:l,onStopRequest:b,disabled:m,placeholder:(0,d.__)("Ask me anything about WordPress…","wp-module-help-center"),showTopBorder:!1})})}),(0,Ae.$)(t)&&(0,H.jsx)("div",{className:"nfd-help-center-chat__footer-wrapper"+(U?" nfd-help-center-chat__footer-wrapper--collapsed":""),"aria-hidden":U,children:(0,H.jsx)(Se.A,{})})]})}}}]);