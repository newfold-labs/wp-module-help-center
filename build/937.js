"use strict";(globalThis.webpackChunk_newfold_labs_wp_module_help_center=globalThis.webpackChunk_newfold_labs_wp_module_help_center||[]).push([[937],{9937:(e,t,n)=>{n.d(t,{default:()=>We});var s=n(8394),o=n(2975);class a extends Error{constructor(e,t=null,n=null){super(e),this.name="MCPError",this.code=t,this.details=n}}new class{constructor(e={}){this.configKey=e.configKey||"nfdAIChat",this.client=null,this.transport=null,this.connected=!1,this.tools=[],this.resources=[],this.eventListeners=new Map}getConfig(){const e="undefined"!=typeof window&&window[this.configKey]||{};return{nonce:e.nonce||"",restUrl:e.restUrl||"/wp-json/",mcpUrl:e.mcpUrl||`${e.restUrl||"/wp-json/"}mcp/mcp-adapter-default-server`,homeUrl:e.homeUrl||""}}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(t)}off(e,t){const n=this.eventListeners.get(e);n&&n.delete(t)}emit(e){const t=this.eventListeners.get(e.type);t&&t.forEach(t=>{try{t(e)}catch(e){console.error("Error in MCP event listener:",e)}})}async connect(e=null){try{const t=this.getConfig(),n=e||t.mcpUrl;if(!n)throw new a("MCP endpoint URL not configured");this.client=new s.K({name:"nfd-ai-chat-client",version:"1.0.0"},{capabilities:{}}),this.transport=new o.j(new URL(n),{requestInit:{headers:{"X-WP-Nonce":t.nonce,"Content-Type":"application/json"}}}),await this.client.connect(this.transport),this.connected=!0,this.emit({type:"connected"})}catch(e){const t=e instanceof a?e:new a(`Connection failed: ${e.message}`);throw this.emit({type:"error",data:t}),t}}async initialize(){if(!this.connected)throw new a("Not connected to MCP server");try{await Promise.all([this.loadTools(),this.loadResources()]);const e={protocolVersion:"2025-06-18",capabilities:{tools:{},resources:{},prompts:{}},serverInfo:{name:"WordPress MCP Server",version:"1.0.0"}};return this.emit({type:"initialized",data:e}),e}catch(e){const t=e instanceof a?e:new a(`Initialization failed: ${e.message}`);throw this.emit({type:"error",data:t}),t}}normalizeInputSchema(e){return!e||Array.isArray(e)||"object"!=typeof e||0===Object.keys(e).length?{type:"object",properties:{},required:[]}:{type:e.type||"object",properties:e.properties||{},required:Array.isArray(e.required)?e.required:[]}}async loadTools(){try{const e=await this.client.listTools();this.tools=e.tools.map(e=>({name:e.name,description:e.description||"",inputSchema:this.normalizeInputSchema(e.inputSchema),annotations:e.annotations||{}})),this.emit({type:"tools_updated",data:this.tools})}catch(e){console.error("Failed to load tools via SDK:",e),this.tools=[]}}async loadResources(){try{const e=await this.client.listResources();this.resources=e.resources.map(e=>({uri:e.uri,name:e.name||"",description:e.description,mimeType:e.mimeType})),this.emit({type:"resources_updated",data:this.resources})}catch(e){console.error("Failed to load resources via SDK:",e),this.resources=[]}}async listTools(){if(!this.connected)throw new a("Not connected to MCP server");return this.tools}async callTool(e,t={}){if(!this.connected)throw new a("Not connected to MCP server");try{const n=await this.client.callTool({name:e,arguments:t});return{content:Array.isArray(n.content)?n.content:[],isError:Boolean(n.isError),meta:n.meta||{}}}catch(t){console.error(`Tool "${e}" call failed:`,t);const n=t instanceof a?t:new a(`Tool call failed: ${t.message}`);throw this.emit({type:"error",data:n}),n}}async listResources(){if(!this.connected)throw new a("Not connected to MCP server");return this.resources}async readResource(e){if(!this.connected)throw new a("Not connected to MCP server");try{return await this.client.readResource({uri:e})}catch(t){console.error(`Resource "${e}" read failed:`,t);const n=t instanceof a?t:new a(`Resource read failed: ${t.message}`);throw this.emit({type:"error",data:n}),n}}async disconnect(){try{this.transport&&(await this.client.close(),this.transport=null),this.connected=!1,this.tools=[],this.resources=[],this.emit({type:"disconnected"})}catch(e){console.error("Error during SDK disconnect:",e)}}isConnected(){return this.connected}getTools(){return[...this.tools]}getResources(){return[...this.resources]}isToolReadOnly(e){const t=this.tools.find(t=>t.name===e);return!t||!0===t.annotations?.readonly||!0===t.annotations?.readOnlyHint}getToolsForOpenAI(){return this.tools.map(e=>{const t=this.normalizeInputSchema(e.inputSchema);return{type:"function",function:{name:e.name,description:e.description||"",parameters:t}}})}};var r=n(3556);const i="gpt-4o-mini";class c extends Error{constructor(e,t=null,n=null){super(e),this.name="OpenAIError",this.status=t,this.code=n}}new class{constructor(e={}){this.configKey=e.configKey||"nfdAIChat",this.apiPath=e.apiPath||"ai",this.mode=e.mode||"help",this.openai=null,this.config=null}getConfig(){return this.config||("undefined"!=typeof window&&window[this.configKey]?this.config={nonce:window[this.configKey].nonce,restUrl:window[this.configKey].restUrl,homeUrl:window[this.configKey].homeUrl}:this.config={nonce:"",restUrl:"",homeUrl:""}),this.config}getOpenAIClient(){if(this.openai)return this.openai;const e=this.getConfig();return this.openai=new r.Ay({apiKey:"proxy",baseURL:`${e.restUrl}${this.apiPath}`,dangerouslyAllowBrowser:!0,defaultHeaders:{"X-WP-Nonce":e.nonce}}),this.openai}async createChatCompletion(e){try{const t=this.getOpenAIClient();return await t.chat.completions.create({model:e.model||i,messages:e.messages,tools:e.tools,tool_choice:e.tool_choice,stream:!1,max_tokens:e.max_tokens,temperature:e.temperature,mode:e.mode||this.mode})}catch(e){throw new c(e.message||"OpenAI API request failed",e.status,e.code)}}async createStreamingCompletion(e,t,n,s){try{const s=this.getOpenAIClient(),o=await s.chat.completions.create({...e,messages:e.messages,stream:!0,stream_options:{include_usage:!0},mode:e.mode||this.mode});let a="",r=null;const i={};let c=null;for await(const e of o){const n=e.choices[0]?.delta;if(n?.reasoning&&t({type:"reasoning",content:n.reasoning}),n?.content&&(a+=n.content,t({type:"content",content:n.content})),n?.tool_calls){for(const e of n.tool_calls){const t=e.index;i[t]||(i[t]={id:e.id||"",type:"function",function:{name:e.function?.name||"",arguments:""}}),e.id&&(i[t].id=e.id),e.function?.name&&(i[t].function.name=e.function.name),e.function?.arguments&&(i[t].function.arguments+=e.function.arguments)}t({type:"tool_calls",tool_calls:Object.values(i)})}e.choices[0]?.finish_reason&&(c=e.choices[0].finish_reason),e.usage&&(r=e.usage,console.log(`[Token Usage] prompt: ${r.prompt_tokens} | completion: ${r.completion_tokens} | total: ${r.total_tokens}`))}if(!r&&o.usage&&(r=o.usage),r&&console.log(`[Token Usage] prompt: ${r.prompt_tokens} | completion: ${r.completion_tokens} | total: ${r.total_tokens}`),c){const e=Object.values(i).map(e=>({id:e.id,name:e.function.name,arguments:e.function.arguments?JSON.parse(e.function.arguments):{}}));await n(a,e.length>0?e:null,r)}}catch(e){s(new c(e.message||"Streaming request failed",e.status,e.code))}}convertMessagesToOpenAI(e){const t=[];for(const o of e){var n;if("system"===o.role||"user"===o.role)t.push({role:o.role,content:null!==(n=o.content)&&void 0!==n?n:""});else if("assistant"===o.role){var s;const e=o.toolCalls&&o.toolCalls.length>0;if((null===o.content||void 0===o.content||""===o.content)&&!e){console.warn("Skipping invalid assistant message with no content and no tool calls");continue}let n=null!==(s=o.content)&&void 0!==s?s:"";e&&n.length>200&&(n=n.substring(0,200)+"...");const a={role:"assistant",content:e?n||null:n};if(e&&(a.tool_calls=o.toolCalls.map(e=>({id:e.id,type:"function",function:{name:e.name,arguments:"string"==typeof e.arguments?e.arguments:JSON.stringify(e.arguments)}}))),t.push(a),e&&o.toolResults&&o.toolResults.length>0)for(const e of o.toolResults)if(o.toolCalls.some(t=>t.id===e.id)){const n=e.error?`Error: ${e.error.substring(0,100)}`:"Success";t.push({role:"tool",content:n,tool_call_id:e.id})}}}return t}convertMCPToolsToOpenAI(e){return e.map(e=>({type:"function",function:{name:e.name,description:e.description,parameters:e.inputSchema}}))}processToolCalls(e){return e.map(e=>({id:e.id,name:e.function.name,arguments:JSON.parse(e.function.arguments||"{}")}))}async sendMessage(e,t=[],n=[]){const s=this.convertMessagesToOpenAI([...t,{id:`user-${Date.now()}`,role:"user",content:e,timestamp:new Date}]),o={model:i,messages:s,tools:n.length>0?this.convertMCPToolsToOpenAI(n):void 0,tool_choice:n.length>0?"auto":void 0,temperature:.1,max_tokens:4e3};try{const e=(await this.createChatCompletion(o)).choices[0];if(!e)throw new c("No response from OpenAI");const t={message:e.message.content||""};return e.message.tool_calls&&(t.toolCalls=this.processToolCalls(e.message.tool_calls)),t}catch(e){if(e instanceof c)throw e;throw new c(`Failed to send message: ${e}`)}}};var l=n(6087);var u=n(7723);function d(e){if(!e||"string"!=typeof e)return null;const t=e.split(".");if(3!==t.length)return null;try{const e=function(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");const n=t.length%4;n&&(t+="===".slice(0,4-n));try{return decodeURIComponent(atob(t).split("").map(e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""))}catch(e){return atob(t)}}(t[1]),n=JSON.parse(e),s=n?.exp;return"number"==typeof s&&Number.isFinite(s)?1e3*s:null}catch(e){return null}}const h="nfd-ai-chat-site-id",p={history:"history",conversationId:"conversation-id",sessionId:"session-id",archive:"archive"},m=()=>{try{return localStorage.getItem(h)||""}catch{return""}},g=(e,t)=>e?`nfd-ai-chat-${e}-${t}`:`nfd-ai-chat-${t}`,f=e=>{const t=g(m(),e),n={};for(const[e,s]of Object.entries(p))n[e]=`${t}-${s}`;return n},_="processing",w="connecting",y="ws_connecting",v="tool_call",b="working",x="received",S="generating",C="summarizing",j="completed",I="failed";function N(e){var t;return null!==(t={typing_start:_,handoff_request:w,handoff_accept:w,tool_call:v,tool_result:b,typing_stop:null}[e])&&void 0!==t?t:null}const k=e=>{if(!e||"string"!=typeof e)return!1;const t=e.toLowerCase().trim(),n=[/^hello!?\s+how\s+can\s+i\s+assist\s+you/i,/^hi!?\s+how\s+can\s+i\s+help/i,/^hello!?\s+how\s+can\s+i\s+help/i,/^hi\s+there!?\s+how\s+can/i,/^greetings!?\s+how\s+can/i,/^how\s+can\s+i\s+assist\s+you\s+today/i,/^how\s+can\s+i\s+help\s+you\s+today/i,/^hello!?\s+how\s+can\s+i\s+assist\s+you\s+today/i,/^hello!?\s+how\s+can\s+i\s+assist\s+you.*feel\s+free/i].some(e=>e.test(t)),s=t.includes("hello")&&(t.includes("assist")||t.includes("help"))&&(t.includes("today")||t.includes("feel free")||t.includes("ask")),o=t.length<150&&(t.includes("hello")&&(t.includes("assist")||t.includes("help"))||t.includes("hi")&&t.includes("help"));return n||s||o},$=(e,t)=>{const n=e?.trim();return n&&"No content provided"!==n&&"sales_requested"!==n&&"sales_requested"!==n.toLowerCase()?!t&&n.length<150&&k(n)?null:n:null},A=e=>{e.current&&(clearTimeout(e.current),e.current=null)},T=({setIsTyping:e,setStatus:t,setCurrentResponse:n,typingTimeoutRef:s})=>{e(!1),t(null),n(""),A(s)},R=(e,t,n="")=>{e(e=>[...e,{id:`msg-${Date.now()}${n}`,role:"assistant",type:"assistant",content:t,timestamp:new Date,animateTyping:!0}])};var E=n(1455),D=n.n(E);async function O({configEndpoint:e,consumer:t}){try{let n=e,s="undefined"==typeof window?"":(window.nfdAIChat||{}).homeUrl||window.location.origin,o=!1,a="";if(e.startsWith("http://")||e.startsWith("https://")){const t=new URL(e);if(t.searchParams.has("rest_route"))n=t.searchParams.get("rest_route");else if(t.pathname.includes("/wp-json/")){n=t.pathname.replace(/^\/wp-json\//,"").replace(/^\/wp-json/,""),o=!0;const e=t.pathname.split("/wp-json")[0].replace(/\/$/,"");a=t.origin+(e||"/")}else n=t.pathname.replace(/^\//,"");if(!o)if(t.pathname.includes("/wp-json")){const e=t.pathname.split("/wp-json")[0].replace(/\/$/,"");s=t.origin+(e||"/")}else s=t.origin+(t.pathname||"/")}const r=n.replace(/^\//,"");let i;if(o)i=((e,t="")=>{if(e.includes("rest_route="))return e;const n=e.match(/\/wp-json\/(.+)$/);if(!n)return e;const s=n[1];t||"undefined"==typeof window||(t=window.location.origin);const o=t.replace(/\/wp-json\/?$/,""),a=o.includes("?")?"&":"?";return`${o}${a}rest_route=/${s}`})(e,a);else{const e=r.lastIndexOf("/"),t=-1===e?"":r.slice(0,e);i=((e,t,n="")=>{const s=((e="")=>{if(e&&e.includes("rest_route="))return e;e||"undefined"==typeof window||(e=window.location.origin);const t=e.includes("?")?"&":"?";return`${e}${t}rest_route=/`})(n),o=`${e}/${t}`;if(s.includes("rest_route="))return s.replace("rest_route=/",`rest_route=/${o}`);const a=s.includes("?")?"&":"?";return`${s}${a}rest_route=/${o}`})(t,-1===e?r:r.slice(e+1),s)}return i=`${i}&consumer=${encodeURIComponent(t)}`,await D()({url:i,parse:!0})}catch(e){console.error("[AI Chat] Failed to fetch config:",e),console.error("[AI Chat] Error details:",{message:e.message,code:e.code,data:e.data,status:e.data?.status,statusText:e.data?.statusText});let t=e.message||(0,u.__)("Failed to connect","wp-module-ai-chat");throw e.data?.message?t=e.data.message:e.message&&"Could not get a valid response from the server."!==e.message&&(t=e.message),"rest_forbidden"===e.code||403===e.data?.status?t=(0,u.__)("Access denied. Please check your capabilities.","wp-module-ai-chat"):"rest_no_route"===e.code||404===e.data?.status?t=(0,u.__)("Config endpoint not found. Please ensure the backend is deployed.","wp-module-ai-chat"):"gateway_url_not_configured"===e.code?t=(0,u.__)("Gateway URL not configured. Set NFD_AGENTS_CHAT_GATEWAY_URL in wp-config.php.","wp-module-ai-chat"):"jarvis_jwt_fetch_failed"===e.code||"huapi_token_fetch_failed"===e.code?t=(0,u.__)("Failed to fetch authentication token from Hiive. Check your connection or set NFD_AGENTS_CHAT_DEBUG_TOKEN for local development.","wp-module-ai-chat"):e.data?.status&&(t=(0,u.sprintf)(/* translators: %1$s: HTTP status, %2$s: status text */ /* translators: %1$s: HTTP status, %2$s: status text */
(0,u.__)("Failed to fetch config: %1$s %2$s","wp-module-ai-chat"),e.data.status,e.data.statusText||t)),new Error(t)}}const M=e=>Array.isArray(e)&&e.some(e=>("user"===e.role||"user"===e.type)&&e.content&&String(e.content).trim()),L=(e,t,n)=>{try{const s=localStorage.getItem(e),o=localStorage.getItem(t),a=localStorage.getItem(n);if(s){const e=JSON.parse(s);if(Array.isArray(e)&&e.length>0)return{messages:e.map(e=>({...e,timestamp:e.timestamp?new Date(e.timestamp):new Date,animateTyping:!1})),conversationId:o||null,sessionId:a||null}}}catch(e){console.warn("[AI Chat] Failed to restore chat history from localStorage:",e)}return{messages:[],conversationId:null,sessionId:null}},U=(e,t)=>{try{M(t)?localStorage.setItem(e,JSON.stringify(t)):localStorage.removeItem(e)}catch(e){console.warn("[AI Chat] Failed to save messages to localStorage:",e)}},F=({configEndpoint:e,consumer:t,autoConnect:n=!1,consumerType:s="editor_chat",autoLoadHistory:o=!0,getConnectionFailedFallbackMessage:a}={})=>{const r=f(t),i=r.history,c=r.conversationId,_=r.sessionId,w=i.replace(/-history$/,""),[y,v]=(0,l.useState)(()=>o?L(i,c,_).messages:[]),[b,x]=(0,l.useState)(()=>o?L(i,c,_).conversationId:null),[S,C]=(0,l.useState)(!1),[j,I]=(0,l.useState)(!1),[E,D]=(0,l.useState)(null),[F,P]=(0,l.useState)(!1),[W,q]=(0,l.useState)(null),[B,H]=(0,l.useState)(""),[z,J]=(0,l.useState)(null),[K,G]=(0,l.useState)(()=>{try{if("1"===sessionStorage.getItem(`${w}-connection-failed`))return"failed"}catch(e){}return"disconnected"}),[Y,V]=(0,l.useState)(0),X=(0,l.useRef)(null),Z=(0,l.useRef)(null),Q=(0,l.useRef)(0),ee=(0,l.useRef)(null),te=(0,l.useRef)(null),ne=(0,l.useRef)(null),se=(0,l.useRef)(null),oe=(0,l.useRef)(null),ae=(0,l.useRef)(null),re=(0,l.useRef)(null),ie=(0,l.useRef)(!1),ce=(0,l.useRef)(()=>o?L(i,c,_).sessionId:null);"function"==typeof ce.current&&(ce.current=ce.current());const le=(0,l.useRef)(!1),ue=(0,l.useRef)(!1),de=(0,l.useRef)(!1),he=(0,l.useRef)(null),pe=(0,l.useRef)(!0),me=(0,l.useRef)([]),ge=(0,l.useRef)(K),fe=(0,l.useRef)(K),_e=6e4,we=3e5,ye=3e5,ve=36e5,be=18e4,xe=6e4,Se=(0,l.useCallback)(e=>{ce.current=e;try{localStorage.setItem(_,e)}catch(e){console.warn("[AI Chat] Failed to save session ID to localStorage:",e)}},[_]),Ce=(0,l.useCallback)(e=>{try{localStorage.setItem(c,e)}catch(e){console.warn("[AI Chat] Failed to save conversation ID to localStorage:",e)}},[c]),je=(0,l.useCallback)(async()=>{if(X.current?.readyState!==WebSocket.OPEN&&X.current?.readyState!==WebSocket.CONNECTING&&!ie.current){try{sessionStorage.removeItem(`${w}-connection-failed`)}catch(e){}ie.current=!0,I(!0),G("connecting"),D(null);try{ee.current||(ee.current=await O({configEndpoint:e,consumer:t}));let n=ee.current;if(!n)throw new Error((0,u.__)("No configuration available","wp-module-ai-chat"));let o=!1;for(;n?.jarvis_jwt;){const s=d(n.jarvis_jwt);if(null==s)break;if(s>=Date.now()+xe)break;if(o)throw new Error((0,u.__)("Token expired, please refresh the page.","wp-module-ai-chat"));if(ee.current=null,ee.current=await O({configEndpoint:e,consumer:t}),n=ee.current,o=!0,!n)throw new Error((0,u.__)("No configuration available","wp-module-ai-chat"))}if(n.site_id){const e=m();e!==n.site_id&&((e=>{try{localStorage.setItem(h,e)}catch{}})(n.site_id),((e,t,n)=>{const s=g(e,n),o=g(t,n);try{for(const e of Object.values(p)){const t=`${s}-${e}`,n=`${o}-${e}`,a=localStorage.getItem(t);a&&!localStorage.getItem(n)&&localStorage.setItem(n,a),a&&localStorage.removeItem(t)}}catch{}})(e,n.site_id,t))}if(ce.current||(ce.current=crypto.randomUUID?crypto.randomUUID():`${Date.now()}-${Math.random().toString(36).substring(2,15)}`),n.jarvis_jwt){te.current&&(clearTimeout(te.current),te.current=null);const e=d(n.jarvis_jwt);if(null!=e){let t=e-we;t=Math.max(t,Date.now()+ye);const n=Date.now();if(!(null!=ne.current&&t<ne.current+ve)){const e=Math.max(0,t-n),s=()=>{de.current?te.current=setTimeout(s,3e4):(te.current=null,ne.current=Date.now(),ee.current=null,ae.current&&ae.current(),oe.current&&oe.current())};te.current=setTimeout(s,e)}}}const a=((e,t,n)=>{var s,o;const a=(e=>e&&"string"==typeof e?e.startsWith("http://")?e.replace("http://","ws://"):e.startsWith("https://")?e.replace("https://","wss://"):e.startsWith("ws://")||e.startsWith("wss://")?e:(e=>{if(!e||"string"!=typeof e)return!1;const t=e.toLowerCase();return t.includes("localhost")||t.includes("127.0.0.1")})(e)?`ws://${e}`:`wss://${e}`:e)(e.gateway_url),r=("nfd-agents"===e.agent_type?"blu":e.agent_type)||"blu",i=`wordpress_${n}`,c=null!==(s=null!==(o=e.huapi_token)&&void 0!==o?o:e.jarvis_jwt)&&void 0!==s?s:"";let l=`${a}/${e.brand_id}/agents/${r}/v1/ws?session_id=${t}&token=${encodeURIComponent(c)}&consumer=${encodeURIComponent(i)}`;return l+=`&site_url=${encodeURIComponent("https://smw.ljd.temp-bh.newfold-dev.site/")}`,l})(n,ce.current,s),r=new WebSocket(a);X.current=r,r.onopen=()=>{ie.current=!1,C(!0),I(!1),G("connected"),V(0),D(null),Q.current=0,le.current=me.current&&me.current.length>0,ue.current=!1,H("")};const i=function(e){const{isStoppedRef:t,hasUserMessageRef:n,typingTimeoutRef:s,typingTimeout:o,setIsTyping:a,setStatus:r,setCurrentResponse:i,setMessages:c,setConversationId:l,setError:u,saveSessionId:d,saveConversationId:h}=e;return function(p){if(!t.current||"session_established"===p.type)if("session_established"!==p.type){if("typing_start"===p.type)return a(!0),r(N("typing_start")),void A(s);if("typing_stop"===p.type)return a(!1),r(null),i(""),void A(s);if("streaming_chunk"===p.type||"chunk"===p.type){if(t.current)return;const e=p.content||p.chunk||p.text||"";return void(e&&i(t=>{const i=t+e;return!n.current&&i.length<100&&k(i)?"":(a(!0),s.current&&clearTimeout(s.current),s.current=setTimeout(()=>{a(!1),r(null),s.current=null},o),i)}))}if("structured_output"===p.type){const t=p.response_content?.content?.human_input_request;if(t&&"APPROVAL_REQUEST"===(t.input_type||t.inputType||"").toUpperCase()){if(p.conversation_id||p.conversationId){const e=p.conversation_id||p.conversationId;l(e),h(e)}return}const s=p.message||p.response_content?.message,o=$(s,n.current);return void(o&&(i(e=>(e&&R(c,e,"-streaming"),"")),R(c,o),T(e)))}if("tool_call"!==p.type){if("tool_result"!==p.type){if("message"===p.type||"complete"===p.type){let t=!1;if(i(e=>{if(e){const s=e.trim();if("No content provided"===s||"sales_requested"===s||"sales_requested"===s.toLowerCase())return"";if(!n.current&&e.length<150&&k(e))return"";c(t=>[...t,{id:`msg-${Date.now()}`,role:"assistant",type:"assistant",content:e,timestamp:new Date,animateTyping:!0}]),t=!0}return""}),!t){const e=p.message||p.response_content?.message,s=$(e,n.current);s&&(R(c,s),t=!0)}return void(t&&T(e))}if("handoff_accept"!==p.type){if("handoff_request"===p.type){r(N("handoff_request"));const t=p.message||p.response_content?.message,s=$(t,n.current);return s?(R(c,s),void T(e)):void i("")}if("error"===p.type)return u(p.message||p.error||"An error occurred"),a(!1),r(null),void i("");if(p.message||p.response_content?.message){const t=p.message||p.response_content?.message,s=$(t,n.current);if(!s)return void i("");R(c,s),T(e)}}else r(N("handoff_accept"))}else if(r(N("tool_result")),p.conversation_id||p.conversationId){const e=p.conversation_id||p.conversationId;l(e),h(e)}}else r(N("tool_call"))}else p.session_id&&d(p.session_id)}}({isStoppedRef:ue,hasUserMessageRef:le,typingTimeoutRef:he,typingTimeout:_e,setIsTyping:P,setStatus:q,setCurrentResponse:H,setMessages:v,setConversationId:x,setError:D,saveSessionId:Se,saveConversationId:Ce});r.onmessage=e=>{try{const t=JSON.parse(e.data);i(t)}catch(e){console.error("[AI Chat] Error parsing WebSocket message:",e)}},r.onerror=()=>{ie.current=!1,I(!1)},r.onclose=e=>{ie.current=!1,C(!1),I(!1),P(!1),q(null),X.current===r&&(X.current=null);const t=4e3===e.code||4001===e.code,n=ee.current?.jarvis_jwt,s=n?d(n):null,o=null!=s&&s<Date.now()+xe;if(t||o){const e=Date.now();(null==se.current||e-se.current>=be)&&(ee.current=null,Q.current=0,se.current=e)}if(1e3!==e.code&&Q.current<5){Q.current++,V(Q.current),G("reconnecting");const e=1e3*Math.pow(2,Q.current-1);Z.current=setTimeout(()=>{je()},e)}else if(Q.current>=5){G("failed");try{sessionStorage.setItem(`${w}-connection-failed`,"1")}catch(e){}}else G("disconnected")}}catch(e){ie.current=!1,"undefined"!=typeof console&&console.warn&&console.warn("[AI Chat] Connection failed:",e?.message||e),I(!1),G("failed");try{sessionStorage.setItem(`${w}-connection-failed`,"1")}catch(e){}}}},[e,t,s,w,Se,Ce,5,1e3,_e,we,ye,ve,be,xe,3e4]);(0,l.useEffect)(()=>{me.current=y},[y]),(0,l.useEffect)(()=>{ge.current=K},[K]),(0,l.useEffect)(()=>{de.current=F},[F]),(0,l.useEffect)(()=>()=>{Z.current&&(clearTimeout(Z.current),Z.current=null),te.current&&(clearTimeout(te.current),te.current=null)},[]),(0,l.useEffect)(()=>{if("failed"!==K||"failed"===fe.current)return void(fe.current=K);fe.current=K;const e=(0,u.__)("Sorry, we couldn't connect. Please try again later or contact support.","wp-module-ai-chat");v(t=>{const n=t.length>0?t[t.length-1]:null,s=n&&("user"===n.role||"user"===n.type),o="function"==typeof a?a(s?n.content:""):e;return[...t,{id:`msg-${Date.now()}-fallback`,role:"assistant",type:"assistant",content:o,timestamp:new Date}]}),D(null),H(""),P(!1),q(null),he.current&&(clearTimeout(he.current),he.current=null)},[K,a]);const Ie=(0,l.useCallback)((e,t=null)=>{if(ue.current=!1,le.current=!0,("failed"===ge.current||Q.current>=5&&(!X.current||X.current.readyState!==WebSocket.OPEN))&&!t){const t={id:`msg-${Date.now()}`,role:"user",type:"user",content:e,timestamp:new Date,sessionId:ce.current},n="function"==typeof a?a(e):(0,u.__)("Sorry, we couldn't connect. Please try again later or contact support.","wp-module-ai-chat");return v(e=>[...e,t,{id:`msg-${Date.now()}-fallback`,role:"assistant",type:"assistant",content:n,timestamp:new Date}]),D(null),H(""),P(!1),void q(null)}if(!X.current||X.current.readyState!==WebSocket.OPEN){if(!t){const t={id:`msg-${Date.now()}`,role:"user",type:"user",content:e,timestamp:new Date,sessionId:ce.current};v(e=>[...e,t])}return void je()}if(!t){const t={id:`msg-${Date.now()}`,role:"user",type:"user",content:e,timestamp:new Date,sessionId:ce.current};v(e=>[...e,t]),H(""),P(!0),he.current&&clearTimeout(he.current),he.current=setTimeout(()=>{P(!1),q(null),he.current=null},_e)}const n={type:"chat",message:e};t?n.conversationId=t:b&&(n.conversationId=b),X.current.send(JSON.stringify(n))},[b,je,a,5,_e]),Ne=(0,l.useCallback)(e=>{if(!X.current||X.current.readyState!==WebSocket.OPEN)return void console.warn("[AI Chat] Cannot send system message - not connected");const t={type:"chat",message:e};b&&(t.conversationId=b),P(!0),H(""),he.current&&clearTimeout(he.current),he.current=setTimeout(()=>{P(!1),q(null),he.current=null},_e),X.current.send(JSON.stringify(t))},[b,_e]),ke=(0,l.useCallback)(()=>{Z.current&&(clearTimeout(Z.current),Z.current=null),te.current&&(clearTimeout(te.current),te.current=null),he.current&&(clearTimeout(he.current),he.current=null),X.current&&(X.current.close(1e3,"User disconnected"),X.current=null),C(!1),I(!1),G("disconnected")},[]);(0,l.useEffect)(()=>{oe.current=je},[je]),(0,l.useEffect)(()=>{ae.current=ke},[ke]);const $e=(0,l.useCallback)(e=>{ce.current=null!=e?e:null},[]),Ae=(0,l.useCallback)(()=>{var e;return null!==(e=ce.current)&&void 0!==e?e:null},[]),Te=(0,l.useCallback)((e,t,n)=>{if(Array.isArray(e)){const t=e.map(e=>({...e,timestamp:e.timestamp?new Date(e.timestamp):new Date,animateTyping:!1}));v(t)}if(x(null!=t?t:null),ce.current=null!=n?n:null,D(null),P(!1),q(null),H(""),null!=n&&X.current?.readyState===WebSocket.OPEN){try{localStorage.setItem(_,n),null!=t&&localStorage.setItem(c,t)}catch(e){console.warn("[AI Chat] Failed to persist session for history load:",e)}ke(),je()}},[je,ke,_,c]),Re=(0,l.useCallback)(()=>{ue.current=!0,P(!1),q(null),H(""),he.current&&(clearTimeout(he.current),he.current=null)},[]),Ee=(0,l.useCallback)(()=>{J(null)},[]),De=(0,l.useCallback)(()=>{P(!1),q(null),he.current&&(clearTimeout(he.current),he.current=null)},[]),Oe=(0,l.useCallback)(e=>{let t;if(null==e)t=(0,u.__)("No content provided.","wp-module-ai-chat");else if("object"==typeof e)try{t=JSON.stringify(e,null,2)}catch(n){console.warn("[useNfdAgentsWebSocket] Failed to stringify content object:",n),t=String(e)}else t=String(e);v(e=>[...e,{id:`msg-${Date.now()}`,role:"assistant",type:"assistant",content:t,timestamp:new Date}]),P(!1),q(null),he.current&&(clearTimeout(he.current),he.current=null)},[]),Me=(0,l.useCallback)((e,t)=>{v(n=>n.map(n=>("function"==typeof e?e(n):n.id===e)?t(n):n))},[]),Le=(0,l.useCallback)(()=>{try{((e,t,n)=>{try{localStorage.removeItem(e),localStorage.removeItem(t),localStorage.removeItem(n)}catch(e){console.warn("[AI Chat] Failed to clear chat storage:",e)}})(i,c,_),v([]),x(null),J(null),P(!1),q(null),H(""),D(null),ce.current=null,X.current&&(X.current.close(),X.current=null,C(!1)),le.current=!1,ue.current=!1,he.current&&(clearTimeout(he.current),he.current=null),Z.current&&(clearTimeout(Z.current),Z.current=null),te.current&&(clearTimeout(te.current),te.current=null),Q.current=0}catch(e){console.warn("[AI Chat] Failed to clear chat history:",e)}},[i,c,_]),Ue=(0,l.useCallback)(()=>{Q.current=0,V(0),D(null),je()},[je]);return(0,l.useEffect)(()=>{const e=re.current;if(null===e)return re.current=n,void(n&&"failed"!==K&&!ie.current&&(!X.current||X.current.readyState!==WebSocket.OPEN&&X.current.readyState!==WebSocket.CONNECTING)&&je());e!==n&&(re.current=n,n?ie.current||X.current&&(X.current.readyState===WebSocket.OPEN||X.current.readyState===WebSocket.CONNECTING)||je():ke())},[n,K]),(0,l.useEffect)(()=>{if(pe.current)return pe.current=!1,void(y.length>0&&M(y)&&U(i,y));U(i,y)},[y,i]),(0,l.useEffect)(()=>{((e,t)=>{try{t?localStorage.setItem(e,t):localStorage.removeItem(e)}catch(e){console.warn("[AI Chat] Failed to save conversation ID to localStorage:",e)}})(c,b)},[b,c]),{messages:y,setMessages:v,setConversationId:x,setSessionId:$e,loadConversation:Te,getSessionId:Ae,sendMessage:Ie,sendSystemMessage:Ne,isConnected:S,isConnecting:j,error:E,isTyping:F,status:W,currentResponse:B,approvalRequest:z,conversationId:b,clearApprovalRequest:Ee,clearTyping:De,addAssistantMessage:Oe,updateMessage:Me,connect:je,disconnect:ke,stopRequest:Re,clearChatHistory:Le,brandId:ee.current?.brand_id||null,connectionState:K,retryAttempt:Y,maxRetries:5,manualRetry:Ue}},P=["Would","If","Like","And","But","Or","So","Maybe","Perhaps","Well","Yes","No","When","Where","How","Why","It","To","We","Do","Be","As","An","The","You","In","On","At","By","Is"],W=new RegExp(`\\b(${P.join("|")})(https?:\\/\\/)`,"gi"),q=new RegExp(`^((${P.join("|")})\\s+)+(.+)$`,"i"),B=new RegExp(`\\/(${P.join("|")})$`,"i"),H=new RegExp(`(\\d)(${P.join("|")})$`,"i"),z=/^https?:\/\/[^\s<>"]+$/;function J(e){return e&&"string"==typeof e?e.replace(W,"$1 $2").replace(/(^|[\s(\["'])(https?:\/\/[^\s<>"]*(?:\n[^\s<>"]*)*)/g,(e,t,n)=>{let s=n.replace(/\s+/g,"").trim().replace(/[.,;:!?)\]]+$/,""),o="";const a=s.match(B);a&&(o=a[1],s=s.replace(B,""));const r=s.match(H);return r&&(o=r[2],s=s.replace(H,"$1")),s?`${null!=t?t:""}<a href="${s.replace(/"/g,"&quot;")}" target="_blank" rel="noopener noreferrer">${s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}</a>${o?" "+o:""}`:e}):""}var K=n(325);const G=e=>K.A.sanitize(e,{ALLOWED_TAGS:["section","div","h1","h2","h3","h4","h5","h6","p","span","strong","em","b","i","u","s","mark","small","sub","sup","a","br","ul","ol","li","dl","dt","dd","blockquote","code","pre","table","thead","tbody","tr","th","td","hr","address","time"],ALLOWED_ATTR:["style","class","id","href","datetime","target","rel"],ALLOW_DATA_ATTR:!1,FORBID_TAGS:["script","object","embed","iframe","form","fieldset","legend","label","input","textarea","select","option","button","details","summary","progress","meter"],FORBID_ATTR:["onerror","onload","onclick","onmouseover","onfocus","onblur"]});var Y=n(435),V=n.n(Y),X=n(5243),Z=n(7640),Q=n(3152),ee=n(4648);function te(e){const t={"nfd-agents/get-global-styles":{title:(0,u.__)("Reading Site Colors","wp-module-ai-chat"),description:(0,u.__)("Fetching current color palette and typography settings","wp-module-ai-chat")},"nfd-agents/update-global-palette":{title:(0,u.__)("Updating Site Colors","wp-module-ai-chat"),description:(0,u.__)("Applying new colors to global styles","wp-module-ai-chat")},"newfold-agents/get-global-styles":{title:(0,u.__)("Reading Site Colors","wp-module-ai-chat"),description:(0,u.__)("Fetching current color palette and typography settings","wp-module-ai-chat")},"newfold-agents/update-global-palette":{title:(0,u.__)("Updating Site Colors","wp-module-ai-chat"),description:(0,u.__)("Applying new colors to global styles","wp-module-ai-chat")},"blu/get-global-styles":{title:(0,u.__)("Reading Site Colors","wp-module-ai-chat"),description:(0,u.__)("Fetching current color palette and typography settings","wp-module-ai-chat")},"blu/update-global-palette":{title:(0,u.__)("Updating Site Colors","wp-module-ai-chat"),description:(0,u.__)("Applying new colors to global styles","wp-module-ai-chat")},"blu-get-global-styles":{title:(0,u.__)("Reading Site Colors","wp-module-ai-chat"),description:(0,u.__)("Fetching current color palette and typography settings","wp-module-ai-chat")},"blu/get-active-global-styles":{title:(0,u.__)("Reading Active Styles","wp-module-ai-chat"),description:(0,u.__)("Fetching active global styles","wp-module-ai-chat")},"blu-get-active-global-styles":{title:(0,u.__)("Reading Active Styles","wp-module-ai-chat"),description:(0,u.__)("Fetching active global styles","wp-module-ai-chat")},"blu/get-active-global-styles-id":{title:(0,u.__)("Getting Styles ID","wp-module-ai-chat"),description:(0,u.__)("Fetching active styles ID","wp-module-ai-chat")},"blu-get-active-global-styles-id":{title:(0,u.__)("Getting Styles ID","wp-module-ai-chat"),description:(0,u.__)("Fetching active styles ID","wp-module-ai-chat")},"blu/update-global-styles":{title:(0,u.__)("Updating Site Styles","wp-module-ai-chat"),description:(0,u.__)("Applying new styles to global styles","wp-module-ai-chat")},"blu-update-global-styles":{title:(0,u.__)("Updating Site Styles","wp-module-ai-chat"),description:(0,u.__)("Applying new styles to global styles","wp-module-ai-chat")},"blu-update-global-palette":{title:(0,u.__)("Updating Site Colors","wp-module-ai-chat"),description:(0,u.__)("Applying new colors to global styles","wp-module-ai-chat")},"blu/edit-block":{title:(0,u.__)("Editing Block Content","wp-module-ai-chat"),description:(0,u.__)("Editing block content","wp-module-ai-chat")},"blu-edit-block":{title:(0,u.__)("Editing Block Content","wp-module-ai-chat"),description:(0,u.__)("Editing block content","wp-module-ai-chat")},"blu/add-section":{title:(0,u.__)("Adding New Section","wp-module-ai-chat"),description:(0,u.__)("Adding new section","wp-module-ai-chat")},"blu-add-section":{title:(0,u.__)("Adding New Section","wp-module-ai-chat"),description:(0,u.__)("Adding new section","wp-module-ai-chat")},"blu/delete-block":{title:(0,u.__)("Removing Block","wp-module-ai-chat"),description:(0,u.__)("Removing block","wp-module-ai-chat")},"blu-delete-block":{title:(0,u.__)("Removing Block","wp-module-ai-chat"),description:(0,u.__)("Removing block","wp-module-ai-chat")},"blu/move-block":{title:(0,u.__)("Moving Block","wp-module-ai-chat"),description:(0,u.__)("Moving block","wp-module-ai-chat")},"blu-move-block":{title:(0,u.__)("Moving Block","wp-module-ai-chat"),description:(0,u.__)("Moving block","wp-module-ai-chat")},"mcp-adapter-discover-abilities":{title:(0,u.__)("Discovering Actions","wp-module-ai-chat"),description:(0,u.__)("Finding available WordPress abilities","wp-module-ai-chat")},"mcp-adapter-get-ability-info":{title:(0,u.__)("Getting Ability Info","wp-module-ai-chat"),description:(0,u.__)("Fetching ability details","wp-module-ai-chat")},"mcp-adapter-execute-ability":{title:(0,u.__)("Executing Action","wp-module-ai-chat"),description:(0,u.__)("Running WordPress ability","wp-module-ai-chat")}};return t[e]?t[e]:"preparing-changes"===e?{title:(0,u.__)("Preparing changes","wp-module-ai-chat"),description:(0,u.__)("Building block markup","wp-module-ai-chat")}:{title:e?.replace(/[-_\/]/g," ").replace(/\b\w/g,e=>e.toUpperCase())||(0,u.__)("Executing","wp-module-ai-chat"),description:(0,u.__)("Running action","wp-module-ai-chat")}}function ne(e,t={}){if("mcp-adapter-execute-ability"===e){const e=t?.ability_name||"unknown",n=te(e);let s=null;if(("nfd-agents/update-global-palette"===e||"newfold-agents/update-global-palette"===e||"blu/update-global-palette"===e||"blu-update-global-palette"===e||"blu/update-global-styles"===e||"blu-update-global-styles"===e)&&t?.parameters?.colors){const e=t.parameters.colors.length;s=`${e} color${1!==e?"s":""}`}return{...n,params:s}}return te(e)}var se=n(790);const oe=({tool:e,isError:t,result:n})=>{const s=ne(e.name,e.arguments),o=((e,t)=>{if(!e||e.isError)return n=e?.error,null==n?null:"string"==typeof n?n:"number"==typeof n||"boolean"==typeof n?String(n):null;var n;try{let n=e.result;if(Array.isArray(n)&&n.length>0&&n[0].text?n=JSON.parse(n[0].text):"string"==typeof n&&(n=JSON.parse(n)),!n||"object"!=typeof n)return null;if(t?.includes("update")){if(n.updatedColors&&Array.isArray(n.updatedColors)){const e=n.updatedColors;return e.length<=3?e.map(e=>`${e.name||e.slug}: ${e.color}`).join(", "):`${e.length} colors updated`}if(n.message&&"string"==typeof n.message)return n.message}if(t?.includes("edit-block")||t?.includes("edit_block"))return n.message&&"string"==typeof n.message?n.message:n.success?"Block updated":"Update failed";if(t?.includes("add-section")||t?.includes("add_section"))return n.message&&"string"==typeof n.message?n.message:n.success?"Section added":"Add failed";if(t?.includes("delete-block")||t?.includes("delete_block"))return n.message&&"string"==typeof n.message?n.message:n.success?"Block removed":"Delete failed";if(t?.includes("move-block")||t?.includes("move_block"))return n.message&&"string"==typeof n.message?n.message:n.success?"Block moved":"Move failed";if(t?.includes("get")||t?.includes("read")){if(n.color?.palette){const e=n.color.palette,t=e.custom?.length||0,s=e.theme?.length||0;if(t||s)return`Found ${t+s} colors`}if(n.typography){const e=n.typography.fontFamilies?.length||0,t=n.typography.fontSizes?.length||0,s=[];if(e&&s.push(`${e} font families`),t&&s.push(`${t} sizes`),s.length)return s.join(", ")}if(n.message&&"string"==typeof n.message)return n.message}return n.id&&t?.includes("id")?`ID: ${n.id}`:null}catch{return null}})(n,e.name);return(0,se.jsxs)("div",{className:V()("nfd-ai-chat-tool-execution__item",{"nfd-ai-chat-tool-execution__item--complete":!t,"nfd-ai-chat-tool-execution__item--error":t}),children:[(0,se.jsxs)("div",{className:"nfd-ai-chat-tool-execution__item-header",children:[t?(0,se.jsx)(X.A,{className:"nfd-ai-chat-tool-execution__icon nfd-ai-chat-tool-execution__icon--error",size:12}):(0,se.jsx)(Z.A,{className:"nfd-ai-chat-tool-execution__icon nfd-ai-chat-tool-execution__icon--success",size:12}),(0,se.jsx)("span",{className:"nfd-ai-chat-tool-execution__item-title",children:s.title}),s.params&&(0,se.jsx)("span",{className:"nfd-ai-chat-tool-execution__item-params",children:s.params})]}),o&&(0,se.jsx)("div",{className:"nfd-ai-chat-tool-execution__item-summary",children:o})]})},ae=({executedTools:e=[],toolResults:t=[]})=>{const[n,s]=(0,l.useState)(!1);if(!e||0===e.length)return null;const o=new Map;t&&Array.isArray(t)&&t.forEach(e=>{e.id&&o.set(e.id,e)});const a=e.some(e=>e.isError),r=e.length;return(0,se.jsxs)("div",{className:V()("nfd-ai-chat-tool-execution",{"nfd-ai-chat-tool-execution--collapsed":!n}),children:[(0,se.jsxs)("button",{type:"button",className:"nfd-ai-chat-tool-execution__header",onClick:()=>s(!n),"aria-expanded":n?"true":"false",children:[n?(0,se.jsx)(Q.A,{className:"nfd-ai-chat-tool-execution__chevron",size:12}):(0,se.jsx)(ee.A,{className:"nfd-ai-chat-tool-execution__chevron",size:12}),(0,se.jsx)("span",{children:a?(0,u.__)("Some actions failed","wp-module-ai-chat"):(0,u.__)("Actions completed","wp-module-ai-chat")}),(0,se.jsxs)("span",{className:"nfd-ai-chat-tool-execution__header-count",children:["(",r,")"]})]}),n&&(0,se.jsx)("div",{className:"nfd-ai-chat-tool-execution__list",children:e.map((e,t)=>(0,se.jsx)(oe,{tool:e,isError:e.isError,result:o.get(e.id)},e.id||`tool-${t}`))})]})},re=({message:e,type:t="assistant",animateTyping:n=!1,onContentGrow:s,executedTools:o=[],toolResults:a=[]})=>{const r="approval_request"===t?"assistant":t,i="user"===r,c=(e||"").length,[u,d]=(0,l.useState)(()=>n?0:c),h=(0,l.useRef)(null);(0,l.useEffect)(()=>{if(n)return h.current=setInterval(()=>{d(e=>e>=c?(h.current&&(clearInterval(h.current),h.current=null),e):Math.min(e+2,c))},35),()=>{h.current&&(clearInterval(h.current),h.current=null)};d(c)},[n,c]);const p=(0,l.useRef)(0);(0,l.useEffect)(()=>{if(!s||!n||0===u)return;const e=Date.now();e-p.current<80||(p.current=e,s())},[u,n,s]);const m=n?(e||"").slice(0,u):e||"",{content:g,isRichContent:f}=(0,l.useMemo)(()=>{if(!m)return{content:"",isRichContent:!1};const e=(t=m)&&"string"==typeof t?t.replace(/\\"/g,'"').replace(/\\'/g,"'"):t;var t;if(i)return{content:e,isRichContent:!1};if((e=>/<[a-z][\s\S]*>/i.test(e))(e))return{content:G(e),isRichContent:!0};if(function(e){return!(!e||"string"!=typeof e)&&[/^#{1,6}\s/m,/\*\*[^*]+\*\*/,/\*[^*]+\*/,/__[^_]+__/,/_[^_]+_/,/`[^`]+`/,/```[\s\S]*?```/,/^\s*[-*+]\s/m,/^\s*\d+\.\s/m,/\[([^\]]+)\]\(([^)]+)\)/].some(t=>t.test(e))}(e)){const t=function(e){if(!e||"string"!=typeof e)return"";let t=e;t=t.replace(/&(?![\w#]+;)/g,"&amp;").replace(/<(?![a-zA-Z/])/g,"&lt;").replace(/(?<![a-zA-Z"])>/g,"&gt;"),t=t.replace(/```(\w*)\n?([\s\S]*?)```/g,(e,t,n)=>`<pre><code class="language-${t||"plaintext"}">${n.trim().replace(/</g,"&lt;").replace(/>/g,"&gt;")}</code></pre>`),t=t.replace(/`([^`]+)`/g,'<code class="inline-code">$1</code>'),t=t.replace(/^######\s+(.+)$/gm,'<h6 class="chat-h6">$1</h6>'),t=t.replace(/^#####\s+(.+)$/gm,'<h5 class="chat-h5">$1</h5>'),t=t.replace(/^####\s+(.+)$/gm,'<h4 class="chat-h4">$1</h4>'),t=t.replace(/^###\s+(.+)$/gm,'<h3 class="chat-h3">$1</h3>'),t=t.replace(/^##\s+(.+)$/gm,'<h2 class="chat-h2">$1</h2>'),t=t.replace(/^#\s+(.+)$/gm,'<h1 class="chat-h1">$1</h1>'),t=t.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),t=t.replace(/__([^_]+)__/g,"<strong>$1</strong>"),t=t.replace(/(?<![*_])\*(?!\*)([^*\n]+)(?<!\*)\*(?!\*)/g,"<em>$1</em>"),t=t.replace(/(?<![_*])_(?!_)([^_\n]+)(?<!_)_(?!_)/g,"<em>$1</em>"),t=t.replace(/\[([^\]]+)\]\(([^)]+)\)/g,(e,t,n)=>{const s=t.trim().match(q),o=s?s[3].trim():"",a=o&&(z.test(o)||/^https?:\/\//.test(o)),r=n.replace(/"/g,"&quot;");return s&&a?`${s[1]}<a href="${r}" target="_blank" rel="noopener noreferrer">${o.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}</a>`:`<a href="${r}" target="_blank" rel="noopener noreferrer">${t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}</a>`}),t=t.replace(/^(\s*)[-*+]\s+(.+)$/gm,(e,t,n)=>`<li class="chat-li" data-level="${Math.floor(t.length/2)}">${n}</li>`),t=t.replace(/((?:<li[^>]*>.*?<\/li>\s*)+)/g,e=>`<ul class="chat-ul">${e.replace(/(<\/li>)\s+(<li)/g,"$1$2")}</ul>`),t=t.replace(/^(\s*)\d+\.\s+(.+)$/gm,(e,t,n)=>`<oli class="chat-oli" data-level="${Math.floor(t.length/2)}">${n}</oli>`),t=t.replace(/((?:<oli[^>]*>.*?<\/oli>\s*)+)/g,e=>`<ol class="chat-ol">${e.replace(/(<\/oli>)\s+(<oli)/g,"$1$2").replace(/<\/?oli/g,e=>e.replace("oli","li"))}</ol>`),t=t.replace(/^---+$/gm,'<hr class="chat-hr" />'),t=t.replace(/^>\s+(.+)$/gm,'<blockquote class="chat-blockquote">$1</blockquote>');const n=t.split(/\n\n+/);return t=n.map(e=>{const t=e.trim();return t.startsWith("<h")||t.startsWith("<ul")||t.startsWith("<ol")||t.startsWith("<pre")||t.startsWith("<blockquote")||t.startsWith("<hr")||t.startsWith("<p")?t:t?`<p class="chat-p">${t}</p>`:""}).filter(Boolean).join(""),t=t.replace(/<p([^>]*)>([\s\S]*?)<\/p>/g,(e,t,n)=>`<p${t}>${n.trim().replace(/\n/g,"<br>")}</p>`),t=t.replace(/<br\s*\/?>\s*(<\/?(ul|ol|li|p|h[1-6]|pre|blockquote|hr))/gi,"$1"),t=t.replace(/(<\/(ul|ol|li|p|h[1-6]|pre|blockquote)>)\s*<br\s*\/?>/gi,"$1"),t=t.replace(/<p[^>]*>\s*<\/p>/g,""),t=t.replace(/(<br\s*\/?>){2,}/g,"<br>"),t=function(e){return e&&"string"==typeof e?e.replace(/>([^<]*)</g,(e,t)=>">"+J(t)+"<"):""}(t),t}(e);return{content:G(t),isRichContent:!0}}const n=J(e);if(n!==e){const e=n.replace(/\n/g,"<br>");return{content:G(e),isRichContent:!0}}return{content:e,isRichContent:!1}},[m,i]);if(!(g||o&&0!==o.length))return null;const _=V()("nfd-ai-chat-message",`nfd-ai-chat-message--${r}`);return(0,se.jsxs)("div",{className:_,children:[g&&(f?(0,se.jsx)(se.Fragment,{children:(0,se.jsx)("div",{className:"nfd-ai-chat-message__content nfd-ai-chat-message__content--rich",dangerouslySetInnerHTML:{__html:g}})}):(0,se.jsx)("div",{className:"nfd-ai-chat-message__content nfd-ai-chat-message__content--pre-wrap",style:{whiteSpace:"pre-wrap"},children:g})),o&&o.length>0&&(0,se.jsx)(ae,{executedTools:o,toolResults:a})]})},ie=({message:e,className:t=""})=>(0,se.jsxs)("div",{className:`nfd-ai-chat-error-alert ${t}`,children:[(0,se.jsx)("div",{className:"nfd-ai-chat-error-alert__icon",children:(0,se.jsx)(X.A,{width:16,height:16})}),(0,se.jsx)("div",{className:"nfd-ai-chat-error-alert__content",children:(0,se.jsx)("div",{className:"nfd-ai-chat-error-alert__message",children:e})})]});var ce=n(2074),le=n(1045);const ue={[_]:(0,u.__)("Processing…","wp-module-ai-chat"),[w]:(0,u.__)("Getting your site ready…","wp-module-ai-chat"),[y]:(0,u.__)("Connecting…","wp-module-ai-chat"),[v]:(0,u.__)("Looking this up…","wp-module-ai-chat"),[b]:(0,u.__)("Almost there…","wp-module-ai-chat"),[x]:(0,u.__)("Message received","wp-module-ai-chat"),[S]:(0,u.__)("Thinking…","wp-module-ai-chat"),[C]:(0,u.__)("Summarizing results","wp-module-ai-chat"),[j]:(0,u.__)("Processing","wp-module-ai-chat"),[I]:(0,u.__)("Error occurred","wp-module-ai-chat")},de=({tool:e,isActive:t,progress:n,isComplete:s,isError:o})=>{const a=ne(e.name,e.arguments);return(0,se.jsxs)("div",{className:V()("nfd-ai-chat-tool-execution__item",{"nfd-ai-chat-tool-execution__item--active":t,"nfd-ai-chat-tool-execution__item--complete":s,"nfd-ai-chat-tool-execution__item--error":o}),children:[(0,se.jsxs)("div",{className:"nfd-ai-chat-tool-execution__item-header",children:[o?(0,se.jsx)(X.A,{className:"nfd-ai-chat-tool-execution__icon nfd-ai-chat-tool-execution__icon--error",size:12}):s?(0,se.jsx)(Z.A,{className:"nfd-ai-chat-tool-execution__icon nfd-ai-chat-tool-execution__icon--success",size:12}):t?(0,se.jsx)(ce.A,{className:"nfd-ai-chat-tool-execution__icon nfd-ai-chat-tool-execution__icon--active",size:12}):(0,se.jsx)(le.A,{className:"nfd-ai-chat-tool-execution__icon nfd-ai-chat-tool-execution__icon--pending",size:12}),(0,se.jsx)("span",{className:"nfd-ai-chat-tool-execution__item-title",children:a.title}),a.params&&(0,se.jsx)("span",{className:"nfd-ai-chat-tool-execution__item-params",children:a.params})]}),t&&n&&(0,se.jsx)("div",{className:"nfd-ai-chat-tool-execution__item-progress",children:n})]})},he=({status:e=null,activeToolCall:t=null,toolProgress:n=null,executedTools:s=[],pendingTools:o=[]})=>{const[a,r]=(0,l.useState)(!0),i=!!t,c=!i&&e===C&&s.length>0;(0,l.useEffect)(()=>{(i||c)&&r(!0)},[i,c]);const d=t||s.length>0||o.length>0,h=s.length+(t?1:0)+o.length;return d?(0,se.jsx)("div",{className:"nfd-ai-chat-message nfd-ai-chat-message--assistant",children:(0,se.jsx)("div",{className:"nfd-ai-chat-message__content",children:(0,se.jsxs)("div",{className:V()("nfd-ai-chat-tool-execution",{"nfd-ai-chat-tool-execution--collapsed":!a}),children:[(0,se.jsxs)("button",{type:"button",className:"nfd-ai-chat-tool-execution__header",onClick:()=>r(!a),"aria-expanded":a?"true":"false",children:[a?(0,se.jsx)(Q.A,{className:"nfd-ai-chat-tool-execution__chevron",size:12}):(0,se.jsx)(ee.A,{className:"nfd-ai-chat-tool-execution__chevron",size:12}),i?(0,se.jsxs)(se.Fragment,{children:[(0,se.jsx)("span",{children:(0,u.__)("Executing actions","wp-module-ai-chat")}),t.total>1&&(0,se.jsxs)("span",{className:"nfd-ai-chat-tool-execution__header-count",children:["(",t.index,"/",t.total,")"]})]}):c?(0,se.jsxs)(se.Fragment,{children:[(0,se.jsx)(ce.A,{className:"nfd-ai-chat-tool-execution__icon nfd-ai-chat-tool-execution__icon--active",size:12}),(0,se.jsx)("span",{children:(0,u.__)("Processing","wp-module-ai-chat")}),(0,se.jsxs)("span",{className:"nfd-ai-chat-tool-execution__header-count",children:["(",s.length,")"]})]}):(0,se.jsxs)(se.Fragment,{children:[(0,se.jsx)("span",{children:(0,u.__)("Actions completed","wp-module-ai-chat")}),(0,se.jsxs)("span",{className:"nfd-ai-chat-tool-execution__header-count",children:["(",h,")"]})]})]}),a&&(0,se.jsxs)("div",{className:"nfd-ai-chat-tool-execution__list",children:[s.map((e,t)=>(0,se.jsx)(de,{tool:e,isActive:!1,isComplete:!e.isError,isError:e.isError,progress:null},e.id||`executed-${t}`)),t&&(0,se.jsx)(de,{tool:t,isActive:!0,isComplete:!1,isError:!1,progress:n},t.id||"active"),c&&(0,se.jsx)(de,{tool:{name:"preparing-changes"},isActive:!0,isComplete:!1,isError:!1,progress:null},"preparing"),o.map((e,t)=>(0,se.jsx)(de,{tool:e,isActive:!1,isComplete:!1,isError:!1,progress:null},e.id||`pending-${t}`))]})]})})}):(0,se.jsx)("div",{className:"nfd-ai-chat-message nfd-ai-chat-message--assistant",children:(0,se.jsx)("div",{className:"nfd-ai-chat-message__content",children:(0,se.jsxs)("div",{className:"nfd-ai-chat-typing-indicator",children:[(0,se.jsxs)("span",{className:"nfd-ai-chat-typing-indicator__dots","aria-hidden":"true",children:[(0,se.jsx)("span",{}),(0,se.jsx)("span",{}),(0,se.jsx)("span",{})]}),(0,se.jsx)("span",{className:"nfd-ai-chat-typing-indicator__text",children:null!==(p=ue[e])&&void 0!==p?p:(0,u.__)("Thinking…","wp-module-ai-chat")})]})})});var p},pe=({messages:e=[],isLoading:t=!1,error:n=null,status:s=null,activeToolCall:o=null,toolProgress:a=null,executedTools:r=[],pendingTools:i=[],onRetry:c,connectionFailed:d=!1,isConnectingOrReconnecting:h=!1,messageBubbleStyle:p="bubbles"})=>{const m=(0,l.useRef)(null),[g,f]=(0,l.useState)(0),_=(0,l.useCallback)(()=>{const e=m.current;e&&e.scrollTo({top:e.scrollHeight-e.clientHeight,behavior:"smooth"})},[]);(0,l.useEffect)(()=>{_()},[e,t,a,g,_]);const w=(0,l.useCallback)(()=>{f(e=>e+1)},[]),y=o||r.length>0||i.length>0,v=V()("nfd-ai-chat-messages",{"nfd-ai-chat-messages--minimal":"minimal"===p});return(0,se.jsxs)("div",{ref:m,className:v,children:[e.length>0&&e.map((t,n)=>{const s=n===e.length-1&&("assistant"===t.type||"assistant"===t.role);return(0,se.jsx)(re,{message:t.content,type:t.type,animateTyping:s&&!0===t.animateTyping,onContentGrow:s?w:void 0,executedTools:t.executedTools,toolResults:t.toolResults},t.id||n)}),h&&!d&&(0,se.jsx)("div",{className:"nfd-ai-chat-message nfd-ai-chat-message--assistant",children:(0,se.jsx)("div",{className:"nfd-ai-chat-message__content",children:(0,se.jsxs)("div",{className:"nfd-ai-chat-typing-indicator",children:[(0,se.jsxs)("span",{className:"nfd-ai-chat-typing-indicator__dots","aria-hidden":"true",children:[(0,se.jsx)("span",{}),(0,se.jsx)("span",{}),(0,se.jsx)("span",{})]}),(0,se.jsx)("span",{className:"nfd-ai-chat-typing-indicator__text",children:(0,u.__)("Connecting....","wp-module-ai-chat")})]})})}),n&&(0,se.jsx)(ie,{message:n}),c&&(n||d)&&(0,se.jsx)("p",{className:"nfd-ai-chat-messages__retry",children:(0,se.jsx)("button",{type:"button",className:"nfd-ai-chat-messages__retry-button",onClick:c,children:(0,u.__)("Retry","wp-module-ai-chat")})}),t&&(0,se.jsx)(he,{status:s,activeToolCall:o,toolProgress:a,executedTools:y?r:[],pendingTools:i})]})};var me=n(6427),ge=n(5963),fe=n(9947);const _e=({onSendMessage:e,onStopRequest:t,disabled:n=!1,showStopButton:s,placeholder:o,contextComponent:a=null,showTopBorder:r=!0})=>{const i=!0===s,[c,d]=(0,l.useState)(""),[h,p]=(0,l.useState)(!1),m=(0,l.useRef)(null),g=(0,u.__)("How can I help you today?","wp-module-ai-chat");(0,l.useEffect)(()=>{if(m.current){m.current.style.height="auto";const e=m.current.scrollHeight,t=Math.min(e,200);m.current.style.height=`${t}px`,m.current.style.overflowY=e>200?"auto":"hidden"}},[c]),(0,l.useEffect)(()=>{!n&&m.current&&setTimeout(()=>{m.current.focus()},100)},[n]);const f=(0,l.useCallback)(()=>{c.trim()&&!n&&(e(c),d(""),m.current&&(m.current.style.height="auto",m.current.style.overflowY="hidden",m.current.focus()))},[c,n,e]),_=(0,l.useCallback)(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),f())},[f]),w=(0,l.useCallback)(()=>{h||(p(!0),t&&t(),setTimeout(()=>{p(!1)},500))},[h,t]),y=V()("nfd-ai-chat-input",{"nfd-ai-chat-input--no-top-border":!r});return(0,se.jsxs)("div",{className:y,children:[(0,se.jsxs)("div",{className:"nfd-ai-chat-input__container",children:[(0,se.jsx)("textarea",{name:"nfd-ai-chat-input",ref:m,value:c,onChange:e=>d(e.target.value),onKeyDown:_,placeholder:o||g,className:"nfd-ai-chat-input__textarea",rows:1,disabled:n}),(0,se.jsxs)("div",{className:"nfd-ai-chat-input__actions",children:[a,i?(0,se.jsx)(me.Button,{icon:(0,se.jsx)(ge.A,{width:16,height:16}),label:(0,u.__)("Stop generating","wp-module-ai-chat"),onClick:w,className:"nfd-ai-chat-input__stop",disabled:h,"aria-busy":h}):(0,se.jsx)(me.Button,{icon:(0,se.jsx)(fe.A,{width:16,height:16}),label:(0,u.__)("Send message","wp-module-ai-chat"),onClick:f,className:"nfd-ai-chat-input__submit",disabled:!c.trim()||n})]})]}),(0,se.jsx)("div",{className:"nfd-ai-chat-input__disclaimer",children:(0,u.__)("AI-generated content is not guaranteed for accuracy.","wp-module-ai-chat")})]})},we=e=>(0,se.jsx)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",focusable:"false",...e,children:(0,se.jsx)("path",{d:"M18 6L6 18M6 6l12 12",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})}),ye=e=>(0,se.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true",focusable:"false",...e,children:[(0,se.jsx)("path",{d:"m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"}),(0,se.jsx)("path",{d:"M5 3v4"}),(0,se.jsx)("path",{d:"M19 17v4"}),(0,se.jsx)("path",{d:"M3 5h4"}),(0,se.jsx)("path",{d:"M17 19h4"})]}),ve=()=>(0,se.jsx)("span",{className:"nfd-ai-chat-blu-beta-badge",children:(0,u.__)("BETA","wp-module-ai-chat")}),be=({title:e,badge:t,logo:n,leftActions:s,rightActions:o,className:a=""})=>(0,se.jsxs)("div",{className:`nfd-ai-chat-header ${a}`.trim(),role:"banner",children:[(0,se.jsxs)("div",{className:"nfd-ai-chat-header__brand",children:[n,null!=e&&(0,se.jsx)("span",{className:"nfd-ai-chat-header__title",children:e}),t]}),(s||o)&&(0,se.jsxs)("div",{className:"nfd-ai-chat-header__actions",children:[s,o]})]}),xe=({title:e,onNewChat:t,onClose:n,extraActions:s,newChatDisabled:o=!1})=>(0,se.jsx)(be,{logo:(0,se.jsx)(ye,{width:20,height:20}),title:e||(0,u.__)("Blu Chat","wp-module-ai-chat"),badge:(0,se.jsx)(ve,{}),rightActions:(0,se.jsxs)(se.Fragment,{children:["function"==typeof t&&(0,se.jsx)("button",{type:"button",className:"nfd-ai-chat-header__btn nfd-ai-chat-header__btn--new",onClick:o?void 0:t,disabled:o,"aria-label":(0,u.__)("New chat","wp-module-ai-chat"),title:(0,u.__)("New chat","wp-module-ai-chat"),children:"+"}),s,"function"==typeof n&&(0,se.jsx)("button",{type:"button",className:"nfd-ai-chat-header__btn nfd-ai-chat-header__btn--close",onClick:n,"aria-label":(0,u.__)("Close","wp-module-ai-chat"),title:(0,u.__)("Close","wp-module-ai-chat"),children:(0,se.jsx)(we,{})})]})}),Se=({width:e=24,height:t=24,...n})=>(0,se.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 30 30",width:e,height:t,...n,children:[(0,se.jsx)("path",{d:"M14.217,19.707l-1.112,2.547c-0.427,0.979-1.782,0.979-2.21,0l-1.112-2.547c-0.99-2.267-2.771-4.071-4.993-5.057L1.73,13.292c-0.973-0.432-0.973-1.848,0-2.28l2.965-1.316C6.974,8.684,8.787,6.813,9.76,4.47l1.126-2.714c0.418-1.007,1.81-1.007,2.228,0L14.24,4.47c0.973,2.344,2.786,4.215,5.065,5.226l2.965,1.316c0.973,0.432,0.973,1.848,0,2.28l-3.061,1.359C16.988,15.637,15.206,17.441,14.217,19.707z"}),(0,se.jsx)("path",{d:"M24.481,27.796l-0.339,0.777c-0.248,0.569-1.036,0.569-1.284,0l-0.339-0.777c-0.604-1.385-1.693-2.488-3.051-3.092l-1.044-0.464c-0.565-0.251-0.565-1.072,0-1.323l0.986-0.438c1.393-0.619,2.501-1.763,3.095-3.195l0.348-0.84c0.243-0.585,1.052-0.585,1.294,0l0.348,0.84c0.594,1.432,1.702,2.576,3.095,3.195l0.986,0.438c0.565,0.251,0.565,1.072,0,1.323l-1.044,0.464C26.174,25.308,25.085,26.411,24.481,27.796z"})]}),Ce=({width:e=24,height:t=24})=>(0,se.jsx)("div",{className:"nfd-ai-chat-avatar",style:{width:e,height:t},children:(0,se.jsx)(Se,{width:.625*e,height:.625*t})}),je=({icon:e,text:t,onClick:n,className:s=""})=>(0,se.jsxs)(me.Button,{className:`nfd-ai-chat-suggestion ${s}`,onClick:n,children:[(0,se.jsx)("div",{className:"nfd-ai-chat-suggestion__icon",children:e}),(0,se.jsx)("div",{className:"nfd-ai-chat-suggestion__text",children:t})]}),Ie=({onSendMessage:e,title:t,subtitle:n,suggestions:s=[],showSuggestions:o=!1,animateWelcome:a=!1})=>{const r=(0,u.__)("Hi, I'm your AI assistant.","wp-module-ai-chat"),i=(0,u.__)("How can I help you today?","wp-module-ai-chat"),c=t||r,d=n||i,h=`${c} ${d}`,[p,m]=(0,l.useState)(0),g=(0,l.useRef)(null);(0,l.useEffect)(()=>{if(!a)return void m(h.length);m(0);const e=()=>{m(t=>t>=h.length?t:(g.current=setTimeout(e,40),t+1))};return g.current=setTimeout(e,40),()=>{g.current&&clearTimeout(g.current)}},[a,h]);const f=a&&p<h.length,_=f&&p<=c.length?c.slice(0,p):c;let w=d;return f&&p>c.length?w=d.slice(0,p-c.length-1):f&&(w=""),(0,se.jsxs)("div",{className:"nfd-ai-chat-welcome",children:[(0,se.jsxs)("div",{className:"nfd-ai-chat-welcome__content",children:[(0,se.jsx)("div",{className:"nfd-ai-chat-welcome__avatar",children:(0,se.jsx)(Ce,{width:64,height:64})}),(0,se.jsxs)("div",{className:"nfd-ai-chat-welcome__message",children:[(0,se.jsx)("div",{className:"nfd-ai-chat-welcome__title",children:_}),(0,se.jsxs)("div",{className:"nfd-ai-chat-welcome__subtitle",children:[w,f&&p<h.length&&(0,se.jsx)("span",{className:"nfd-ai-chat-welcome__cursor","aria-hidden":"true"})]})]})]}),o&&s.length>0&&(0,se.jsx)("div",{className:"nfd-ai-chat-suggestions",children:s.map((t,n)=>{var s,o;return(0,se.jsx)(je,{icon:t.icon,text:t.text,onClick:()=>e(t.action||t.text)},null!==(s=null!==(o=t.action)&&void 0!==o?o:t.text)&&void 0!==s?s:n)})})]})};function Ne(e,t,n,s,o={}){var a;if(!e||0===e.length)return;if(!e.some(e=>("user"===e.role||"user"===e.type)&&e.content&&String(e.content).trim()))return;if(null===t&&null===n)return;const r=null!==(a=o.maxHistoryItems)&&void 0!==a?a:3,i=f(s);try{const s=JSON.parse(window.localStorage.getItem(i.archive)||"[]"),o={sessionId:t,conversationId:n,messages:e.map(e=>({...e,timestamp:e.timestamp instanceof Date?e.timestamp.toISOString():e.timestamp})),archivedAt:(new Date).toISOString()},a=null!=n?s.filter(e=>e.conversationId!==n):s.filter(e=>e.sessionId!==t);a.unshift(o),window.localStorage.setItem(i.archive,JSON.stringify(a.slice(0,r)))}catch(e){console.warn("[Chat History] Failed to archive conversation:",e)}}var ke=n(2836),$e=n(6849);function Ae(e){const t=e.messages||e;return Array.isArray(t)&&t.some(e=>("user"===e.role||"user"===e.type)&&e.content&&String(e.content).trim())}const Te=({consumer:e,onSelectConversation:t,refreshTrigger:n=0,disabled:s=!1,emptyMessage:o=null,maxHistoryItems:a=3})=>{const[r,i]=(0,l.useState)([]),c=f(e);(0,l.useEffect)(()=>{try{const e=window.localStorage.getItem(c.archive);if(e){const t=JSON.parse(e);if(Array.isArray(t)&&t.length>0){const e=t.slice(0,a);e.length<t.length&&window.localStorage.setItem(c.archive,JSON.stringify(e));const n=e.map(e=>{var t,n;const s=(e.messages||[]).map(e=>({...e,timestamp:e.timestamp?new Date(e.timestamp):new Date})),o=e.archivedAt?new Date(e.archivedAt):null;return{sessionId:null!==(t=e.sessionId)&&void 0!==t?t:null,conversationId:null!==(n=e.conversationId)&&void 0!==n?n:null,messages:s,archivedAt:o}}).filter(Ae);return void i(n)}}const t=window.localStorage.getItem(c.history);if(t){const e=JSON.parse(t);if(Array.isArray(e)&&e.length>0){const t=function(e,t){if(!Array.isArray(e)||0===e.length)return[];const n={},s=[];e.forEach(e=>{if(e.sessionId){n[e.sessionId]||(n[e.sessionId]={sessionId:e.sessionId,messages:[],timestamp:e.timestamp?new Date(e.timestamp).getTime():0}),n[e.sessionId].messages.push(e);const t=e.timestamp?new Date(e.timestamp).getTime():0;t>n[e.sessionId].timestamp&&(n[e.sessionId].timestamp=t)}else s.push(e)});let o=Object.values(n).sort((e,t)=>t.timestamp-e.timestamp).map(e=>({sessionId:e.sessionId,messages:e.messages}));if(s.length>0&&o.length<t){const e=function(e){const t=[];let n=[],s=null;return e.forEach(e=>{const o=e.timestamp?new Date(e.timestamp).getTime():Date.now();s&&o-s>3e5&&n.length>0&&(t.push({sessionId:null,messages:[...n]}),n=[]),n.push(e),s=o}),n.length>0&&t.push({sessionId:null,messages:n}),t.reverse()}(s);o=[...o,...e]}return o=o.filter(Ae),o.slice(0,t)}(e.map(e=>({...e,timestamp:e.timestamp?new Date(e.timestamp):new Date})),a);i(t)}}}catch(e){console.warn("[Chat History] Failed to load chat history:",e)}},[e,n,a,c.archive,c.history]);const d=(0,l.useCallback)(e=>{if(!s)try{const n=(e.messages||e).map(e=>({...e,timestamp:e.timestamp instanceof Date?e.timestamp.toISOString():e.timestamp}));window.localStorage.setItem(c.history,JSON.stringify(n)),e.sessionId&&window.localStorage.setItem(c.sessionId,e.sessionId),e.conversationId&&window.localStorage.setItem(c.conversationId,e.conversationId),t&&t(e)}catch(e){console.warn("[Chat History] Failed to restore conversation:",e)}},[s,c,t]),h=(0,l.useCallback)((e,t)=>{if(e.stopPropagation(),e.preventDefault(),!s)try{const e=window.localStorage.getItem(c.archive);if(e){const n=JSON.parse(e).filter((e,n)=>n!==t);window.localStorage.setItem(c.archive,JSON.stringify(n))}i(e=>e.filter((e,n)=>n!==t))}catch(e){console.warn("[Chat History] Failed to delete conversation:",e)}},[s,c]);return 0===r.length?o?(0,se.jsx)("div",{className:"nfd-ai-chat-history-list nfd-ai-chat-history-list--empty",children:o}):null:(0,se.jsx)("div",{className:"nfd-ai-chat-history-list",children:r.map((e,t)=>{const n=(e=>{const t=(e.messages||e).find(e=>"user"===e.role||"user"===e.type);if(t&&t.content){const e=t.content;return e.length>50?e.substring(0,50)+"...":e}return(0,u.__)("Previous conversation","wp-module-ai-chat")})(e),o=e.sessionId||`legacy-${t}`,a=e.archivedAt||function(e){const t=e.messages||e;if(!Array.isArray(t)||0===t.length)return null;let n=0;return t.forEach(e=>{const t=e.timestamp?new Date(e.timestamp).getTime():0;t>n&&(n=t)}),n?new Date(n):null}(e)||null,r=a?(e=>{const t=e instanceof Date?e:new Date(e),n=Date.now()-t.getTime(),s=Math.floor(n/6e4);if(s<1)return(0,u.__)("Just now","wp-module-ai-chat");if(s<60)return`${s}m`;const o=Math.floor(n/36e5);if(o<24)return`${o}h`;const a=Math.floor(n/864e5);return a<7?`${a}d`:t.toLocaleDateString(void 0,{month:"short",day:"numeric"})})(a):null;return(0,se.jsxs)("div",{className:"nfd-ai-chat-history-item"+(s?" nfd-ai-chat-history-item--disabled":""),role:"button",tabIndex:s?-1:0,"aria-disabled":s,onClick:()=>d(e),onKeyDown:t=>{s||"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),d(e))},children:[(0,se.jsx)(ke.A,{width:14,height:14,"aria-hidden":!0}),(0,se.jsxs)("div",{className:"nfd-ai-chat-history-item__content",children:[(0,se.jsx)("span",{className:"nfd-ai-chat-history-item__title",children:n}),(0,se.jsxs)("div",{className:"nfd-ai-chat-history-item__meta",children:[r&&(0,se.jsx)("span",{className:"nfd-ai-chat-history-item__time",children:r}),(0,se.jsx)("button",{type:"button",className:"nfd-ai-chat-history-item__delete",onClick:e=>h(e,t),"aria-label":(0,u.__)("Delete conversation","wp-module-ai-chat"),title:(0,u.__)("Delete","wp-module-ai-chat"),children:(0,se.jsx)($e.A,{width:14,height:14,className:"nfd-ai-chat-history-item__delete-icon","aria-hidden":!0})})]})]})]},o)})})},Re=e=>(0,se.jsxs)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",focusable:"false",...e,children:[(0,se.jsx)("circle",{cx:"12",cy:"12",r:"9",stroke:"currentColor",strokeWidth:"2"}),(0,se.jsx)("path",{d:"M12 7v5l3 3",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})]}),Ee=({consumer:e,open:t,onOpenChange:n,onSelectConversation:s,refreshTrigger:o=0,disabled:a=!1,maxHistoryItems:r})=>{const i=(0,l.useRef)(null),c=(0,l.useRef)(null),[d,h]=(0,l.useState)({top:0,left:0,openUp:!1}),p=(0,l.useCallback)(()=>{if(!i.current)return;const e=i.current.getBoundingClientRect(),t=window.innerHeight-e.bottom,n=t<240&&e.top>t;h({top:n?e.top:e.bottom,left:e.right,openUp:n})},[]);(0,l.useLayoutEffect)(()=>{t&&p()},[t,p]),(0,l.useEffect)(()=>{if(!t)return;const e=()=>p();return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[t,p]),(0,l.useEffect)(()=>{if(!t)return;const e=e=>{i.current?.contains(e.target)||c.current?.contains(e.target)||n(!1)},s=e=>{"Escape"===e.key&&n(!1)};return document.addEventListener("mousedown",e),document.addEventListener("keydown",s),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("keydown",s)}},[t,n]);const m=(0,l.useCallback)(e=>{s(e),n(!1)},[s,n]),g=(0,l.useCallback)(()=>{a||n(!t)},[a,t,n]),f=(0,se.jsx)("div",{ref:c,className:"nfd-ai-chat-history-dropdown",role:"dialog","aria-label":(0,u.__)("Chat history","wp-module-ai-chat"),style:{position:"fixed",top:d.openUp?"auto":d.top,bottom:d.openUp?window.innerHeight-d.top:"auto",left:"auto",right:window.innerWidth-d.left,zIndex:1e5},children:(0,se.jsx)("div",{className:"nfd-ai-chat-history-dropdown-inner",children:(0,se.jsx)(Te,{consumer:e,onSelectConversation:m,disabled:a,refreshTrigger:t?o:0,emptyMessage:(0,u.__)("No conversations yet.","wp-module-ai-chat"),maxHistoryItems:r})})});return(0,se.jsxs)("div",{className:"nfd-ai-chat-history-dropdown-wrapper",children:[(0,se.jsx)("button",{ref:i,type:"button",className:"nfd-ai-chat-history-dropdown-trigger "+(t?"is-open":""),onClick:g,disabled:a,"aria-expanded":t,"aria-haspopup":"true","aria-label":(0,u.__)("Chat history","wp-module-ai-chat"),title:(0,u.__)("Chat history","wp-module-ai-chat"),children:(0,se.jsx)(Re,{})}),t&&(0,l.createPortal)(f,document.body)]})};var De=n(3875),Oe=n(9567);function Me(e){const t=e&&String(e).trim()?`"${String(e).trim()}"`:"this",n=window?.nfdHelpCenter?.resourceLink||"#",s=(0,u.__)("Resource center","wp-module-help-center"),o=(0,u.__)("You can try searching our","wp-module-help-center"),a=(0,u.__)("though to see if there's a helpful article or video on that subject.","wp-module-help-center"),r=(0,u.sprintf)(/* translators: %s: the user's search query (or the word "this" if empty) */ /* translators: %s: the user's search query (or the word "this" if empty) */
(0,u.__)("Sorry, I don't have any information on %s yet.","wp-module-help-center"),t),i=(0,u.__)("Try to:","wp-module-help-center"),c=(0,u.__)("Use different keywords in the search field.","wp-module-help-center"),l=(0,u.__)("A clear, short prompt can make the difference.","wp-module-help-center"),d=(0,u.__)("Reach out to our customer support.","wp-module-help-center"),h=(0,u.__)("Call at","wp-module-help-center"),p=(0,u.__)("or","wp-module-help-center"),m=(0,u.__)("Chat Live","wp-module-help-center"),g=(0,u.__)("with one of our support agents — we will assist you as soon as possible.","wp-module-help-center");return["<p>"+Le(r)+"</p>","<p><strong>"+i+"</strong></p>","<ul>","<li>"+Le(o)+' <a href="'+(f=n,Le(f)+'" target="_blank" rel="noopener noreferrer">')+Le(s)+"</a> "+Le(a)+"</li>","<li>"+Le(c+" "+l)+"</li>","<li>"+Le(d+" "+h)+' <a href="tel:8884014678">888-401-4678</a> '+Le(p)+" "+Le(m)+" "+Le(g)+"</li>","</ul>"].join("");var f}function Le(e){return"string"!=typeof e?"":e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}var Ue=n(1069),Fe=n(4989),Pe=n(7738);const We=()=>{const[e]=(()=>{const[e,t]=(0,l.useState)(()=>Ue.Sp.getHelpVisible());return(0,l.useEffect)(()=>{const e=()=>{t(Ue.Sp.getHelpVisible())};return window.addEventListener("storage",e),()=>{window.removeEventListener("storage",e)}},[]),[e,t]})(),{hasLaunchedFromTooltip:t}=(0,Fe.X)(),{onClose:n}=(0,Oe.b_)(),s=(0,l.useRef)(!1),[o,a]=(0,l.useState)(!1),[r,i]=(0,l.useState)(0);(0,l.useEffect)(()=>{const e=f("help_center");try{if(!localStorage.getItem(e.history)){const t=localStorage.getItem(e.archive);if(t){const n=JSON.parse(t),s=Array.isArray(n)&&n[0];if(s?.messages?.length>0&&s?.archivedAt){const t=18e5,n=new Date(s.archivedAt).getTime();if(Date.now()-n<=t){const t=s.messages.map(e=>({...e,timestamp:e.timestamp instanceof Date?e.timestamp.toISOString():e.timestamp}));localStorage.setItem(e.history,JSON.stringify(t)),null!==s.conversationId&&void 0!==s.conversationId&&localStorage.setItem(e.conversationId,String(s.conversationId)),null!==s.sessionId&&void 0!==s.sessionId&&localStorage.setItem(e.sessionId,String(s.sessionId))}}}}}catch(e){}},[]);const{messages:c,sendMessage:d,sendSystemMessage:h,isTyping:p,status:m,currentResponse:g,conversationId:_,clearApprovalRequest:w,clearTyping:y,updateMessage:v,stopRequest:b,clearChatHistory:x,loadConversation:S,getSessionId:C,error:j,connectionState:I,isConnecting:N,manualRetry:k}=F({configEndpoint:"undefined"!=typeof window&&window.nfdHelpCenter?.restUrl?window.nfdHelpCenter.restUrl+"/nfd-agents/chat/v1/config":"/nfd-agents/chat/v1/config",consumer:"help_center",autoConnect:e,consumerType:"help_center",autoLoadHistory:!0,getConnectionFailedFallbackMessage:Me});(0,l.useEffect)(()=>{c.length>0&&Ne(c,C(),_,"help_center")},[c,C,_]),(0,l.useEffect)(()=>{const e=()=>{c.length>0&&Ne(c,C(),_,"help_center")};return window.addEventListener("beforeunload",e),()=>window.removeEventListener("beforeunload",e)},[c,C,_]);const $=(0,l.useCallback)(e=>{var t,n;const s=e.messages||e;S(s,null!==(t=e.conversationId)&&void 0!==t?t:null,null!==(n=e.sessionId)&&void 0!==n?n:null)},[S]),A=(0,l.useCallback)(()=>{v&&v(e=>"approval_request"===e.type&&e.approvalRequest,e=>({...e,type:"assistant",content:(0,u.__)("Action approved and executed.","wp-module-help-center"),approvalRequest:null})),w()},[w,v]),T=(0,l.useCallback)(()=>{v&&v(e=>"approval_request"===e.type&&e.approvalRequest,e=>{const t=e.approvalRequest?.tool_name||"action";return{...e,type:"assistant",content:(0,u.sprintf)(/* translators: %s: the name of the action or tool that was cancelled */ /* translators: %s: the name of the action or tool that was cancelled */
(0,u.__)('Action "%s" was cancelled.',"wp-module-help-center"),t),approvalRequest:null}}),w()},[w,v]),R=(0,l.useCallback)(()=>{s.current=!1,c.length>0&&Ne(c,C(),_,"help_center"),x(),i(e=>e+1)},[c,C,_,x]),E=(0,l.useCallback)(()=>{s.current=!1,function(e,t){const n=f("help_center");try{const s=JSON.parse(window.localStorage.getItem(n.archive)||"[]"),o=s.filter(n=>n.conversationId!==e||n.sessionId!==t);o.length!==s.length&&window.localStorage.setItem(n.archive,JSON.stringify(o))}catch(e){console.warn("[Chat History] Failed to remove conversation from archive:",e)}}(_,C()),x(),i(e=>e+1)},[_,C,x]),D=[...c];g&&p&&D.push({id:"streaming",role:"assistant",type:"assistant",content:g,timestamp:new Date});const O=0===D.length&&!s.current;(0,l.useEffect)(()=>{D.length>0&&(s.current=!0)},[D.length]);const M=c.length>0,L=c.length>0;let U;return U=O?(0,se.jsx)("div",{className:"nfd-help-center-chat__welcome-wrapper",children:(0,se.jsx)(Ie,{onSendMessage:d,title:(0,u.__)("Hi, I'm BLU, your AI assistant.","wp-module-help-center"),subtitle:(0,u.__)("I can help you create and edit posts and pages, update content, and manage your WordPress site.","wp-module-help-center"),showSuggestions:!1})}):(0,se.jsxs)("div",{className:"nfd-help-center-chat__messages-wrapper",children:[c.length>0&&(0,se.jsx)("div",{className:"nfd-help-center-chat__messages-header",children:(0,se.jsx)("button",{onClick:E,className:"nfd-help-center-chat__clear-chat-button","aria-label":(0,u.__)("Clear chat","wp-module-help-center"),children:(0,u.__)("Clear Chat","wp-module-help-center")})}),(0,se.jsx)(pe,{messages:D,isLoading:L&&p,status:m,error:j,onRetry:L&&"failed"===I?k:void 0,connectionFailed:L&&"failed"===I,isConnectingOrReconnecting:L&&("connecting"===I||"reconnecting"===I),onApprove:A,onReject:T,onSendMessage:d,onSendSystemMessage:h,conversationId:_,onClearTyping:y,brandId:null})]}),(0,se.jsxs)("div",{className:"nfd-help-center-chat nfd-ai-chat-container",children:[(0,se.jsx)("div",{className:"nfd-help-center-chat__header-wrapper",children:(0,se.jsx)(xe,{title:(0,u.__)("Blu Chat","wp-module-help-center"),onNewChat:R,newChatDisabled:O||L&&("failed"===I||"connecting"===I||"reconnecting"===I),onClose:n,extraActions:(0,se.jsx)(Ee,{consumer:"help_center",open:o,onOpenChange:e=>{a(e),e&&i(e=>e+1)},onSelectConversation:e=>{$(e),a(!1)},refreshTrigger:r,disabled:!1})})}),U,(0,se.jsx)("div",{className:"nfd-help-center-chat__input-area",children:(0,se.jsx)("div",{className:"nfd-help-center-chat__input-wrapper",children:(0,se.jsx)(_e,{onSendMessage:d,onStopRequest:b,showStopButton:p,disabled:p||L&&("failed"===I||"connecting"===I||"reconnecting"===I),placeholder:(0,u.__)("Ask me anything about WordPress…","wp-module-help-center"),showTopBorder:!1})})}),(0,Pe.$)(t)&&(0,se.jsx)("div",{className:"nfd-help-center-chat__footer-wrapper"+(M?" nfd-help-center-chat__footer-wrapper--collapsed":""),"aria-hidden":M,children:(0,se.jsx)(De.A,{})})]})}}}]);