"use strict";(globalThis.webpackChunk_newfold_labs_wp_module_help_center=globalThis.webpackChunk_newfold_labs_wp_module_help_center||[]).push([[778],{2778:(e,t,s)=>{s.d(t,{default:()=>te});var n=s(8394),a=s(2975);const o=(e,t="")=>{if(e.includes("rest_route="))return e;const s=e.match(/\/wp-json\/(.+)$/);if(!s)return e;const n=s[1];t||"undefined"==typeof window||(t=window.location.origin);const a=t.replace(/\/wp-json\/?$/,""),o=a.includes("?")?"&":"?";return`${a}${o}rest_route=/${n}`};class r extends Error{constructor(e,t=null,s=null){super(e),this.name="MCPError",this.code=t,this.details=s}}new class{constructor(e={}){this.configKey=e.configKey||"nfdAIChat",this.client=null,this.transport=null,this.connected=!1,this.tools=[],this.resources=[],this.eventListeners=new Map}getConfig(){const e="undefined"!=typeof window&&window[this.configKey]||{},t=e.homeUrl||("undefined"!=typeof window?window.location.origin:"");let s=e.restUrl||"/wp-json/";s.includes("/wp-json/")?s=o(s,t):s.includes("rest_route=")||(s=o("/wp-json/",t));let n=e.mcpUrl;return n?n.includes("/wp-json/")&&(n=o(n,t)):n=((e,t,s="")=>{const n=((e="")=>{if(e&&e.includes("rest_route="))return e;e||"undefined"==typeof window||(e=window.location.origin);const t=e.includes("?")?"&":"?";return`${e}${t}rest_route=/`})(s),a=`${e}/${t}`;if(n.includes("rest_route="))return n.replace("rest_route=/",`rest_route=/${a}`);const o=n.includes("?")?"&":"?";return`${n}${o}rest_route=/${a}`})("mcp","mcp-adapter-default-server",t),{nonce:e.nonce||"",restUrl:s,mcpUrl:n,homeUrl:t}}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(t)}off(e,t){const s=this.eventListeners.get(e);s&&s.delete(t)}emit(e){const t=this.eventListeners.get(e.type);t&&t.forEach(t=>{try{t(e)}catch(e){console.error("Error in MCP event listener:",e)}})}async connect(e=null){try{const t=this.getConfig(),s=e||t.mcpUrl;if(!s)throw new r("MCP endpoint URL not configured");this.client=new n.K({name:"nfd-ai-chat-client",version:"1.0.0"},{capabilities:{}}),this.transport=new a.j(new URL(s),{requestInit:{headers:{"Content-Type":"application/json"}}}),await this.client.connect(this.transport),this.connected=!0,this.emit({type:"connected"})}catch(e){const t=e instanceof r?e:new r(`Connection failed: ${e.message}`);throw this.emit({type:"error",data:t}),t}}async initialize(){if(!this.connected)throw new r("Not connected to MCP server");try{await Promise.all([this.loadTools(),this.loadResources()]);const e={protocolVersion:"2025-06-18",capabilities:{tools:{},resources:{},prompts:{}},serverInfo:{name:"WordPress MCP Server",version:"1.0.0"}};return this.emit({type:"initialized",data:e}),e}catch(e){const t=e instanceof r?e:new r(`Initialization failed: ${e.message}`);throw this.emit({type:"error",data:t}),t}}normalizeInputSchema(e){return!e||Array.isArray(e)||"object"!=typeof e||0===Object.keys(e).length?{type:"object",properties:{},required:[]}:{type:e.type||"object",properties:e.properties||{},required:Array.isArray(e.required)?e.required:[]}}async loadTools(){try{const e=await this.client.listTools();this.tools=e.tools.map(e=>({name:e.name,description:e.description||"",inputSchema:this.normalizeInputSchema(e.inputSchema),annotations:e.annotations||{}})),this.emit({type:"tools_updated",data:this.tools})}catch(e){console.error("Failed to load tools via SDK:",e),this.tools=[]}}async loadResources(){try{const e=await this.client.listResources();this.resources=e.resources.map(e=>({uri:e.uri,name:e.name||"",description:e.description,mimeType:e.mimeType})),this.emit({type:"resources_updated",data:this.resources})}catch(e){console.error("Failed to load resources via SDK:",e),this.resources=[]}}async listTools(){if(!this.connected)throw new r("Not connected to MCP server");return this.tools}async callTool(e,t={}){if(!this.connected)throw new r("Not connected to MCP server");try{const s=await this.client.callTool({name:e,arguments:t});return{content:Array.isArray(s.content)?s.content:[],isError:Boolean(s.isError),meta:s.meta||{}}}catch(t){console.error(`Tool "${e}" call failed:`,t);const s=t instanceof r?t:new r(`Tool call failed: ${t.message}`);throw this.emit({type:"error",data:s}),s}}async listResources(){if(!this.connected)throw new r("Not connected to MCP server");return this.resources}async readResource(e){if(!this.connected)throw new r("Not connected to MCP server");try{return await this.client.readResource({uri:e})}catch(t){console.error(`Resource "${e}" read failed:`,t);const s=t instanceof r?t:new r(`Resource read failed: ${t.message}`);throw this.emit({type:"error",data:s}),s}}async disconnect(){try{this.transport&&(await this.client.close(),this.transport=null),this.connected=!1,this.tools=[],this.resources=[],this.emit({type:"disconnected"})}catch(e){console.error("Error during SDK disconnect:",e)}}isConnected(){return this.connected}getTools(){return[...this.tools]}getResources(){return[...this.resources]}isToolReadOnly(e){const t=this.tools.find(t=>t.name===e);return!t||!0===t.annotations?.readonly||!0===t.annotations?.readOnlyHint}getToolsForOpenAI(){return this.tools.map(e=>{const t=this.normalizeInputSchema(e.inputSchema);return{type:"function",function:{name:e.name,description:e.description||"",parameters:t}}})}};var c=s(3556);const i="gpt-4o-mini";class l extends Error{constructor(e,t=null,s=null){super(e),this.name="OpenAIError",this.status=t,this.code=s}}new class{constructor(e={}){this.configKey=e.configKey||"nfdAIChat",this.apiPath=e.apiPath||"ai",this.mode=e.mode||"help",this.openai=null,this.config=null}getConfig(){if(this.config)return this.config;if("undefined"!=typeof window&&window[this.configKey]){const e=window[this.configKey].homeUrl||window.location.origin;let t=window[this.configKey].restUrl||"/wp-json/";t.includes("/wp-json/")?t=o(t,e):t.includes("rest_route=")||(t=o("/wp-json/",e)),this.config={nonce:window[this.configKey].nonce,restUrl:t,homeUrl:e}}else this.config={nonce:"",restUrl:"",homeUrl:""};return this.config}getOpenAIClient(){if(this.openai)return this.openai;const e=this.getConfig();return this.openai=new c.Ay({apiKey:"proxy",baseURL:`${e.restUrl}${this.apiPath}`,dangerouslyAllowBrowser:!0,defaultHeaders:{"X-WP-Nonce":e.nonce}}),this.openai}async createChatCompletion(e){try{const t=this.getOpenAIClient();return await t.chat.completions.create({model:e.model||i,messages:e.messages,tools:e.tools,tool_choice:e.tool_choice,stream:!1,max_tokens:e.max_tokens,temperature:e.temperature,mode:e.mode||this.mode})}catch(e){throw new l(e.message||"OpenAI API request failed",e.status,e.code)}}async createStreamingCompletion(e,t,s,n){try{const n=this.getOpenAIClient(),a=await n.chat.completions.create({...e,messages:e.messages,stream:!0,mode:e.mode||this.mode});let o="";const r={};for await(const e of a){const n=e.choices[0]?.delta;if(n?.content&&(o+=n.content,t({type:"content",content:n.content})),n?.tool_calls){for(const e of n.tool_calls){const t=e.index;r[t]||(r[t]={id:e.id||"",type:"function",function:{name:e.function?.name||"",arguments:""}}),e.id&&(r[t].id=e.id),e.function?.name&&(r[t].function.name=e.function.name),e.function?.arguments&&(r[t].function.arguments+=e.function.arguments)}t({type:"tool_calls",tool_calls:Object.values(r)})}if(e.choices[0]?.finish_reason){const e=Object.values(r).map(e=>({id:e.id,name:e.function.name,arguments:e.function.arguments?JSON.parse(e.function.arguments):{}}));await s(o,e.length>0?e:null);break}}}catch(e){n(new l(e.message||"Streaming request failed",e.status,e.code))}}convertMessagesToOpenAI(e){const t=[];for(const o of e){var s;if("system"===o.role||"user"===o.role)t.push({role:o.role,content:null!==(s=o.content)&&void 0!==s?s:""});else if("assistant"===o.role){var n,a;const e=o.toolCalls&&o.toolCalls.length>0;if((null===o.content||void 0===o.content||""===o.content)&&!e){console.warn("Skipping invalid assistant message with no content and no tool calls");continue}const s={role:"assistant",content:e?null!==(n=o.content)&&void 0!==n?n:null:null!==(a=o.content)&&void 0!==a?a:""};if(e&&(s.tool_calls=o.toolCalls.map(e=>({id:e.id,type:"function",function:{name:e.name,arguments:"string"==typeof e.arguments?e.arguments:JSON.stringify(e.arguments)}}))),t.push(s),e&&o.toolResults&&o.toolResults.length>0)for(const e of o.toolResults)o.toolCalls.some(t=>t.id===e.id)&&t.push({role:"tool",content:e.error||JSON.stringify(e.result),tool_call_id:e.id})}}return t}convertMCPToolsToOpenAI(e){return e.map(e=>({type:"function",function:{name:e.name,description:e.description,parameters:e.inputSchema}}))}processToolCalls(e){return e.map(e=>({id:e.id,name:e.function.name,arguments:JSON.parse(e.function.arguments||"{}")}))}async sendMessage(e,t=[],s=[]){const n=this.convertMessagesToOpenAI([...t,{id:`user-${Date.now()}`,role:"user",content:e,timestamp:new Date}]),a={model:i,messages:n,tools:s.length>0?this.convertMCPToolsToOpenAI(s):void 0,tool_choice:s.length>0?"auto":void 0,temperature:.7,max_tokens:2e3};try{const e=(await this.createChatCompletion(a)).choices[0];if(!e)throw new l("No response from OpenAI");const t={message:e.message.content||""};return e.message.tool_calls&&(t.toolCalls=this.processToolCalls(e.message.tool_calls)),t}catch(e){if(e instanceof l)throw e;throw new l(`Failed to send message: ${e}`)}}};var u=s(6087),d=s(7723),p=s(1455),h=s.n(p);const m=e=>{if(!e||"string"!=typeof e)return!1;const t=e.toLowerCase().trim(),s=[/^hello!?\s+how\s+can\s+i\s+assist\s+you/i,/^hi!?\s+how\s+can\s+i\s+help/i,/^hello!?\s+how\s+can\s+i\s+help/i,/^hi\s+there!?\s+how\s+can/i,/^greetings!?\s+how\s+can/i,/^how\s+can\s+i\s+assist\s+you\s+today/i,/^how\s+can\s+i\s+help\s+you\s+today/i,/^hello!?\s+how\s+can\s+i\s+assist\s+you\s+today/i,/^hello!?\s+how\s+can\s+i\s+assist\s+you.*feel\s+free/i].some(e=>e.test(t)),n=t.includes("hello")&&(t.includes("assist")||t.includes("help"))&&(t.includes("today")||t.includes("feel free")||t.includes("ask")),a=t.length<150&&(t.includes("hello")&&(t.includes("assist")||t.includes("help"))||t.includes("hi")&&t.includes("help"));return s||n||a};var g=s(325);const _=e=>g.A.sanitize(e,{ALLOWED_TAGS:["section","div","h1","h2","h3","h4","h5","h6","p","span","strong","em","b","i","u","s","mark","small","sub","sup","a","br","ul","ol","li","dl","dt","dd","blockquote","code","pre","table","thead","tbody","tr","th","td","hr","address","time"],ALLOWED_ATTR:["style","class","id","href","datetime","target","rel"],ALLOW_DATA_ATTR:!1,FORBID_TAGS:["script","object","embed","iframe","form","fieldset","legend","label","input","textarea","select","option","button","details","summary","progress","meter"],FORBID_ATTR:["onerror","onload","onclick","onmouseover","onfocus","onblur"]});var f=s(5243),y=s(7640),w=s(3152),v=s(4648),x=s(435),b=s.n(x),j=s(790);const S=e=>({"blu/get-global-styles":{title:(0,d.__)("Reading Site Colors","wp-module-ai-chat")},"blu-get-global-styles":{title:(0,d.__)("Reading Site Colors","wp-module-ai-chat")},"blu/get-active-global-styles":{title:(0,d.__)("Reading Active Styles","wp-module-ai-chat")},"blu-get-active-global-styles":{title:(0,d.__)("Reading Active Styles","wp-module-ai-chat")},"blu/get-active-global-styles-id":{title:(0,d.__)("Getting Styles ID","wp-module-ai-chat")},"blu-get-active-global-styles-id":{title:(0,d.__)("Getting Styles ID","wp-module-ai-chat")},"blu/update-global-styles":{title:(0,d.__)("Updating Site Styles","wp-module-ai-chat")},"blu-update-global-styles":{title:(0,d.__)("Updating Site Styles","wp-module-ai-chat")},"blu/update-global-palette":{title:(0,d.__)("Updating Site Colors","wp-module-ai-chat")},"blu-update-global-palette":{title:(0,d.__)("Updating Site Colors","wp-module-ai-chat")}}[e]||{title:e?.replace(/[-_\/]/g," ").replace(/\b\w/g,e=>e.toUpperCase())||(0,d.__)("Action","wp-module-ai-chat")}),C=({tool:e,isError:t,result:s})=>{const n=((e,t={})=>{if("mcp-adapter-execute-ability"===e){const e=t?.ability_name||"unknown",s=S(e);let n=null;if(("blu/update-global-palette"===e||"blu/update-global-styles"===e)&&t?.parameters?.colors){const e=t.parameters.colors.length;n=`${e} color${1!==e?"s":""}`}return{...s,params:n}}return S(e)})(e.name,e.arguments),a=((e,t)=>{if(!e||e.isError)return s=e?.error,null==s?null:"string"==typeof s?s:"number"==typeof s||"boolean"==typeof s?String(s):null;var s;try{let s=e.result;if(Array.isArray(s)&&s.length>0&&s[0].text?s=JSON.parse(s[0].text):"string"==typeof s&&(s=JSON.parse(s)),!s||"object"!=typeof s)return null;if(t?.includes("update")){if(s.updatedColors&&Array.isArray(s.updatedColors)){const e=s.updatedColors;return e.length<=3?e.map(e=>`${e.name||e.slug}: ${e.color}`).join(", "):`${e.length} colors updated`}if(s.message&&"string"==typeof s.message)return s.message}if(t?.includes("get")||t?.includes("read")){if(s.color?.palette){const e=s.color.palette,t=e.custom?.length||0,n=e.theme?.length||0;if(t||n)return`Found ${t+n} colors`}if(s.typography){const e=s.typography.fontFamilies?.length||0,t=s.typography.fontSizes?.length||0,n=[];if(e&&n.push(`${e} font families`),t&&n.push(`${t} sizes`),n.length)return n.join(", ")}if(s.message&&"string"==typeof s.message)return s.message}return s.id&&t?.includes("id")?`ID: ${s.id}`:null}catch{return null}})(s,e.name);return(0,j.jsxs)("div",{className:b()("nfd-ai-chat-tool-execution__item",{"nfd-ai-chat-tool-execution__item--complete":!t,"nfd-ai-chat-tool-execution__item--error":t}),children:[(0,j.jsxs)("div",{className:"nfd-ai-chat-tool-execution__item-header",children:[t?(0,j.jsx)(f.A,{className:"nfd-ai-chat-tool-execution__icon nfd-ai-chat-tool-execution__icon--error",size:12}):(0,j.jsx)(y.A,{className:"nfd-ai-chat-tool-execution__icon nfd-ai-chat-tool-execution__icon--success",size:12}),(0,j.jsx)("span",{className:"nfd-ai-chat-tool-execution__item-title",children:n.title}),n.params&&(0,j.jsx)("span",{className:"nfd-ai-chat-tool-execution__item-params",children:n.params})]}),a&&(0,j.jsx)("div",{className:"nfd-ai-chat-tool-execution__item-summary",children:a})]})},N=({executedTools:e=[],toolResults:t=[]})=>{const[s,n]=(0,u.useState)(!1);if(!e||0===e.length)return null;const a=new Map;t&&Array.isArray(t)&&t.forEach(e=>{e.id&&a.set(e.id,e)});const o=e.some(e=>e.isError),r=e.length;return(0,j.jsxs)("div",{className:b()("nfd-ai-chat-tool-execution",{"nfd-ai-chat-tool-execution--collapsed":!s}),children:[(0,j.jsxs)("button",{type:"button",className:"nfd-ai-chat-tool-execution__header",onClick:()=>n(!s),"aria-expanded":s?"true":"false",children:[s?(0,j.jsx)(w.A,{className:"nfd-ai-chat-tool-execution__chevron",size:12}):(0,j.jsx)(v.A,{className:"nfd-ai-chat-tool-execution__chevron",size:12}),(0,j.jsx)("span",{children:o?(0,d.__)("Some actions failed","wp-module-ai-chat"):(0,d.__)("Actions completed","wp-module-ai-chat")}),(0,j.jsxs)("span",{className:"nfd-ai-chat-tool-execution__header-count",children:["(",r,")"]})]}),s&&(0,j.jsx)("div",{className:"nfd-ai-chat-tool-execution__list",children:e.map((e,t)=>(0,j.jsx)(C,{tool:e,isError:e.isError,result:a.get(e.id)},e.id||`tool-${t}`))})]})};var A=s(4071),T=s.n(A);const $=({approvalRequest:e,onApprove:t,onReject:s,onExecuteTool:n,onSendMessage:a,onSendSystemMessage:o,conversationId:r,onClearTyping:c,brandId:i})=>{const[l,p]=(0,u.useState)(!1),[h,m]=(0,u.useState)(null),g=(0,u.useCallback)(e=>e?e.split("/").pop().replace(/-/g," ").replace(/\b\w/g,e=>e.toUpperCase()):(0,d.__)("Execute Action","wp-module-ai-chat"),[]),_=(0,u.useCallback)(e=>e&&"object"==typeof e&&0!==Object.keys(e).length?Object.entries(e).map(([e,t])=>e.toLowerCase().includes("password")||e.toLowerCase().includes("token")?`${e}: ••••••••`:`${e}: ${"object"==typeof t?JSON.stringify(t,null,2):String(t)}`).join("\n"):(0,d.__)("No arguments provided","wp-module-ai-chat"),[]),f=(0,u.useCallback)(async()=>{if(n&&e?.tool_name){p(!0),m(null);try{let s=e.tool_arguments||{};if("string"==typeof s)try{s=JSON.parse(s)}catch{s={}}const a=await n(e.tool_name,s,e.site_url);if(c&&c(),o){const t=((e,t)=>{const s=(e||"").toLowerCase();let n="";if(t&&"object"==typeof t)n=t.title?.rendered||t.title||t.name||"";else if("string"==typeof t)try{const e=JSON.parse(t);n=e.title?.rendered||e.title||e.name||""}catch(e){}return s.includes("posts-create")||s.includes("create-post")?n?(0,d.sprintf)(/* translators: %s: post title */ /* translators: %s: post title */
(0,d.__)('Post "%s" has been created successfully.',"wp-module-ai-chat"),n):(0,d.__)("Post has been created successfully.","wp-module-ai-chat"):s.includes("posts-update")||s.includes("update-post")?n?(0,d.sprintf)(/* translators: %s: post title */ /* translators: %s: post title */
(0,d.__)('Post "%s" has been updated successfully.',"wp-module-ai-chat"),n):(0,d.__)("Post has been updated successfully.","wp-module-ai-chat"):s.includes("posts-delete")||s.includes("delete-post")?(0,d.__)("Post has been deleted successfully.","wp-module-ai-chat"):s.includes("pages-create")||s.includes("create-page")?n?(0,d.sprintf)(/* translators: %s: page title */ /* translators: %s: page title */
(0,d.__)('Page "%s" has been created successfully.',"wp-module-ai-chat"),n):(0,d.__)("Page has been created successfully.","wp-module-ai-chat"):s.includes("pages-update")||s.includes("update-page")?n?(0,d.sprintf)(/* translators: %s: page title */ /* translators: %s: page title */
(0,d.__)('Page "%s" has been updated successfully.',"wp-module-ai-chat"),n):(0,d.__)("Page has been updated successfully.","wp-module-ai-chat"):s.includes("pages-delete")||s.includes("delete-page")?(0,d.__)("Page has been deleted successfully.","wp-module-ai-chat"):s.includes("media-create")||s.includes("upload")?n?(0,d.sprintf)(/* translators: %s: media title */ /* translators: %s: media title */
(0,d.__)('Media "%s" has been uploaded successfully.',"wp-module-ai-chat"),n):(0,d.__)("Media has been uploaded successfully.","wp-module-ai-chat"):s.includes("media-delete")||s.includes("delete-media")?(0,d.__)("Media has been deleted successfully.","wp-module-ai-chat"):s.includes("categories-create")||s.includes("create-category")?n?(0,d.sprintf)(/* translators: %s: category name */ /* translators: %s: category name */
(0,d.__)('Category "%s" has been created successfully.',"wp-module-ai-chat"),n):(0,d.__)("Category has been created successfully.","wp-module-ai-chat"):s.includes("tags-create")||s.includes("create-tag")?n?(0,d.sprintf)(/* translators: %s: tag name */ /* translators: %s: tag name */
(0,d.__)('Tag "%s" has been created successfully.',"wp-module-ai-chat"),n):(0,d.__)("Tag has been created successfully.","wp-module-ai-chat"):s.includes("users-create")||s.includes("create-user")?(0,d.__)("User has been created successfully.","wp-module-ai-chat"):s.includes("comments-create")||s.includes("create-comment")?(0,d.__)("Comment has been created successfully.","wp-module-ai-chat"):s.includes("settings-update")||s.includes("update-settings")?(0,d.__)("Settings have been updated successfully.","wp-module-ai-chat"):s.includes("create")?(0,d.__)("Item has been created successfully.","wp-module-ai-chat"):s.includes("update")?(0,d.__)("Item has been updated successfully.","wp-module-ai-chat"):s.includes("delete")?(0,d.__)("Item has been deleted successfully.","wp-module-ai-chat"):(0,d.__)("Action completed successfully.","wp-module-ai-chat")})(e.tool_name,a);let s="";try{const e="string"==typeof a?JSON.parse(a):a;if(e){const t=e.title?.rendered||e.title||e.name||"",n=e.id||"",a=e.link||e.guid?.rendered||"",o=e.status||"";(t||n||a)&&(s="\nDetails: ",t&&(s+=`Title: "${t}"`),n&&(s+=`${t?", ":""}ID: ${n}`),o&&(s+=`, Status: ${o}`),a&&(s+=`\nLink: ${a}`))}}catch(e){}o(`[Tool Execution Result]\n${t}${s}`)}t&&t(a)}catch(t){const s=t.message||(0,d.__)("Tool execution failed","wp-module-ai-chat");m(s),c&&c(),o&&o(`[Tool Execution Error]\nFailed to execute ${e.tool_name}: ${s}`)}finally{p(!1)}}else t&&t()},[e,t,n,o,c]),y=(0,u.useCallback)((e=(0,d.__)("Action rejected by user.","wp-module-ai-chat"))=>{o&&o(`[Tool Execution Cancelled]\n${e}`),s&&s()},[s,o]);if((0,u.useEffect)(()=>{if(e){const e=setTimeout(()=>{y((0,d.__)("Approval request timed out.","wp-module-ai-chat"))},3e5);return()=>clearTimeout(e)}},[e,y]),(0,u.useEffect)(()=>{const e=e=>{"Escape"!==e.key||l?"Enter"!==e.key||!e.ctrlKey&&!e.metaKey||l||f():y()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[l,y,f]),!e)return null;const{tool_name:w,tool_arguments:v}=e;return(0,j.jsx)("div",{className:`nfd-inline-approval nfd-brand-${i||"default"}`,role:"region","aria-label":(0,d.__)("Action approval required","wp-module-ai-chat"),"aria-live":"polite",children:(0,j.jsxs)("div",{className:"nfd-inline-approval__card",children:[(0,j.jsxs)("div",{className:"nfd-inline-approval__header",children:[(0,j.jsx)("span",{className:"nfd-inline-approval__icon",role:"img","aria-label":(0,d.__)("Warning","wp-module-ai-chat"),children:"⚠️"}),(0,j.jsx)("h3",{className:"nfd-inline-approval__title",children:(0,d.__)("Action Required","wp-module-ai-chat")})]}),(0,j.jsxs)("div",{className:"nfd-inline-approval__content",children:[(0,j.jsxs)("p",{className:"nfd-inline-approval__description",children:[(0,d.__)("Approve execution of:","wp-module-ai-chat")," ",(0,j.jsx)("strong",{children:g(w)})]}),v&&Object.keys(v).length>0&&(0,j.jsxs)("div",{className:"nfd-inline-approval__arguments",children:[(0,j.jsx)("label",{className:"nfd-inline-approval__arguments-label",children:(0,d.__)("Arguments:","wp-module-ai-chat")}),(0,j.jsx)("pre",{className:"nfd-inline-approval__arguments-code",role:"textbox","aria-label":(0,d.__)("Tool arguments","wp-module-ai-chat"),children:_(v)})]}),h&&(0,j.jsxs)("div",{className:"nfd-inline-approval__error",role:"alert","aria-live":"assertive",children:[(0,j.jsx)("span",{className:"nfd-inline-approval__error-icon",children:"✕"}),(0,j.jsx)("span",{className:"nfd-inline-approval__error-message",children:h})]})]}),(0,j.jsxs)("div",{className:"nfd-inline-approval__actions",children:[(0,j.jsx)("button",{type:"button",onClick:y,disabled:l,className:"nfd-inline-approval__button nfd-inline-approval__button--secondary","aria-label":(0,d.__)("Cancel action","wp-module-ai-chat"),children:(0,d.__)("Cancel","wp-module-ai-chat")}),(0,j.jsx)("button",{type:"button",onClick:f,disabled:l,className:"nfd-inline-approval__button nfd-inline-approval__button--primary","aria-label":(0,d.__)("Approve and execute action","wp-module-ai-chat"),"aria-busy":l,children:l?(0,j.jsxs)(j.Fragment,{children:[(0,j.jsx)("span",{className:"nfd-inline-approval__spinner","aria-hidden":"true"}),(0,j.jsx)("span",{children:(0,d.__)("Executing...","wp-module-ai-chat")})]}):(0,d.__)("Approve","wp-module-ai-chat")})]})]})})};$.propTypes={approvalRequest:T().shape({tool_name:T().string.isRequired,tool_arguments:T().object,site_url:T().string,frontend:T().string}),onApprove:T().func.isRequired,onReject:T().func.isRequired,onExecuteTool:T().func,onSendMessage:T().func,onSendSystemMessage:T().func,conversationId:T().string,onClearTyping:T().func,brandId:T().string};const I=$,R=({message:e,type:t="assistant",executedTools:s=[],approvalRequest:n,onApprove:a,onReject:o,onExecuteTool:r,onSendMessage:c,onSendSystemMessage:i,conversationId:l,onClearTyping:d,brandId:p,toolResults:h=[]})=>{if("approval_request"===t&&n)return(0,j.jsx)("div",{className:"nfd-ai-chat-message nfd-ai-chat-message--approval",children:(0,j.jsx)(I,{approvalRequest:n,onApprove:a,onReject:o,onExecuteTool:r,onSendMessage:c,onSendSystemMessage:i,conversationId:l,onClearTyping:d,brandId:p})});const m="user"===t,{content:g,isRichContent:f}=(0,u.useMemo)(()=>{if(!e)return{content:"",isRichContent:!1};if(m)return{content:e,isRichContent:!1};if((e=>/<[a-z][\s\S]*>/i.test(e))(e))return{content:_(e),isRichContent:!0};if((t=e)&&"string"==typeof t&&[/^#{1,6}\s/m,/\*\*[^*]+\*\*/,/\*[^*]+\*/,/__[^_]+__/,/_[^_]+_/,/`[^`]+`/,/```[\s\S]*?```/,/^\s*[-*+]\s/m,/^\s*\d+\.\s/m,/\[([^\]]+)\]\(([^)]+)\)/].some(e=>e.test(t))){const t=function(e){if(!e||"string"!=typeof e)return"";let t=e;t=t.replace(/&(?![\w#]+;)/g,"&amp;").replace(/<(?![a-zA-Z/])/g,"&lt;").replace(/(?<![a-zA-Z"])>/g,"&gt;"),t=t.replace(/```(\w*)\n?([\s\S]*?)```/g,(e,t,s)=>`<pre><code class="language-${t||"plaintext"}">${s.trim().replace(/</g,"&lt;").replace(/>/g,"&gt;")}</code></pre>`),t=t.replace(/`([^`]+)`/g,'<code class="inline-code">$1</code>'),t=t.replace(/^######\s+(.+)$/gm,'<h6 class="chat-h6">$1</h6>'),t=t.replace(/^#####\s+(.+)$/gm,'<h5 class="chat-h5">$1</h5>'),t=t.replace(/^####\s+(.+)$/gm,'<h4 class="chat-h4">$1</h4>'),t=t.replace(/^###\s+(.+)$/gm,'<h3 class="chat-h3">$1</h3>'),t=t.replace(/^##\s+(.+)$/gm,'<h2 class="chat-h2">$1</h2>'),t=t.replace(/^#\s+(.+)$/gm,'<h1 class="chat-h1">$1</h1>'),t=t.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),t=t.replace(/__([^_]+)__/g,"<strong>$1</strong>"),t=t.replace(/(?<![*_])\*(?!\*)([^*\n]+)(?<!\*)\*(?!\*)/g,"<em>$1</em>"),t=t.replace(/(?<![_*])_(?!_)([^_\n]+)(?<!_)_(?!_)/g,"<em>$1</em>"),t=t.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'),t=t.replace(/^(\s*)[-*+]\s+(.+)$/gm,(e,t,s)=>`<li class="chat-li" data-level="${Math.floor(t.length/2)}">${s}</li>`),t=t.replace(/((?:<li[^>]*>.*?<\/li>\s*)+)/g,e=>`<ul class="chat-ul">${e.replace(/(<\/li>)\s+(<li)/g,"$1$2")}</ul>`),t=t.replace(/^(\s*)\d+\.\s+(.+)$/gm,(e,t,s)=>`<oli class="chat-oli" data-level="${Math.floor(t.length/2)}">${s}</oli>`),t=t.replace(/((?:<oli[^>]*>.*?<\/oli>\s*)+)/g,e=>`<ol class="chat-ol">${e.replace(/(<\/oli>)\s+(<oli)/g,"$1$2").replace(/<\/?oli/g,e=>e.replace("oli","li"))}</ol>`),t=t.replace(/^---+$/gm,'<hr class="chat-hr" />'),t=t.replace(/^>\s+(.+)$/gm,'<blockquote class="chat-blockquote">$1</blockquote>');const s=t.split(/\n\n+/);return t=s.map(e=>{const t=e.trim();return t.startsWith("<h")||t.startsWith("<ul")||t.startsWith("<ol")||t.startsWith("<pre")||t.startsWith("<blockquote")||t.startsWith("<hr")||t.startsWith("<p")?t:t?`<p class="chat-p">${t}</p>`:""}).filter(Boolean).join(""),t=t.replace(/<p([^>]*)>([\s\S]*?)<\/p>/g,(e,t,s)=>`<p${t}>${s.trim().replace(/\n/g,"<br>")}</p>`),t=t.replace(/<br\s*\/?>\s*(<\/?(ul|ol|li|p|h[1-6]|pre|blockquote|hr))/gi,"$1"),t=t.replace(/(<\/(ul|ol|li|p|h[1-6]|pre|blockquote)>)\s*<br\s*\/?>/gi,"$1"),t=t.replace(/<p[^>]*>\s*<\/p>/g,""),t=t.replace(/(<br\s*\/?>){2,}/g,"<br>"),t}(e);return{content:_(t),isRichContent:!0}}var t;return{content:e,isRichContent:!1}},[e,m]);return g||s&&0!==s.length?(0,j.jsxs)("div",{className:`nfd-ai-chat-message nfd-ai-chat-message--${t}`,children:[g&&(f?(0,j.jsx)("div",{className:"nfd-ai-chat-message__content nfd-ai-chat-message__content--rich",dangerouslySetInnerHTML:{__html:g}}):(0,j.jsx)("div",{className:"nfd-ai-chat-message__content",children:g})),s&&s.length>0&&(0,j.jsx)(N,{executedTools:s,toolResults:h})]}):null},k=({message:e,className:t=""})=>(0,j.jsxs)("div",{className:`nfd-ai-chat-error-alert ${t}`,children:[(0,j.jsx)("div",{className:"nfd-ai-chat-error-alert__icon",children:(0,j.jsx)(f.A,{width:16,height:16})}),(0,j.jsx)("div",{className:"nfd-ai-chat-error-alert__content",children:(0,j.jsx)("div",{className:"nfd-ai-chat-error-alert__message",children:e})})]});var E=s(2074),O=s(1045);const q=e=>({"nfd-agents/get-global-styles":{title:(0,d.__)("Reading Site Colors","wp-module-ai-chat"),description:(0,d.__)("Fetching current color palette and typography settings","wp-module-ai-chat")},"nfd-agents/update-global-palette":{title:(0,d.__)("Updating Site Colors","wp-module-ai-chat"),description:(0,d.__)("Applying new colors to global styles","wp-module-ai-chat")},"newfold-agents/get-global-styles":{title:(0,d.__)("Reading Site Colors","wp-module-ai-chat"),description:(0,d.__)("Fetching current color palette and typography settings","wp-module-ai-chat")},"newfold-agents/update-global-palette":{title:(0,d.__)("Updating Site Colors","wp-module-ai-chat"),description:(0,d.__)("Applying new colors to global styles","wp-module-ai-chat")},"blu/get-global-styles":{title:(0,d.__)("Reading Site Colors","wp-module-ai-chat"),description:(0,d.__)("Fetching current color palette and typography settings","wp-module-ai-chat")},"blu/update-global-palette":{title:(0,d.__)("Updating Site Colors","wp-module-ai-chat"),description:(0,d.__)("Applying new colors to global styles","wp-module-ai-chat")},"mcp-adapter-discover-abilities":{title:(0,d.__)("Discovering Actions","wp-module-ai-chat"),description:(0,d.__)("Finding available WordPress abilities","wp-module-ai-chat")},"mcp-adapter-get-ability-info":{title:(0,d.__)("Getting Ability Info","wp-module-ai-chat"),description:(0,d.__)("Fetching ability details","wp-module-ai-chat")},"mcp-adapter-execute-ability":{title:(0,d.__)("Executing Action","wp-module-ai-chat"),description:(0,d.__)("Running WordPress ability","wp-module-ai-chat")}}[e]||{title:e?.replace(/[-_\/]/g," ").replace(/\b\w/g,e=>e.toUpperCase())||(0,d.__)("Executing","wp-module-ai-chat"),description:(0,d.__)("Running action","wp-module-ai-chat")}),D=({tool:e,isActive:t,progress:s,isComplete:n,isError:a})=>{const o=((e,t={})=>{if("mcp-adapter-execute-ability"===e){const e=t?.ability_name||"unknown",s=q(e);let n=null;if(("nfd-agents/update-global-palette"===e||"newfold-agents/update-global-palette"===e||"blu/update-global-palette"===e)&&t?.parameters?.colors){const e=t.parameters.colors.length;n=`${e} color${1!==e?"s":""}`}return{...s,params:n}}return q(e)})(e.name,e.arguments);return(0,j.jsxs)("div",{className:b()("nfd-ai-chat-tool-execution__item",{"nfd-ai-chat-tool-execution__item--active":t,"nfd-ai-chat-tool-execution__item--complete":n,"nfd-ai-chat-tool-execution__item--error":a}),children:[(0,j.jsxs)("div",{className:"nfd-ai-chat-tool-execution__item-header",children:[a?(0,j.jsx)(f.A,{className:"nfd-ai-chat-tool-execution__icon nfd-ai-chat-tool-execution__icon--error",size:12}):n?(0,j.jsx)(y.A,{className:"nfd-ai-chat-tool-execution__icon nfd-ai-chat-tool-execution__icon--success",size:12}):t?(0,j.jsx)(E.A,{className:"nfd-ai-chat-tool-execution__icon nfd-ai-chat-tool-execution__icon--active",size:12}):(0,j.jsx)(O.A,{className:"nfd-ai-chat-tool-execution__icon nfd-ai-chat-tool-execution__icon--pending",size:12}),(0,j.jsx)("span",{className:"nfd-ai-chat-tool-execution__item-title",children:o.title}),o.params&&(0,j.jsx)("span",{className:"nfd-ai-chat-tool-execution__item-params",children:o.params})]}),t&&s&&(0,j.jsx)("div",{className:"nfd-ai-chat-tool-execution__item-progress",children:s})]})},M=({status:e=null,activeToolCall:t=null,toolProgress:s=null,executedTools:n=[],pendingTools:a=[]})=>{const[o,r]=(0,u.useState)(!0),c=!!t;(0,u.useEffect)(()=>{r(c)},[c]);const i=t||n.length>0||a.length>0,l=n.length+(t?1:0)+a.length;return i?(0,j.jsx)("div",{className:"nfd-ai-chat-message nfd-ai-chat-message--assistant",children:(0,j.jsx)("div",{className:"nfd-ai-chat-message__content",children:(0,j.jsxs)("div",{className:b()("nfd-ai-chat-tool-execution",{"nfd-ai-chat-tool-execution--collapsed":!o}),children:[(0,j.jsxs)("button",{type:"button",className:"nfd-ai-chat-tool-execution__header",onClick:()=>r(!o),"aria-expanded":o?"true":"false",children:[o?(0,j.jsx)(w.A,{className:"nfd-ai-chat-tool-execution__chevron",size:12}):(0,j.jsx)(v.A,{className:"nfd-ai-chat-tool-execution__chevron",size:12}),c?(0,j.jsxs)(j.Fragment,{children:[(0,j.jsx)("span",{children:(0,d.__)("Executing actions","wp-module-ai-chat")}),t.total>1&&(0,j.jsxs)("span",{className:"nfd-ai-chat-tool-execution__header-count",children:["(",t.index,"/",t.total,")"]})]}):(0,j.jsxs)(j.Fragment,{children:[(0,j.jsx)("span",{children:(0,d.__)("Actions completed","wp-module-ai-chat")}),(0,j.jsxs)("span",{className:"nfd-ai-chat-tool-execution__header-count",children:["(",l,")"]})]})]}),o&&(0,j.jsxs)("div",{className:"nfd-ai-chat-tool-execution__list",children:[n.map((e,t)=>(0,j.jsx)(D,{tool:e,isActive:!1,isComplete:!e.isError,isError:e.isError,progress:null},e.id||`executed-${t}`)),t&&(0,j.jsx)(D,{tool:t,isActive:!0,isComplete:!1,isError:!1,progress:s},t.id||"active"),a.map((e,t)=>(0,j.jsx)(D,{tool:e,isActive:!1,isComplete:!1,isError:!1,progress:null},e.id||`pending-${t}`))]})]})})}):(0,j.jsx)("div",{className:"nfd-ai-chat-message nfd-ai-chat-message--assistant",children:(0,j.jsx)("div",{className:"nfd-ai-chat-message__content",children:(0,j.jsxs)("div",{className:"nfd-ai-chat-typing-indicator",children:[(0,j.jsxs)("span",{className:"nfd-ai-chat-typing-indicator__dots","aria-hidden":"true",children:[(0,j.jsx)("span",{}),(0,j.jsx)("span",{}),(0,j.jsx)("span",{})]}),(0,j.jsx)("span",{className:"nfd-ai-chat-typing-indicator__text",children:(()=>{switch(e){case"received":return(0,d.__)("Message received","wp-module-ai-chat");case"generating":default:return(0,d.__)("Blu is typing","wp-module-ai-chat");case"tool_call":return(0,d.__)("Executing actions","wp-module-ai-chat");case"summarizing":return(0,d.__)("Summarizing results","wp-module-ai-chat");case"completed":return(0,d.__)("Processing","wp-module-ai-chat");case"failed":return(0,d.__)("Error occurred","wp-module-ai-chat")}})()})]})})})},P=({messages:e=[],isLoading:t=!1,error:s=null,status:n=null,activeToolCall:a=null,toolProgress:o=null,executedTools:r=[],pendingTools:c=[],onApprove:i,onReject:l,onExecuteTool:d,onSendMessage:p,onSendSystemMessage:h,conversationId:m,onClearTyping:g,brandId:_})=>{const f=(0,u.useRef)(null);(0,u.useEffect)(()=>{f.current?.scrollIntoView({behavior:"smooth"})},[e,t,o]);const y=a||r.length>0||c.length>0;return(0,j.jsxs)("div",{className:"nfd-ai-chat-messages",children:[e.length>0&&e.map((e,t)=>(0,j.jsx)(R,{message:e.content,type:e.type,executedTools:e.executedTools,approvalRequest:e.approvalRequest,onApprove:i,onReject:l,onExecuteTool:d,onSendMessage:p,onSendSystemMessage:h,conversationId:m,onClearTyping:g,brandId:_,toolResults:e.toolResults},e.id||t)),s&&(0,j.jsx)(k,{message:s}),t&&(0,j.jsx)(M,{status:n,activeToolCall:a,toolProgress:o,executedTools:y?r:[],pendingTools:c}),(0,j.jsx)("div",{ref:f})]})};var U=s(6427),F=s(5963),L=s(9947);const W=({onSendMessage:e,onStopRequest:t,disabled:s=!1,placeholder:n,contextComponent:a=null})=>{const[o,r]=(0,u.useState)(""),[c,i]=(0,u.useState)(!1),l=(0,u.useRef)(null),p=(0,u.useRef)(null),h=(0,d.__)("How can I help you today?","wp-module-ai-chat");(0,u.useEffect)(()=>{if(l.current){l.current.style.height="auto";const e=l.current.scrollHeight,t=Math.min(e,200);l.current.style.height=`${t}px`,l.current.style.overflowY=e>200?"auto":"hidden"}},[o]),(0,u.useEffect)(()=>{!s&&l.current&&setTimeout(()=>{l.current.focus()},100)},[s]);const m=()=>{o.trim()&&!s&&(e(o),r(""),l.current&&(l.current.style.height="auto",l.current.style.overflowY="hidden",l.current.focus()))};return(0,j.jsxs)("div",{className:"nfd-ai-chat-input",children:[(0,j.jsxs)("div",{className:"nfd-ai-chat-input__container",children:[(0,j.jsx)("textarea",{name:"nfd-ai-chat-input",ref:l,value:o,onChange:e=>r(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),m())},placeholder:n||h,className:"nfd-ai-chat-input__textarea",rows:1,disabled:s}),(0,j.jsxs)("div",{className:"nfd-ai-chat-input__actions",children:[a,s?(0,j.jsx)(U.Button,{ref:p,icon:(0,j.jsx)(F.A,{width:16,height:16}),label:(0,d.__)("Stop generating","wp-module-ai-chat"),onClick:()=>{c||(i(!0),t&&t(),setTimeout(()=>{i(!1)},500))},className:"nfd-ai-chat-input__stop",disabled:c,"aria-busy":c}):(0,j.jsx)(U.Button,{icon:(0,j.jsx)(L.A,{width:16,height:16}),label:(0,d.__)("Send message","wp-module-ai-chat"),onClick:m,className:"nfd-ai-chat-input__submit",disabled:!o.trim()})]})]}),(0,j.jsx)("div",{className:"nfd-ai-chat-input__disclaimer",children:(0,d.__)("AI-generated content is not guaranteed for accuracy.","wp-module-ai-chat")})]})};var z=s(1925);const H=()=>(0,j.jsxs)("div",{className:"nfd-ai-chat-blu-beta-heading",children:[(0,j.jsxs)("div",{className:"nfd-ai-chat-blu-beta-heading__main",children:[(0,j.jsx)(U.Icon,{icon:z.A,size:16,className:"nfd-ai-chat-blu-beta-heading__icon"}),(0,j.jsx)("span",{className:"nfd-ai-chat-blu-beta-heading__text",children:(0,d.__)("BLU","wp-module-ai-chat")})]}),(0,j.jsx)("div",{className:"nfd-ai-chat-blu-beta-heading__badge",children:(0,d.__)("BETA","wp-module-ai-chat")})]}),K=({icon:e,text:t,onClick:s,className:n=""})=>(0,j.jsxs)(U.Button,{className:`nfd-ai-chat-suggestion ${n}`,onClick:s,children:[(0,j.jsx)("div",{className:"nfd-ai-chat-suggestion__icon",children:e}),(0,j.jsx)("div",{className:"nfd-ai-chat-suggestion__text",children:t})]}),J=({onSendMessage:e,title:t,subtitle:s,suggestions:n=[],showSuggestions:a=!1})=>{const o=(0,d.__)("Hi, I'm your AI assistant.","wp-module-ai-chat"),r=(0,d.__)("How can I help you today?","wp-module-ai-chat");return(0,j.jsxs)("div",{className:"nfd-ai-chat-welcome",children:[(0,j.jsxs)("div",{className:"nfd-ai-chat-welcome__content",children:[(0,j.jsx)("div",{className:"nfd-ai-chat-welcome__heading",children:(0,j.jsx)(H,{})}),(0,j.jsxs)("div",{className:"nfd-ai-chat-welcome__message",children:[(0,j.jsx)("div",{className:"nfd-ai-chat-welcome__title",children:t||o}),(0,j.jsx)("div",{className:"nfd-ai-chat-welcome__subtitle",children:s||r})]})]}),a&&n.length>0&&(0,j.jsx)("div",{className:"nfd-ai-chat-suggestions",children:n.map((t,s)=>(0,j.jsx)(K,{icon:t.icon,text:t.text,onClick:()=>e(t.action||t.text)},s))})]})};s(1609);var G=s(3875),B=s(1362),V=s(9022);const Y="nfd-ai-chat-help_center-history",X=({onSelectConversation:e})=>{const[t,s]=(0,u.useState)([]);if((0,u.useEffect)(()=>{try{const e=localStorage.getItem(Y);if(e){const t=JSON.parse(e);if(Array.isArray(t)&&t.length>0){const e=(e=>{if(!Array.isArray(e)||0===e.length)return[];const t=[];let s=[],n=null;return e.forEach(e=>{const a=e.timestamp?new Date(e.timestamp).getTime():Date.now();n&&a-n>3e5&&s.length>0&&(t.push([...s]),s=[]),s.push(e),n=a}),s.length>0&&t.push(s),t.slice(-3).reverse()})(t.map(e=>({...e,timestamp:e.timestamp?new Date(e.timestamp):new Date})));s(e)}}}catch(e){console.warn("[Chat History] Failed to load chat history:",e)}},[]),0===t.length)return null;const n=t=>{try{const s=t.map(e=>({...e,timestamp:e.timestamp instanceof Date?e.timestamp.toISOString():e.timestamp}));localStorage.setItem(Y,JSON.stringify(s)),localStorage.setItem("nfd-ai-chat-help_center-load-history","true"),e&&e(t),window.location.reload()}catch(e){console.warn("[Chat History] Failed to restore conversation:",e)}};return(0,j.jsx)("div",{className:"nfd-help-center-chat__history-list",children:t.map((e,t)=>{const s=(e=>{const t=e.find(e=>"user"===e.role||"user"===e.type);if(t&&t.content){const e=t.content;return e.length>50?e.substring(0,50)+"...":e}return(0,d.__)("Previous conversation","wp-module-help-center")})(e);return(0,j.jsxs)("div",{className:"nfd-help-center-chat__history-item",role:"button",tabIndex:0,onClick:()=>n(e),onKeyDown:t=>{"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),n(e))},children:[(0,j.jsx)(V.h,{}),(0,j.jsx)("span",{children:s})]},t)})})};var Z=s(1069),Q=s(4989);var ee=s(7738);const te=()=>{const[e]=(()=>{const[e,t]=(0,u.useState)(()=>Z.Sp.getHelpVisible());return(0,u.useEffect)(()=>{const e=()=>{t(Z.Sp.getHelpVisible())};return window.addEventListener("storage",e),()=>{window.removeEventListener("storage",e)}},[]),[e,t]})(),{hasLaunchedFromTooltip:t}=(0,Q.X)(),s=(0,u.useRef)(!1),[n,a]=(0,u.useState)(!1),o=(0,d.__)("Connecting…","wp-module-help-center"),r=(()=>{try{if("true"===localStorage.getItem("nfd-ai-chat-help_center-load-history"))return localStorage.removeItem("nfd-ai-chat-help_center-load-history"),!0}catch(e){}return!1})(),{messages:c,sendMessage:i,sendSystemMessage:l,error:p,isTyping:g,isConnecting:_,currentResponse:f,conversationId:y,clearApprovalRequest:w,clearTyping:v,updateMessage:x,stopRequest:b,clearChatHistory:S,brandId:C}=(({configEndpoint:e,storageNamespace:t="default",autoConnect:s=!1,consumerType:n="editor_chat",autoLoadHistory:a=!0})=>{const o=`nfd-ai-chat-${t}-history`,r=`nfd-ai-chat-${t}-conversation-id`,c=()=>{try{const e=localStorage.getItem(o),t=localStorage.getItem(r);if(e){const s=JSON.parse(e);if(Array.isArray(s)&&s.length>0)return{messages:s.map(e=>({...e,timestamp:e.timestamp?new Date(e.timestamp):new Date})),conversationId:t||null}}}catch(e){console.warn("[AI Chat] Failed to restore chat history from localStorage:",e)}return{messages:[],conversationId:null}},[i,l]=(0,u.useState)(()=>a?c().messages:[]),[p,g]=(0,u.useState)(()=>a?c().conversationId:null),[_,f]=(0,u.useState)(!1),[y,w]=(0,u.useState)(!1),[v,x]=(0,u.useState)(null),[b,j]=(0,u.useState)(!1),[S,C]=(0,u.useState)(""),[N,A]=(0,u.useState)(null),T=(0,u.useRef)(null),$=(0,u.useRef)(null),I=(0,u.useRef)(0),R=(0,u.useRef)(null),k=(0,u.useRef)(null),E=(0,u.useRef)(!1),O=(0,u.useRef)(null),q=(0,u.useRef)(!1),D=(0,u.useRef)(!1),M=(0,u.useRef)(null),P=(0,u.useRef)(!0),U=(0,u.useRef)([]),F=6e4,L=(0,u.useCallback)(()=>"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),[]),W=(0,u.useCallback)(async()=>{try{let s=e;if(e.startsWith("http://")||e.startsWith("https://")){const t=new URL(e);s=t.searchParams.has("rest_route")?t.searchParams.get("rest_route"):t.pathname.includes("/wp-json/")?t.pathname.replace("/wp-json/",""):t.pathname.replace(/^\//,"")}const n=`${s.startsWith("/")?s.slice(1):s}?storage_namespace=${encodeURIComponent(t)}`,a=await h()({path:n,parse:!0});return R.current=a,a}catch(e){console.error("[AI Chat] Failed to fetch config:",e),console.error("[AI Chat] Error details:",{message:e.message,code:e.code,data:e.data,status:e.data?.status,statusText:e.data?.statusText});let t=e.message||(0,d.__)("Failed to connect","wp-module-ai-chat");throw e.data?.message?t=e.data.message:e.message&&"Could not get a valid response from the server."!==e.message&&(t=e.message),"rest_forbidden"===e.code||403===e.data?.status?t=(0,d.__)("Access denied. Please check your capabilities.","wp-module-ai-chat"):"rest_no_route"===e.code||404===e.data?.status?t=(0,d.__)("Config endpoint not found. Please ensure the backend is deployed.","wp-module-ai-chat"):"gateway_url_not_configured"===e.code?t=(0,d.__)("Gateway URL not configured. Set NFD_AGENTS_CHAT_GATEWAY_URL in wp-config.php.","wp-module-ai-chat"):"huapi_token_fetch_failed"===e.code?t=(0,d.__)("Failed to fetch authentication token from Hiive. Check your connection or set NFD_AGENTS_CHAT_DEBUG_TOKEN for local development.","wp-module-ai-chat"):e.data?.status&&(t=(0,d.sprintf)(/* translators: %1$s: HTTP status, %2$s: status text */ /* translators: %1$s: HTTP status, %2$s: status text */
(0,d.__)("Failed to fetch config: %1$s %2$s","wp-module-ai-chat"),e.data.status,e.data.statusText||t)),x((0,d.sprintf)(/* translators: %s: error message */ /* translators: %s: error message */
(0,d.__)("Failed to connect: %s","wp-module-ai-chat"),t)),new Error(t)}},[e,t]),z=(0,u.useCallback)(async()=>{if(T.current?.readyState!==WebSocket.OPEN&&T.current?.readyState!==WebSocket.CONNECTING&&!E.current){E.current=!0,w(!0),x(null);try{R.current||await W();const t=R.current;if(!t)throw new Error((0,d.__)("No configuration available","wp-module-ai-chat"));O.current||(O.current=L());const s=(e=t.gateway_url)&&"string"==typeof e?e.startsWith("http://")?e.replace("http://","ws://"):e.startsWith("https://")?e.replace("https://","wss://"):e.startsWith("ws://")||e.startsWith("wss://")?e:(e=>{if(!e||"string"!=typeof e)return!1;const t=e.toLowerCase();return t.includes("localhost")||t.includes("127.0.0.1")})(e)?`ws://${e}`:`wss://${e}`:e,a=("nfd-agents"===t.agent_type?"blu":t.agent_type)||"blu";let o=`${s}/${t.brand_id}/agents/${a}/v1/ws?session_id=${O.current}&token=${encodeURIComponent(t.huapi_token)}`;const c=`wordpress_${n}`;o+=`&consumer=${encodeURIComponent(c)}`,t.site_url&&console.warn("[AI Chat] site_url parameter is deprecated. Use consumerType instead.");const i=new WebSocket(o);T.current=i,i.onopen=()=>{E.current=!1,f(!0),w(!1),x(null),I.current=0,q.current=U.current&&U.current.length>0,D.current=!1,C("")},i.onmessage=e=>{try{const t=JSON.parse(e.data);if(D.current&&"session_established"!==t.type)return;if("session_established"===t.type)t.session_id&&(O.current=t.session_id);else if("streaming_chunk"===t.type||"chunk"===t.type){if(D.current)return;const e=t.content||t.chunk||t.text||"";e&&C(t=>{const s=t+e;return!q.current&&s.length<100&&m(s)?(console.debug("[AI Chat] Filtering initial greeting:",s.substring(0,50)),""):(j(!0),M.current&&clearTimeout(M.current),M.current=setTimeout(()=>{j(!1),M.current=null},F),s)})}else if("structured_output"===t.type){const e=t.response_content?.content?.human_input_request;if(e&&"APPROVAL_REQUEST"===(e.input_type||e.inputType||"").toUpperCase()){if(t.conversation_id||t.conversationId){const e=t.conversation_id||t.conversationId;g(e);try{localStorage.setItem(r,e)}catch(e){console.warn("[AI Chat] Failed to save conversation ID to localStorage:",e)}}return}const s=t.message||t.response_content?.message,n=s?.trim();if(n&&"No content provided"!==n&&"sales_requested"!==n&&"sales_requested"!==n.toLowerCase()){if(!q.current&&n.length<150&&m(n))return console.debug("[AI Chat] Filtering greeting message:",n.substring(0,50)),void C("");C(e=>(e&&l(t=>[...t,{id:`msg-${Date.now()}-streaming`,role:"assistant",type:"assistant",content:e,timestamp:new Date}]),"")),l(e=>[...e,{id:`msg-${Date.now()}`,role:"assistant",type:"assistant",content:n,timestamp:new Date}]),j(!1),C(""),M.current&&(clearTimeout(M.current),M.current=null)}}else if("tool_result"===t.type){if(t.conversation_id||t.conversationId){const e=t.conversation_id||t.conversationId;g(e);try{localStorage.setItem(r,e)}catch(e){console.warn("[AI Chat] Failed to save conversation ID to localStorage:",e)}}}else if("message"===t.type||"complete"===t.type){let e=!1;C(t=>{if(t){const s=t.trim();if("No content provided"===s||"sales_requested"===s||"sales_requested"===s.toLowerCase())return"";if(!q.current&&t.length<150&&m(t))return console.debug("[AI Chat] Filtering greeting in complete message:",t.substring(0,50)),"";l(e=>[...e,{id:`msg-${Date.now()}`,role:"assistant",type:"assistant",content:t,timestamp:new Date}]),e=!0}return""}),e&&(j(!1),M.current&&(clearTimeout(M.current),M.current=null))}else if("handoff_request"===t.type){const e=t.message||t.response_content?.message,s=e?.trim();if(!s||"No content provided"===s||"sales_requested"===s||"sales_requested"===s.toLowerCase())return void C("");l(e=>[...e,{id:`msg-${Date.now()}`,role:"assistant",type:"assistant",content:s,timestamp:new Date}]),j(!1),C(""),M.current&&(clearTimeout(M.current),M.current=null)}else if("error"===t.type)x(t.message||t.error||(0,d.__)("An error occurred","wp-module-ai-chat")),j(!1),C("");else if(t.message||t.response_content?.message){const e=t.message||t.response_content?.message,s=e?.trim();if(!s||"No content provided"===s||"sales_requested"===s||"sales_requested"===s.toLowerCase())return void C("");if(!q.current&&s.length<150&&m(s))return console.debug("[AI Chat] Filtering greeting in generic message:",s.substring(0,50)),void C("");l(e=>[...e,{id:`msg-${Date.now()}`,role:"assistant",type:"assistant",content:s,timestamp:new Date}]),j(!1),C(""),M.current&&(clearTimeout(M.current),M.current=null)}}catch(e){console.error("[AI Chat] Error parsing WebSocket message:",e)}},i.onerror=e=>{console.error("[AI Chat] WebSocket error:",e),E.current=!1,x((0,d.__)("Connection error. Please check server status and configuration.","wp-module-ai-chat")),w(!1)},i.onclose=e=>{if(E.current=!1,f(!1),w(!1),j(!1),T.current===i&&(T.current=null),1e3!==e.code&&I.current<5){I.current++;const e=1e3*Math.pow(2,I.current-1);$.current=setTimeout(()=>{z()},e)}else I.current>=5&&x((0,d.__)("Failed to reconnect. Please refresh the page.","wp-module-ai-chat"))}}catch(e){E.current=!1,console.error("[AI Chat] Error creating WebSocket:",e),x(e.message||(0,d.__)("Failed to connect. Please check configuration and server status.","wp-module-ai-chat")),w(!1)}var e}},[W,L]);(0,u.useEffect)(()=>{U.current=i},[i]);const H=(0,u.useCallback)((e,t=null)=>{if(D.current=!1,q.current=!0,!T.current||T.current.readyState!==WebSocket.OPEN)return void x((0,d.__)("Not connected. Please wait for connection.","wp-module-ai-chat"));if(!t){const t={id:`msg-${Date.now()}`,role:"user",type:"user",content:e,timestamp:new Date};l(e=>[...e,t]),C(""),j(!0),M.current&&clearTimeout(M.current),M.current=setTimeout(()=>{j(!1),M.current=null},F)}const s={type:"chat",message:e};t?s.conversationId=t:p&&(s.conversationId=p),T.current.send(JSON.stringify(s))},[p]),K=(0,u.useCallback)(e=>{if(!T.current||T.current.readyState!==WebSocket.OPEN)return void console.warn("[AI Chat] Cannot send system message - not connected");const t={type:"chat",message:e};p&&(t.conversationId=p),j(!0),C(""),M.current&&clearTimeout(M.current),M.current=setTimeout(()=>{j(!1),M.current=null},F),T.current.send(JSON.stringify(t))},[p]),J=(0,u.useCallback)(()=>{$.current&&clearTimeout($.current),M.current&&(clearTimeout(M.current),M.current=null),T.current&&(T.current.close(1e3,"User disconnected"),T.current=null),f(!1),w(!1)},[]),G=(0,u.useCallback)(()=>{D.current=!0,j(!1),C(""),M.current&&(clearTimeout(M.current),M.current=null)},[]),B=(0,u.useCallback)(()=>{A(null)},[]),V=(0,u.useCallback)(()=>{j(!1),M.current&&(clearTimeout(M.current),M.current=null)},[]),Y=(0,u.useCallback)(e=>{let t;if(null==e)t=(0,d.__)("No content provided.","wp-module-ai-chat");else if("object"==typeof e)try{t=JSON.stringify(e,null,2)}catch(s){console.warn("[useNfdAgentsWebSocket] Failed to stringify content object:",s),t=String(e)}else t=String(e);l(e=>[...e,{id:`msg-${Date.now()}`,role:"assistant",type:"assistant",content:t,timestamp:new Date}]),j(!1),M.current&&(clearTimeout(M.current),M.current=null)},[]),X=(0,u.useCallback)((e,t)=>{l(s=>s.map(s=>("function"==typeof e?e(s):s.id===e)?t(s):s))},[]);(0,u.useEffect)(()=>{const e=k.current;if(null===e)return k.current=s,void(s&&!E.current&&(!T.current||T.current.readyState!==WebSocket.OPEN&&T.current.readyState!==WebSocket.CONNECTING)&&z());e!==s&&(k.current=s,s?E.current||T.current&&(T.current.readyState===WebSocket.OPEN||T.current.readyState===WebSocket.CONNECTING)||z():J())},[s]),(0,u.useEffect)(()=>{if(P.current){if(P.current=!1,i.length>0)try{localStorage.setItem(o,JSON.stringify(i))}catch(e){console.warn("[AI Chat] Failed to save messages to localStorage:",e)}}else try{localStorage.setItem(o,JSON.stringify(i))}catch(e){console.warn("[AI Chat] Failed to save messages to localStorage:",e)}},[i]),(0,u.useEffect)(()=>{try{p?localStorage.setItem(r,p):localStorage.removeItem(r)}catch(e){console.warn("[AI Chat] Failed to save conversation ID to localStorage:",e)}},[p]);const Z=(0,u.useCallback)(()=>{try{localStorage.removeItem(o),localStorage.removeItem(r),l([]),g(null),A(null),j(!1),C(""),x(null),O.current=null,T.current&&(T.current.close(),T.current=null,f(!1)),q.current=!1,D.current=!1,M.current&&(clearTimeout(M.current),M.current=null),$.current&&(clearTimeout($.current),$.current=null),I.current=0}catch(e){console.warn("[AI Chat] Failed to clear chat history:",e)}},[]);return{messages:i,sendMessage:H,sendSystemMessage:K,isConnected:_,isConnecting:y,error:v,isTyping:b,currentResponse:S,approvalRequest:N,conversationId:p,clearApprovalRequest:B,clearTyping:V,addAssistantMessage:Y,updateMessage:X,connect:z,disconnect:J,stopRequest:G,clearChatHistory:Z,brandId:R.current?.brand_id||null}})({configEndpoint:"/nfd-agents/chat/v1/config",storageNamespace:"help_center",autoConnect:e,consumerType:"help_center",autoLoadHistory:r}),N=((e,{speed:t=50,enabled:s=!0,loop:n=!1,loopDelay:a=1e3}={})=>{const[o,r]=(0,u.useState)(""),c=(0,u.useRef)(0),i=(0,u.useRef)(null);return(0,u.useEffect)(()=>{if(!s||!e)return r(s?"":e),void(c.current=0);i.current&&clearTimeout(i.current),r(""),c.current=0;const o=()=>{c.current<e.length?(c.current++,r(e.slice(0,c.current)),i.current=setTimeout(o,t)):n&&(i.current=setTimeout(()=>{c.current=0,r(""),i.current=setTimeout(o,t)},a))};return i.current=setTimeout(o,t),()=>{i.current&&clearTimeout(i.current)}},[e,t,s,n,a]),o})(o,{speed:80,enabled:_,loop:!0,loopDelay:500});(0,u.useEffect)(()=>{a(!!p)},[p]);const A=(0,u.useCallback)(()=>{x&&x(e=>"approval_request"===e.type&&e.approvalRequest,e=>({...e,type:"assistant",content:(0,d.__)("Action approved and executed.","wp-module-help-center"),approvalRequest:null})),w()},[w,x]),T=(0,u.useCallback)(()=>{x&&x(e=>"approval_request"===e.type&&e.approvalRequest,e=>{const t=e.approvalRequest?.tool_name||"action";return{...e,type:"assistant",content:(0,d.sprintf)(/* translators: %s: the name of the action or tool that was cancelled */ /* translators: %s: the name of the action or tool that was cancelled */
(0,d.__)('Action "%s" was cancelled.',"wp-module-help-center"),t),approvalRequest:null}}),w()},[w,x]),$=(0,u.useCallback)(()=>{window.confirm((0,d.__)("Are you sure you want to clear the chat? This will start a new conversation.","wp-module-help-center"))&&(s.current=!1,S())},[S]),I=[...c];f&&g&&I.push({id:"streaming",role:"assistant",type:"assistant",content:f,timestamp:new Date});const R=0===I.length&&!s.current;(0,u.useEffect)(()=>{I.length>0&&(s.current=!0)},[I.length]);const k=("nfd-help-center-chat nfd-ai-chat-container "+(C?`nfd-brand-${C}`:"")).trim();let E;return E=n?(0,j.jsx)("div",{className:"nfd-help-center-chat__welcome-wrapper",children:(0,j.jsx)(B.A,{hasLaunchedFromTooltip:t,query:null})}):R?(0,j.jsxs)("div",{className:"nfd-help-center-chat__welcome-wrapper",children:[(0,j.jsx)(J,{onSendMessage:i,title:(0,d.__)("Hi, I'm your AI assistant.","wp-module-help-center"),subtitle:(0,d.__)("How can I help you with WordPress today?","wp-module-help-center"),showSuggestions:!1}),(0,j.jsx)(X,{})]}):(0,j.jsxs)("div",{className:"nfd-help-center-chat__messages-wrapper",children:[c.length>0&&(0,j.jsx)("div",{className:"nfd-help-center-chat__messages-header",children:(0,j.jsx)("button",{onClick:$,className:"nfd-help-center-chat__clear-chat-button","aria-label":(0,d.__)("Clear chat","wp-module-help-center"),children:(0,d.__)("Clear Chat","wp-module-help-center")})}),(0,j.jsx)(P,{messages:I,isLoading:g,onApprove:A,onReject:T,onSendMessage:i,onSendSystemMessage:l,conversationId:y,onClearTyping:v,brandId:C})]}),(0,j.jsxs)("div",{className:k,"data-brand":C||void 0,children:[E,(0,j.jsx)("div",{className:"nfd-help-center-chat__input-area "+(c.length>0?"nfd-help-center-chat__input-area--no-border":""),children:(0,j.jsx)("div",{className:"nfd-help-center-chat__input-wrapper",children:(0,j.jsx)(W,{onSendMessage:i,onStopRequest:b,disabled:g,placeholder:(0,d.__)("Ask me anything about WordPress…","wp-module-help-center")})})}),(0,ee.$)(t)&&(0,j.jsx)("div",{className:"nfd-help-center-chat__footer-wrapper",children:(0,j.jsx)(G.A,{})}),_&&(0,j.jsx)("div",{className:"nfd-help-center-chat__connecting-overlay","aria-live":"polite","aria-busy":"true",children:(0,j.jsxs)("div",{className:"nfd-help-center-chat__connecting-content",children:[(0,j.jsx)("div",{className:"nfd-help-center-chat__connecting-spinner"}),(0,j.jsxs)("span",{className:"nfd-help-center-chat__connecting-text",children:[N,(0,j.jsx)("span",{className:"nfd-help-center-chat__connecting-cursor"})]})]})})]})}}}]);